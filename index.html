<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OpNote">
<meta name="theme-color" content="#020617">
<title>OpNote Intelligence v10.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#020617;color:#cbd5e1;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh;-webkit-tap-highlight-color:transparent}
.w{max-width:640px;margin:0 auto;padding:12px 12px 120px;padding-bottom:max(120px,calc(120px + env(safe-area-inset-bottom)))}
button,select{cursor:pointer;-webkit-appearance:none}
textarea,input,select{-webkit-appearance:none;outline:none}
.btn{padding:6px 14px;border-radius:8px;font-size:11px;font-weight:700;border:none;color:#fff;transition:all .15s;min-height:40px}
.big{width:100%;padding:14px;border-radius:12px;font-size:15px;font-weight:700;border:none;color:#fff;transition:all .15s;min-height:48px}
.card{border-radius:12px;border:1px solid #1e293b;margin-bottom:12px;overflow:hidden;background:#0c1220}
.card-h{display:flex;justify-content:space-between;align-items:center;padding:10px 14px}
.card-h .title{font-size:14px;font-weight:700;color:#f1f5f9}
.card-b{padding:14px;max-height:600px;overflow-y:auto}
.tabs{display:flex;gap:4px;margin-bottom:12px;background:#0f172a;border-radius:10px;padding:4px}
.tab{flex:1;padding:10px 0;border-radius:8px;font-size:12px;font-weight:700;border:none;color:#475569;background:transparent;transition:all .15s}
.tab.on{background:#334155;color:#fff}
.inp{width:100%;padding:10px 12px;border-radius:8px;font-size:13px;background:#020617;border:1px solid #1e293b;color:#e2e8f0}
.ta{width:100%;background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;font-size:14px;font-family:-apple-system,sans-serif;color:#e2e8f0;resize:none;line-height:1.6}
.sel{width:100%;padding:12px 14px;border-radius:10px;font-size:14px;font-weight:600;background:#0f172a;border:1px solid #1e293b;color:#e2e8f0;margin-bottom:8px}
.rec-btn{width:100%;padding:22px;border-radius:14px;font-size:18px;font-weight:800;border:none;color:#fff;display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px;transition:all .2s}
.rec-btn.idle{background:linear-gradient(135deg,#1e293b,#334155);border:2px solid #475569}
.rec-btn.recording{background:linear-gradient(135deg,#991b1b,#dc2626);border:2px solid #f87171;animation:pulse 1.5s infinite}
.rec-btn.transcribing{background:linear-gradient(135deg,#1e3a5f,#2563eb);border:2px solid #60a5fa}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.timer{font-variant-numeric:tabular-nums;font-size:16px}
.slabel{font-size:13px;font-weight:800;color:#fff;margin-top:12px;margin-bottom:3px;letter-spacing:.3px}
table{width:100%;border-collapse:collapse;font-size:12px;border-radius:6px;overflow:hidden}
th{padding:6px 10px;text-align:left;font-weight:700;color:#94a3b8;background:#0f172a;border-bottom:1px solid #1e293b}
td{padding:5px 10px;color:#cbd5e1;border-bottom:1px solid #0f172a0a}
tr:nth-child(odd) td{background:#060a14}tr:nth-child(even) td{background:#0a1020}
.ma{background:linear-gradient(135deg,#78350f,#92400e);color:#fbbf24;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;display:inline;margin:0 2px}
.mi{background:linear-gradient(135deg,#7f1d1d,#991b1b);color:#fca5a5;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;display:inline;margin:0 2px}
.md2{background:linear-gradient(135deg,#14532d,#166534);color:#86efac;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;display:inline;margin:0 2px}
.ma:hover,.mi:hover{opacity:.7;text-decoration:line-through}
.gc{background:#0f172a;border:1px solid #1e293b;border-radius:10px;margin-bottom:8px;overflow:hidden}
.gc.ck{border-color:#eab308;background:#0f1a10}
.gc.g-high{border-color:#7f1d1d;background:#450a0a20}
.gc.g-med{border-color:#92400e;background:#78350f20}
.gc.g-low{border-color:#1e3a5f;background:#1e3a5f20}
.gh{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer}
.gh input[type=checkbox]{width:20px;height:20px;accent-color:#eab308;flex-shrink:0}
.gi{font-size:10px;font-weight:800;padding:2px 8px;border-radius:4px;flex-shrink:0}
.gi.high{background:#7f1d1d;color:#fca5a5}.gi.med{background:#78350f;color:#fbbf24}.gi.low{background:#1e3a5f;color:#93c5fd}
.gt{font-size:13px;color:#cbd5e1;line-height:1.5;flex:1}
.gb{padding:4px 12px 10px 46px;font-size:12px;color:#94a3b8;line-height:1.5}
.gl{background:#020617;border:1px solid #1e293b;border-radius:6px;padding:8px 10px;margin-top:6px;font-size:12px;color:#86efac;line-height:1.4}
.gib{margin-top:8px;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700;border:none;color:#fff;background:linear-gradient(135deg,#a16207,#ca8a04)}
.qc{background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:8px}
.qt{font-size:13px;color:#cbd5e1;margin-bottom:8px}
.qi{width:100%;padding:8px 10px;border-radius:6px;font-size:12px;background:#020617;border:1px solid #1e293b;color:#86efac;margin-bottom:8px}
.fc{border-radius:10px;padding:12px;margin-bottom:8px;font-size:13px;line-height:1.5}
.fc.red{background:rgba(220,38,38,0.25);border:2px solid #ef4444;color:#fca5a5}
.fc.yellow{background:rgba(234,179,8,0.2);border:2px solid #eab308;color:#fef08a}
.fc.green{background:rgba(34,197,94,0.15);border:2px solid #22c55e;color:#86efac}
.fc .fl{font-size:10px;font-weight:800;padding:3px 8px;border-radius:4px;margin-right:6px;display:inline-block;margin-bottom:6px}
.fc.red .fl{background:#dc2626;color:#fff}.fc.yellow .fl{background:#eab308;color:#000}.fc.green .fl{background:#22c55e;color:#000}
.fin{background:linear-gradient(135deg,#0f172a,#1e293b40);border:1px solid #1e293b;border-radius:12px;padding:14px;margin-top:10px}
.fr{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1e293b40}.fr:last-child{border:none}
.fl2{font-size:12px;color:#94a3b8}.fv{font-size:14px;font-weight:700;color:#e2e8f0}
.fv.g{color:#86efac}.fv.y{color:#fde047}
.wu-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #1e293b20}
.wu-row input{width:18px;height:18px;accent-color:#06b6d4;flex-shrink:0}.wu-row span{font-size:13px;color:#cbd5e1}
.case-btn{width:100%;text-align:left;background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:8px;display:block}
.case-btn:active{background:#1e293b}
.tag{font-size:10px;padding:2px 8px;border-radius:5px;font-weight:600}
.edit-ta{width:100%;min-height:300px;background:#0f172a;border:1px solid #1e293b;border-radius:8px;padding:12px;font-size:13px;font-family:monospace;color:#e2e8f0;resize:vertical;line-height:1.6}
.err{margin-top:8px;padding:12px;background:linear-gradient(135deg,#450a0a,#7f1d1d20);border:1px solid #7f1d1d;border-radius:10px}
.err div{color:#f87171;font-size:12px;word-break:break-all}
.ld{padding:12px 0;text-align:center;font-size:13px;color:#60a5fa;font-weight:600}
.tt{font-size:11px;color:#475569;text-align:center;margin-top:6px}
.tt span{color:#60a5fa;font-weight:600}
.img-btn{padding:10px 16px;border-radius:10px;font-size:13px;font-weight:700;border:1px solid #1e293b;background:#0f172a;color:#cbd5e1;display:flex;align-items:center;gap:8px;margin-bottom:10px}
.img-btn:active{background:#1e293b}
.auth-zone{background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:10px}
.auth-zone .az-label{font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:6px;text-transform:uppercase;letter-spacing:.3px}
.auth-zone .az-ta{width:100%;background:#020617;border:1px solid #1e293b;border-radius:8px;padding:10px;font-size:12px;font-family:-apple-system,sans-serif;color:#e2e8f0;resize:vertical;line-height:1.5;min-height:60px}
.auth-zone .az-hint{font-size:10px;color:#475569;margin-top:3px}
.auth-result{border-radius:10px;padding:10px 12px;margin-bottom:6px;font-size:12px;line-height:1.5}
.auth-result.ar-green{background:rgba(34,197,94,0.1);border:1px solid #166534;color:#86efac}
.auth-result.ar-yellow{background:rgba(234,179,8,0.1);border:1px solid #92400e;color:#fef08a}
.auth-result.ar-red{background:rgba(220,38,38,0.15);border:1px solid #991b1b;color:#fca5a5}
.bv-fix{display:inline-block;background:#991b1b;color:#fca5a5;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:700;margin-left:4px}
.bv-warn{display:inline-block;background:#92400e;color:#fbbf24;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:700;margin-left:4px}
.b-conf{display:inline-block;padding:1px 7px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.3px;vertical-align:middle;margin-left:4px}
.b-conf.hi{background:#052e16;color:#4ade80;border:1px solid #16a34a}.b-conf.med{background:#422006;color:#fbbf24;border:1px solid #ca8a04}.b-conf.lo{background:#450a0a;color:#fca5a5;border:1px solid #dc2626}
.b-cpt{font-family:monospace;font-weight:800;color:#60a5fa;font-size:15px}.b-rvu{font-size:11px;color:#86efac;font-weight:600;margin-left:4px}
.b-code-row{padding:8px 10px;margin-bottom:4px;background:#0a0f1a;border-radius:8px;border:1px solid #1e293b;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:4px}
.b-code-desc{font-size:12px;color:#94a3b8;margin-top:2px;width:100%}
.mdm-row{display:flex;align-items:center;gap:8px;padding:6px 10px;margin-bottom:4px;border-radius:6px;font-size:13px}
.mdm-lbl{font-weight:700;color:#94a3b8;min-width:70px;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
.mdm-val{font-weight:700;padding:2px 10px;border-radius:4px;font-size:12px}
.mdm-val.high{background:#450a0a;color:#fca5a5;border:1px solid #dc2626}.mdm-val.moderate{background:#422006;color:#fbbf24;border:1px solid #ca8a04}.mdm-val.low{background:#0c1a2e;color:#93c5fd;border:1px solid #3b82f6}.mdm-val.minimal{background:#0f172a;color:#64748b;border:1px solid #334155}
.mdm-detail{font-size:11px;color:#64748b;margin-left:4px}
.mdm-result{padding:10px 12px;background:linear-gradient(135deg,#0c1a2e,#0f172a);border:1px solid #1e3a5f;border-radius:8px;margin-top:6px;display:flex;align-items:center;gap:10px;font-size:14px;font-weight:800;color:#60a5fa}
.mdm-arrow{color:#3b82f6;font-size:16px}
</style>
</head>
<body>
<div id="app" class="w"></div>
<script>
"use strict";
// ---- CONFIG ----
let API_KEY=localStorage.getItem("opnote-api-key")||"";
(function(){const h=window.location.hash;if(h.startsWith("#key=")){const k=decodeURIComponent(h.slice(5));if(k.startsWith("sk-ant-")){API_KEY=k;localStorage.setItem("opnote-api-key",k);window.history.replaceState(null,"",window.location.pathname);setTimeout(()=>alert("API key saved!"),500);}}})();

// ---- PIN VAULT (AES-GCM via Web Crypto) ----
const VAULT_KEY="opnote-vault";
const EMBEDDED_VAULT='{"s":"WMkwvHsRx12KwAZpL+bGqA==","i":"oeyOB+oFki0eunB5","d":"Vq5d4xIu4rRKLg5yJUcd26enPc+JKZAPLBmzo80R63OqutHDk8r0M61ba9b7ZGmbcxrMW/0/iB7wVyM59k4/tuAMjAszCN+Ws59ymLeo0I+l0gdxoUx1prXkKFYStkCsl2v019PCA/h/XkVm7YaMiwGhGh6HKEhU7MI+yAWOXbW3rZlNvc6+BpfaLxqKEE387j36KG1kjWhVQjVUaibtrylU9Zd39GbSVa8qyt1Yo9D2dEIQbqmrM+oLBxRR"}';let vaultLocked=false;
let pinErr="";

// Determine lock state: embedded vault OR localStorage vault
if(EMBEDDED_VAULT && !API_KEY){
  // Embedded vault in HTML — use it if no keys loaded yet
  try{localStorage.setItem(VAULT_KEY,EMBEDDED_VAULT);}catch(e){}
  vaultLocked=true;API_KEY="";
}else if(localStorage.getItem(VAULT_KEY) && !API_KEY){
  vaultLocked=true;API_KEY="";
}else if(localStorage.getItem(VAULT_KEY)){
  // Vault exists but keys already loaded from previous unlock
  vaultLocked=false;
}

async function deriveKey(pin,salt){
  const enc=new TextEncoder();
  const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(pin),{name:"PBKDF2"},false,["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}

async function encryptVault(pin){
  const data=JSON.stringify({ak:API_KEY,wk:state?.wk||localStorage.getItem("opnote-wkey")||"",gt:ghToken||localStorage.getItem("opnote-gh-token")||""});
  const salt=crypto.getRandomValues(new Uint8Array(16));
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(pin,salt);
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,new TextEncoder().encode(data));
  const bundle={s:btoa(String.fromCharCode(...salt)),i:btoa(String.fromCharCode(...iv)),d:btoa(String.fromCharCode(...new Uint8Array(ct)))};
  localStorage.setItem(VAULT_KEY,JSON.stringify(bundle));
}

async function decryptVault(pin){
  const bundle=JSON.parse(localStorage.getItem(VAULT_KEY));
  const salt=Uint8Array.from(atob(bundle.s),c=>c.charCodeAt(0));
  const iv=Uint8Array.from(atob(bundle.i),c=>c.charCodeAt(0));
  const ct=Uint8Array.from(atob(bundle.d),c=>c.charCodeAt(0));
  const key=await deriveKey(pin,salt);
  const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct);
  return JSON.parse(new TextDecoder().decode(pt));
}

async function unlockVault(pin){
  pinErr="";
  try{
    const keys=await decryptVault(pin);
    if(!keys.ak){
      // Vault was encrypted with empty API key
      pinErr="PIN valid but no API key in vault. Enter key in Settings → tap Update Vault.";
      vaultLocked=false;render();
      return;
    }
    API_KEY=keys.ak;localStorage.setItem("opnote-api-key",API_KEY);
    if(keys.wk){lsS("opnote-wkey",keys.wk);state.wk=keys.wk;}
    if(keys.gt){localStorage.setItem("opnote-gh-token",keys.gt);ghToken=keys.gt;}
    vaultLocked=false;render();
    setTimeout(()=>{if(ghToken)syncPull().catch(()=>{});},1000);
  }catch(e){pinErr="Wrong PIN";render();}
}

let _lastPIN=""; // remember PIN for vault updates
async function setVaultPIN(pin){
  if(pin.length<3){pinErr="PIN must be 3+ characters";render();return;}
  if(!API_KEY){pinErr="Add Anthropic API key first";render();return;}
  _lastPIN=pin;
  await encryptVault(pin);
  const blob=localStorage.getItem(VAULT_KEY);
  state._vaultBlob=blob;
  localStorage.removeItem("opnote-api-key");
  localStorage.removeItem("opnote-wkey");
  localStorage.removeItem("opnote-gh-token");
  vaultLocked=false;pinErr="";render();
}

async function updateVault(){
  if(!API_KEY){alert("Add Anthropic API key in Settings first.");return;}
  const pin=_lastPIN||prompt("Enter your current PIN to re-encrypt:");
  if(!pin)return;
  // Verify PIN works with existing vault first
  try{
    if(localStorage.getItem(VAULT_KEY)){await decryptVault(pin);}
  }catch(e){alert("Wrong PIN. Try again.");return;}
  _lastPIN=pin;
  await encryptVault(pin);
  const blob=localStorage.getItem(VAULT_KEY);
  state._vaultBlob=blob;
  localStorage.removeItem("opnote-api-key");
  localStorage.removeItem("opnote-wkey");
  localStorage.removeItem("opnote-gh-token");
  alert("Vault updated! Copy new embed code from Settings → Show Embed Code, then update GitHub.");
  render();
}

function lockVault(){
  API_KEY="";localStorage.removeItem("opnote-api-key");
  localStorage.removeItem("opnote-wkey");state.wk="";
  localStorage.removeItem("opnote-gh-token");ghToken="";
  vaultLocked=true;pinErr="";render();
}

function removeVault(){
  localStorage.removeItem(VAULT_KEY);
  vaultLocked=false;pinErr="";render();
}
const TODAY=new Date().toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"});
const SK="opnote-cases";
function ls(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}}
function lsS(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function escJs(s){return String(s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\n/g,"\\n");}

// ---- RVU TABLE (2025 Medicare PFS) ----
const RVU_TABLE={22551:20.50,22552:6.51,22845:5.21,22600:22.35,22610:22.35,22612:25.08,22614:6.00,22633:25.52,22634:6.44,22853:5.54,22854:3.92,22840:8.48,22842:11.88,22843:14.72,22844:16.20,63047:13.15,63048:3.22,63030:10.45,63035:3.22,63042:12.00,63052:14.50,63053:3.50,63056:13.50,22513:10.45,22514:10.45,63081:23.50,63082:5.50,22554:18.50,61781:5.31,61782:5.31,61783:5.31,20930:2.97,20931:3.80,20936:3.37,20937:5.50,20938:6.20,22206:30.00,22207:30.00,22210:15.00,22212:15.00,22214:15.00,22852:12.50,22855:13.00,20251:2.40,63050:15.50,63051:3.80,69990:3.00,22595:24.00,22548:18.50,99202:1.22,99203:1.82,99204:2.60,99205:3.50,99211:0.57,99212:0.93,99213:1.30,99214:1.92,99215:2.80,99252:1.55,99253:2.11,99254:3.18,99255:3.86,99291:10.00,99292:5.00};

// ---- BILLING VALIDATOR ----
function validateBilling(codes,noteText){
  const warnings=[],fixes=[];if(!codes)return{warnings,fixes,correctedRVU:null};
  const cptMatches=[...codes.matchAll(/\b(\d{5})\b/g)].map(m=>parseInt(m[1]));
  const cptSet=new Set(cptMatches);
  const noteUpper=(noteText||"").toUpperCase();
  const isSpine=noteUpper.includes("LUMBAR")||noteUpper.includes("CERVICAL")||noteUpper.includes("THORACIC")||noteUpper.includes("FUSION")||noteUpper.includes("TLIF")||noteUpper.includes("ACDF")||noteUpper.includes("LAMINECTOMY");
  // Mutual exclusivity
  if(cptSet.has(22633)&&(cptSet.has(22612)||cptSet.has(22853)))fixes.push({msg:"MUTUAL EXCLUSIVITY: 22633 (combined) and 22612+22853 (separate) cannot both appear."});
  // Navigation
  if(cptSet.has(61782)&&isSpine)fixes.push({msg:"NAVIGATION: 61782 is cranial only. Use 61783 for spine."});
  // Duplicates
  const nonAddOn=new Set([22551,22612,22600,22610,22633,63047,63030,22513,22514,22840,22842,22843,22844,61783,20930,20931,20936,69990]);
  const counts={};cptMatches.forEach(c=>{counts[c]=(counts[c]||0)+1;});
  Object.entries(counts).forEach(([c,n])=>{if(n>1&&nonAddOn.has(parseInt(c)))fixes.push({msg:"DUPLICATE: "+c+" appears "+n+"x but is not a per-level add-on."});});
  // Graft sanity
  if(cptSet.has(20931)){const noteLow=(noteText||"").toLowerCase();if(noteLow.includes("morselized")||noteLow.includes("chips")||noteLow.includes("dbm"))fixes.push({msg:"GRAFT: 20931 (structural) but note says morselized/chips/DBM. Should be 20930."});}
  // Microscope
  if(cptSet.has(69990)&&!(noteText||"").match(/microscop/i))warnings.push({msg:"69990 (microscope) billed but microscope use not documented."});
  // PSO + decompression
  if((cptSet.has(22206)||cptSet.has(22207))&&(cptSet.has(63047)||cptSet.has(63048)))warnings.push({msg:"PSO performed — decompression should be 63052/63053, NOT 63047/63048."});
  // Multiple instrumentation
  const instrCodes=[22840,22842,22843,22844].filter(c=>cptSet.has(c));
  if(instrCodes.length>1)fixes.push({msg:"MULTIPLE INSTRUMENTATION: "+instrCodes.join(", ")+" — only one tier allowed."});
  // Bundling
  if(cptSet.has(63047)&&cptSet.has(63030))warnings.push({msg:"63047+63030 bundling — verify separate levels."});
  // RVU correction
  let correctedRVU=0;
  cptMatches.forEach(c=>{const rvu=RVU_TABLE[c];if(rvu){const line=codes.split("\n").find(l=>l.includes(String(c)));const multMatch=line?.match(/x\s*(\d+)/i);const mult=multMatch?parseInt(multMatch[1]):1;correctedRVU+=rvu*mult;}});
  // E/M MDM FLOOR CHECK — if note recommends surgery, minimum is 99204/99214
  const noteLC=(noteText||"").toLowerCase();
  const recommendsSurgery=noteLC.includes("recommend")&&(noteLC.includes("surgery")||noteLC.includes("fusion")||noteLC.includes("discectomy")||noteLC.includes("laminectomy")||noteLC.includes("microdiscectomy")||noteLC.includes("kyphoplasty")||noteLC.includes("craniotomy")||noteLC.includes("decompression")||noteLC.includes("acdf")||noteLC.includes("tlif"));
  if(recommendsSurgery){
    const emCode=cptMatches.find(c=>c>=99200&&c<=99499);
    if(emCode){
      const lowCodes=[99202,99203,99211,99212,99213,99252,99253];
      if(lowCodes.includes(emCode)){
        fixes.push({msg:"E/M UNDERCODE: "+emCode+" but note recommends surgery → Risk=HIGH → minimum 99204/99214/99254. Decision for major surgery = HIGH risk by definition."});
      }
    }
  }

  return{warnings,fixes,correctedRVU:correctedRVU||null};
}

// ---- AUTH MODULE ----
let policyEngine=null;
let authState={payer:"",procedure:"",mriText:"",medsText:"",ptText:"",labsText:"",priorText:"",results:null,letter:"",phase:"",err:null};
const AUTH_PAYERS=[{id:"cigna",name:"Cigna",color:"#2563eb"},{id:"aetna",name:"Aetna",color:"#7c3aed"},{id:"uhc",name:"UHC",color:"#059669"},{id:"other",name:"Other (Conservative)",color:"#475569"}];
const AUTH_PROCEDURES=[{id:"acdf_1_level",name:"ACDF 1-Level"},{id:"acdf_2_level",name:"ACDF 2-Level"},{id:"acdf_3_level",name:"ACDF 3-Level"},{id:"tlif_1_level",name:"TLIF 1-Level"},{id:"tlif_2_level",name:"TLIF 2-Level"},{id:"lumbar_laminectomy",name:"Lumbar Laminectomy"},{id:"lumbar_microdiscectomy",name:"Microdiscectomy"},{id:"kyphoplasty",name:"Kyphoplasty"},{id:"posterior_cervical_fusion",name:"Post. Cervical Fusion/Decompression"}];

async function loadPolicyEngine(){
  if(policyEngine)return policyEngine;
  policyEngine={"metadata": {"version": "2.0.0", "created": "2026-02-13", "last_updated": "2026-02-13", "description": "Complete payer policy decision engine for prior authorization automation", "sources": {"cigna": {"lumbar_fusion": "CMM-609 V2.0.2025, Effective 12/18/2025", "lumbar_decompression": "CMM-608 V1.0.2025, Effective 07/01/2025", "lumbar_microdiscectomy": "CMM-606 V1.0.2025, Effective 07/01/2025", "acdf": "CMM-601 V1.0.2024, Effective 11/01/2024", "kyphoplasty": "CMM-607 V1.0.2025, Effective 07/01/2025", "grafts": "CMM-612", "preface": "CMM-600 V2.0.2025", "posterior_cervical_decompression": "CMM-603 V1.0.2025, Effective 07/01/2025", "posterior_cervical_fusion": "CMM-604 V1.0.2024, Effective 11/01/2024"}, "aetna": {"spine_surgery": "CPB 0743 - Last Review 12/23/2025", "kyphoplasty": "CPB 0016 - Back Pain: Invasive Procedures"}, "uhc": {"spine": "Policy 2026T0639H, Effective 01/01/2026 (defers to InterQual)", "kyphoplasty": "Percutaneous Vertebroplasty and Kyphoplasty Policy"}}, "procedures_covered": ["tlif_1_level", "tlif_2_level", "acdf_1_level", "acdf_2_level", "acdf_3_level", "lumbar_microdiscectomy", "lumbar_laminectomy", "kyphoplasty", "posterior_cervical_fusion"]}, "global_rules": {"cigna": {"payer_name": "Cigna Healthcare", "guideline_manager": "eviCore by Evernorth", "submission": "eviCore portal or (800) 918-8924", "nicotine": {"applies_to": "ALL fusions", "requirement": "Never-smoker attestation OR cotinine <=10 ng/mL within 6 weeks of surgery", "lab_type": "blood cotinine", "waived_for": ["myelopathy", "cauda_equina", "trauma", "infection", "neoplasm", "incapacitating_pain"]}, "mental_health": {"applies_to": "ALL fusions and decompressions (non-urgent)", "requirement": "Absence of untreated underlying mental/behavioral health disorders", "waived_for": ["urgent_emergent_conditions"]}, "urgent_emergent_bypass": {"description": "Bypasses conservative tx, smoking, mental health, repeat timing", "conditions": ["Cauda equina syndrome", "Motor weakness grade 3/5 or less", "Rapidly progressive motor loss", "Bowel/bladder incontinence or retention", "Progressive neurological deficit on 2 separate exams", "Epidural hematoma", "Infection (discitis, epidural abscess, osteomyelitis)", "Primary/metastatic neoplasm with fracture/compression/instability", "Traumatic fractures/dislocations with instability", "Myelopathy or cord signal changes on MRI", "Severe debilitating pain to point of incapacitation"], "still_required": "Imaging findings"}}, "aetna": {"payer_name": "Aetna", "guideline_id": "CPB 0743 + CPB 0016", "submission": "Aetna precertification portal", "precert_form": "PCFX Spinal Surgery Precertification Form", "nicotine": {"applies_to": "ALL spinal fusions", "requirement": "Nicotine-free >=6 weeks, lab required if nicotine use within past year", "lab_type": "blood or urine cotinine <=10 ng/mL within 6 weeks", "no_never_smoker_attestation": true, "waived_for": ["myelopathy", "cauda_equina", "severe_weakness_MRC_4_minus", "progressive_weakness", "infection", "tumor", "fracture"]}, "imaging_rules": {"stenosis_minimum": "moderate (mild/mild-to-moderate = denial)", "accepted_terms": ["compression"], "rejected_terms": ["mass effect", "impingement", "abutment", "effacement", "indentation", "flattening", "displacement"], "radiologist_report_required": true, "surgeon_disagreement_protocol": "Surgeon must discuss with radiologist and obtain written addendum"}, "conservative_tx_waiver": {"conditions": ["Spinal cord compression", "Cauda equina syndrome", "Myelopathy (cervical/thoracic only)", "Severe weakness MRC grade 4- or less", "Progressive neurological deficit on serial exams by same surgeon", "Severe stenosis + instability when fusion requested", "PT discharge note documenting inability to tolerate treatment (UNIQUE to Aetna)"]}, "pt_rules": {"must_be": "In-person formal PT (NOT home, virtual, or chiro alone)", "documentation": "PT notes OR member claims history", "required_documents": ["Initial PT eval", "Final PT visit", "Discharge note from licensed PT"]}, "implant_documentation": {"required_for": "ALL instrumented fusions", "must_include": ["manufacturer_name", "device_set_name"]}}, "uhc": {"payer_name": "UnitedHealthcare", "policy_number": "2026T0639H", "CRITICAL": "Defers ALL medical necessity to InterQual (proprietary, not publicly available)", "approximate_criteria_note": "Criteria below are APPROXIMATE based on policy definitions and general InterQual principles", "definitions": {"disabling_symptoms": "ODI >8, OR SF-36 Bodily Pain <70, OR SF-36 Physical Function <78", "clinically_significant_spondylolisthesis": ">=3mm sagittal displacement on flex-ext OR >11 degrees relative angulation", "radicular_pain_supporting_findings": ["positive_nerve_root_tension_sign", "reflex_change", "sensory_deficit_dermatomal", "motor_deficit_myotomal"]}}}, "procedures": {"tlif_1_level": {"description": "Transforaminal Lumbar Interbody Fusion - Single Level", "cpt_codes": {"primary": ["22630"], "alternative_approaches": ["22612", "22633"], "decompression": ["63047"], "interbody_device": ["22853"], "instrumentation": ["22840", "22842"]}, "cigna": {"guideline": "CMM-609", "pathways": {"with_decompression_instability": {"section": "CMM-609.4.1", "description": "Fusion + decompression for actual instability", "prerequisite": "Must meet CMM-608 decompression criteria", "criteria_ALL": ["Patient meets lumbar decompression criteria (CMM-608)", "Imaging shows instability"], "instability_imaging_ANY": ["Degenerative spondylolisthesis: dynamic instability >3mm on flex-ext OR Meyerding Grade II+", "Isthmic spondylolisthesis: Grade I-II with progression, Grade III+ with >=50% slip, multi-level spondylolysis", "Post-operative instability: facet excision >50% bilateral or >=75% single facet", "Pars fracture", "Prior decompression with iatrogenic spondylolisthesis"], "conservative_tx": "NOT required when instability present with decompression indication", "nicotine": "required", "mental_health": "required (unless urgent)", "documentation": ["MRI or CT lumbar", "Flexion-extension X-rays or supine vs upright", "Cotinine lab", "Documentation of decompression candidacy per CMM-608"]}, "with_decompression_anticipated_iatrogenic": {"section": "CMM-609.4.2", "description": "Fusion + decompression for anticipated iatrogenic instability", "criteria_ANY": ["Facet excision >50% bilaterally or >=75% single facet during decompression", "Removal of pars interarticularis", "Decompression for Grade I+ spondylolisthesis with foraminal stenosis", "Complete or partial corpectomy (>=1/3 vertebral body)"], "conservative_tx": "NOT required", "nicotine": "required", "documentation": ["Advanced imaging", "Surgical plan documenting anticipated instability", "Cotinine lab"]}, "without_decompression_spondylolisthesis": {"section": "CMM-609.5.1-5.2", "description": "Standalone fusion for spondylolisthesis", "instability_imaging": "Same as 609.4 criteria", "symptoms": "Significant daily pain with functional impairment", "conservative_tx": {"duration": "3 months", "requirement": "EITHER meds OR provider-directed exercise", "modalities": ["Rx analgesics/steroids/gabapentinoids/NSAIDs", "Provider-directed exercise (PT/chiro/DO/MD)"]}, "nicotine": "required", "mental_health": "required", "documentation": ["Flex-ext X-rays or supine vs upright", "MRI or CT", "3-month medication or PT records", "Functional impairment documentation", "Mental health screening", "Cotinine lab"]}, "without_decompression_DDD_single_level": {"section": "CMM-609.5.3", "description": "STRICTEST PATHWAY - standalone fusion for single-level DDD without instability", "ALERT": "This pathway has highest denial rate. Always check for ANY spondylolisthesis to reroute to easier pathway.", "symptom_duration": "12 months chronic unremitting discogenic axial LBP", "symptoms": "Significant daily pain with functional impairment", "imaging": "Plain X-rays AND CT/MRI showing moderate-severe SINGLE-LEVEL disc degeneration", "conservative_tx": {"duration": "12 months structured physician-supervised multi-modal program", "structure": "Regularly scheduled appointments with follow-up evaluation", "must_fail_2_of_4": [{"modality": "Rx analgesics/steroids/gabapentinoids/NSAIDs", "duration": "12 consecutive months"}, {"modality": "Provider-directed exercise program", "duration": "12 consecutive months"}, {"modality": "Epidural steroid injection(s) or selective nerve root block(s)", "duration": "no specific duration"}, {"modality": "Facet joint injection(s)/MBB(s)/RFA(s)", "duration": "no specific duration"}]}, "nicotine": "required", "mental_health": "required", "documentation": ["MRI showing single-level DDD", "Plain X-rays", "12-month symptom history", "Medication records 12 months", "PT records 12 months", "Injection records if applicable", "Structured management plan", "Regular appointment records", "Functional impairment documentation", "Mental health screening", "Cotinine lab"]}, "deformity": {"section": "CMM-609.4.3 / 609.5.4", "description": "Adult degenerative spinal deformity", "imaging_EITHER": {"coronal_ANY": ["Cobb angle >30 degrees", "Asymmetric disc collapse with symptomatic foraminal narrowing", "Coronal imbalance with head/trunk shift"], "sagittal_ANY": ["SVA >8cm", "PI-LL >15 degrees"]}, "conservative_tx": "3 months EITHER meds OR exercise (if without decompression)", "nicotine": "required"}}, "routing_logic": {"CRITICAL_DECISION": "Does patient have ANY spondylolisthesis?", "if_yes_with_decompression": "Route to 609.4.1 (NO conservative tx required)", "if_yes_without_decompression": "Route to 609.5.1/5.2 (3 months, 1 modality)", "if_no_DDD_only": "Route to 609.5.3 (12 months, 2 of 4 modalities - HARDEST)", "if_deformity": "Route to deformity pathway (3 months)", "STRATEGY": "Grade 1 anterolisthesis on flex-ext changes EVERYTHING"}}, "aetna": {"guideline": "CPB 0743 Section I.I", "CRITICAL": "Aetna does NOT cover standalone DDD fusion - experimental/investigational", "pathways": {"spondylolisthesis_with_instability": {"section": "I.I.8", "criteria": {"symptoms": "Symptomatic unremitting LBP, radiculopathy, OR neurogenic claudication", "imaging_EITHER": ["Grade II+ spondylolisthesis (>=25% slip)", "Dynamic instability: >=4mm translation OR >=10 degrees angular motion"], "conservative_tx": {"duration": "6 weeks", "must_include_ALL": ["Patient education", "In-person PT for full 6 weeks", "Medications (NSAIDs/acetaminophen/TCAs)", "Address anxiety/depression where appropriate"]}}, "KEY_DIFFERENCE": "Aetna threshold is 4mm (vs Cigna 3mm). Translation 3.0-3.9mm passes Cigna but FAILS Aetna."}, "stenosis_with_instability": {"section": "I.I.9", "description": "EASIEST Aetna pathway - decompression + any spondylolisthesis", "criteria_ALL": ["Meets lumbar decompression criteria (Section I.C/D/E)", "ANY of: segmental instability on flex-ext, ANY grade spondylolisthesis (I+), iatrogenic instability from decompression, revision decompression creating instability"], "KEY_INSIGHT": "Grade I spondy + stenosis requiring decompression = fusion approved with only 6 weeks conservative", "conservative_tx": "Per decompression criteria (6 weeks)"}, "scoliosis": {"section": "I.I.1", "criteria": "Cobb >50 degrees + functional impairment in skeletally mature adults", "conservative_tx": "3 months"}, "flatback_syndrome": {"section": "I.I.3", "criteria_ALL": ["Back pain + stooped posture + limitation forward gaze", "SVA >5cm OR pelvic tilt >20 OR LL-PI mismatch >=10"], "conservative_tx": "3 months"}, "pseudoarthrosis": {"section": "I.I.2", "criteria": "Absent bridging bone or motion at fusion site, >=12 months since fusion (or hardware failure)", "nicotine": "required unless hardware failure or urgent"}, "fracture_dislocation": {"section": "I.I.4", "criteria": "Instability or neural compromise on imaging", "conservative_tx": "NOT required"}, "DDD_standalone": {"status": "EXPERIMENTAL / NOT COVERED", "action": "Must find instability or decompression indication to route to covered pathway"}}, "documentation_required": ["Physical exam including neurologic exam by operating surgeon", "Official radiologist report of CT/MRI (within 1 year or after symptom onset)", "Stenosis grading >= moderate", "PT notes (initial + final + discharge from licensed PT)", "Nicotine status with quit date and negative lab", "Implant manufacturer and device name", "All other pain sources ruled out"], "routing_logic": {"CRITICAL_DECISION": "Can you frame this as decompression + fusion?", "if_any_spondy_plus_stenosis": "Route to I.I.9 (easiest - 6 weeks conservative)", "if_spondy_without_stenosis": "Route to I.I.8 (need Grade II+ or 4mm dynamic)", "if_DDD_no_instability": "DENIAL - not covered by Aetna. Look harder for instability."}}, "uhc": {"guideline": "2026T0639H (defers to InterQual)", "approximate_criteria": {"imaging": "Advanced imaging showing pathology correlating with symptoms", "conservative_tx": "Approximately 6-12 weeks depending on indication", "likely_covered": ["Spondylolisthesis with instability (flex-ext >=3mm or Grade II+)", "Stenosis with instability requiring decompression + fusion", "Post-decompression instability", "Pseudoarthrosis/hardware failure", "Fracture/dislocation", "Infection/tumor"], "instability_threshold": ">=3mm sagittal displacement OR >11 degrees angulation"}}}, "tlif_2_level": {"description": "Transforaminal Lumbar Interbody Fusion - Two Level", "cpt_codes": {"primary": ["22633", "22634"], "alternative": ["22612", "22614"], "decompression": ["63047", "63048"], "interbody_device": ["22853", "22854"], "instrumentation": ["22842", "22843"]}, "note": "Same clinical criteria as single-level TLIF for each level. Additional requirements below.", "cigna": {"guideline": "CMM-609", "additional_rules": {"each_level_must_independently_meet_criteria": true, "DDD_pathway_NOT_available": "CMM-609.5.3 only covers SINGLE-LEVEL DDD. Multi-level DDD without instability is a NON-INDICATION.", "multi_level_covered_for": ["Instability at each level (different pathways allowed per level)", "Deformity (scoliosis/sagittal imbalance - inherently multi-level)", "Adjacent segment disease (CMM-609.6 - prior fusion >=6 months ago at adjacent level)"], "STRATEGY": "For 2-level, each level needs its own justification. Best: instability or decompression indication at both levels."}}, "aetna": {"guideline": "CPB 0743", "additional_rules": {"each_level_must_independently_meet_criteria": true, "multi_level_DDD": "NOT COVERED (experimental for any number of DDD levels)", "multi_level_covered_for": ["Spondylolisthesis with instability at each level", "Stenosis requiring decompression with instability at each level", "Scoliosis/deformity (inherently multi-level)", "Adjacent segment disease"], "documentation": "Each level requires separate justification with corresponding imaging findings"}}, "uhc": {"guideline": "2026T0639H", "note": "InterQual criteria apply per level. Each level must independently qualify.", "explicitly_not_covered": "Staged multiple sessions when one session can address all sites"}}, "acdf_1_level": {"description": "Anterior Cervical Discectomy and Fusion - Single Level", "cpt_codes": {"primary": ["22551"], "discectomy": ["63075"], "instrumentation": ["22845"], "interbody_device": ["22853"]}, "cigna": {"guideline": "CMM-601", "pathways": {"radiculopathy": {"section": "CMM-601.4", "criteria_ALL": ["Significant daily pain with functional impairment", "Unremitting radicular pain to shoulder girdle/upper extremity", "Objective exam finding (ANY): dermatomal sensory deficit, motor deficit (biceps/triceps weakness), reflex changes, shoulder abduction relief sign, Spurling's test, OR unremitting radicular pain without concordant objective findings", "Failed at least 2 of 3 conservative modalities for 6 weeks", "Plain X-rays of cervical spine performed", "MRI/CT shows neural compression at requested level concordant with symptoms", "Mental health screening", "Nicotine: never-smoker OR cotinine <=10 within 6 weeks"], "conservative_tx_fail_2_of_3": ["Rx analgesics/steroids/gabapentinoids/NSAIDs x 6 weeks", "Provider-directed exercise (PT/chiro/physician) x 6 weeks", "ESI or selective nerve root block at SAME level"], "imaging_causes": ["Herniated disc(s)", "Synovial/arachnoid cyst", "Central/lateral/foraminal stenosis", "Osteophytes"]}, "myelopathy": {"section": "CMM-601.4", "FASTEST_PATHWAY": true, "description": "Myelopathy bypasses conservative tx, nicotine, and mental health", "symptoms_ANY": ["Upper/lower extremity weakness, numbness, or pain", "Fine motor dysfunction (buttoning, handwriting, clumsiness)", "Gait disturbance", "New-onset bowel or bladder dysfunction", "Frequent falls"], "exam_findings_ANY": ["Grip and release test abnormal", "Ataxic gait", "Hyperreflexia", "Hoffmann sign", "Babinski sign", "Tandem walking test with ataxia", "Inverted brachial radial reflex", "Increased muscle tone or spasticity", "Clonus", "Myelopathic hand"], "imaging": "MRI/CT shows cervical cord compression OR cervical stenosis concordant with symptoms", "conservative_tx": "NOT required", "nicotine": "NOT required", "mental_health": "NOT required"}}, "routing_logic": {"STRATEGY": "If patient has ANY myelopathy signs, use myelopathy pathway - no conservative tx, no nicotine, no mental health. Even subtle Hoffmann sign or hyperreflexia qualifies."}}, "aetna": {"guideline": "CPB 0743 Section I.G", "pathways": {"radiculopathy_or_stenosis_with_compression": {"criteria_ALL": ["All other reasonable sources ruled out", "Signs/symptoms of neural compression (radiculopathy, neurogenic claudication, or myelopathy)", "Imaging: central/lateral recess/foraminal stenosis >=moderate OR nerve root/cord compression", "Imaging read by radiologist using 'compression' language", "Failed 6 weeks conservative (education + in-person PT + meds + address anxiety/depression)", "ADLs limited by neural compression symptoms"]}, "myelopathy": {"description": "Bypasses conservative tx requirement", "criteria": "Cervical cord compression on imaging + myelopathy signs/symptoms", "conservative_tx": "WAIVED", "nicotine": "WAIVED"}, "sub_axial_instability": {"section": "I.G.8", "criteria_ALL": ["Sagittal translation >=3mm on flex-ext views OR relative sagittal angulation >11 degrees", "Symptomatic unremitting pain"], "conservative_tx": "3 MONTHS (longer than standard 6 weeks)"}, "kyphosis_with_cord_compression": {"section": "I.G.1", "criteria": "Cervical kyphosis + cord compression on imaging", "conservative_tx": "NOT required"}}, "documentation_required": ["Physical/neurologic exam by operating surgeon", "Official radiologist report with 'compression' language", "Stenosis grading >=moderate", "PT initial + final + discharge notes (for non-myelopathy)", "Nicotine lab (for non-myelopathy fusions)", "Implant manufacturer and device name"]}, "uhc": {"guideline": "2026T0639H", "approximate_criteria": {"radiculopathy": "Imaging correlation + failed conservative tx (approx 6-12 weeks)", "myelopathy": "Likely waives conservative tx similar to other payers", "instability": ">=3mm displacement or >11 degrees angulation"}}}, "acdf_2_level": {"description": "Anterior Cervical Discectomy and Fusion - Two Level", "cpt_codes": {"primary": ["22551", "22552"], "discectomy": ["63075", "63076"], "instrumentation": ["22845"], "interbody_device": ["22853", "22854"]}, "note": "Same criteria as single-level ACDF. Each level must independently meet criteria.", "cigna": {"guideline": "CMM-601", "rules": "Each level must independently show neural compression concordant with symptoms. Both levels can use same pathway (e.g., radiculopathy at both) or different pathways (radiculopathy at one, myelopathy contribution at another).", "documentation": "MRI must show pathology at BOTH levels with clinical correlation to BOTH"}, "aetna": {"guideline": "CPB 0743", "rules": "Each level requires imaging showing >=moderate stenosis or compression. Both levels must be addressed in the clinical justification.", "cage_spacer_note": "Multi-level (3+) discectomy is one of the specific indications for cage/spacer use per CPB 0016. 2-level may not automatically qualify for cage."}, "uhc": {"guideline": "2026T0639H", "note": "Each level requires independent clinical justification per InterQual"}}, "acdf_3_level": {"description": "Anterior Cervical Discectomy and Fusion - Three Level", "cpt_codes": {"primary": ["22551", "22552", "22552"], "discectomy": ["63075", "63076", "63076"], "instrumentation": ["22845"], "interbody_device": ["22853", "22854", "22854"]}, "cigna": {"guideline": "CMM-601", "rules": "Each level must independently meet criteria. 3-level increases scrutiny. Myelopathy pathway strongest for multi-level.", "STRATEGY": "Multi-level cervical stenosis with myelopathy is the strongest justification for 3-level ACDF - document myelopathy signs thoroughly."}, "aetna": {"guideline": "CPB 0743", "rules": "Each level requires independent justification", "cage_spacer_note": "3+ level discectomy meeting criteria IS a specific indication for cage/spacer use per CPB 0016 Section cervical cages", "laminoplasty_alternative": {"consider_if": ">=2 levels with myelopathy, >=moderate stenosis, no kyphosis, no instability >3mm", "section": "I.L", "advantage": "May be preferred by some surgeons for multi-level myelopathy"}}, "uhc": {"guideline": "2026T0639H", "note": "Higher scrutiny for 3-level. Each level requires independent InterQual criteria."}}, "lumbar_microdiscectomy": {"description": "Lumbar Microdiscectomy / Laminotomy / Hemilaminectomy for disc herniation", "cpt_codes": {"primary": ["63030"], "additional_level": ["63035"], "endoscopic": ["62380"]}, "cigna": {"guideline": "CMM-606", "pathways": {"radiculopathy": {"section": "CMM-606.2B", "criteria_ALL": ["Significant daily pain with functional impairment", "Persistent radiating pain into buttock(s)/lower extremity", "Objective exam: nerve root tension sign (SLR, crossed SLR, femoral stretch) OR neurologic deficit (dermatomal sensory deficit, motor weakness, reflex changes)", "Failed 2 of 3 conservative modalities x 6 weeks", "MRI/CT shows neural compression concordant at requested level", "Behavioral health screening"], "conservative_tx_fail_2_of_3": ["Rx analgesics/steroids/gabapentinoids/NSAIDs x 6 weeks", "Provider-directed exercise (PT/chiro/DO/MD) x 6 weeks", "ESI or selective nerve root block at SAME level"]}, "neurogenic_claudication": {"section": "CMM-606.2A", "criteria_ALL": ["Significant daily pain with functional impairment", "Pain/cramping/weakness/tingling in back/buttock(s)/leg(s) from walking or positions causing compression", "Symptoms worsen with standing/walking AND/OR improve with sitting/forward flexion", "Physical exam concordant with MRI/CT", "Failed 2 of 3 conservative modalities x 6 weeks", "MRI/CT shows neural compression concordant", "Behavioral health screening"]}, "repeat_same_level": {"section": "CMM-606.3", "additional_criteria": [">12 weeks since prior microdiscectomy", "POST-OPERATIVE MRI/CT showing recurrent compression", "Same clinical criteria as initial plus post-op imaging"]}}, "non_indications": ["Annular tears alone", "DDD standalone", "Concordant discography alone", "Laser discectomy"], "nicotine": "NOT required (decompression only, no fusion)", "note": "CMM-606 criteria are IDENTICAL to CMM-608 clinically. System validates once, applies to both."}, "aetna": {"guideline": "CPB 0743 Section I.C", "criteria_ALL": ["All other reasonable sources ruled out", "Signs/symptoms of neural compression (radiculopathy, neurogenic claudication, or myelopathy)", "Imaging: central/lateral recess/foraminal stenosis >=moderate OR nerve root compression", "Failed 6 weeks conservative (education + in-person PT + meds + address anxiety/depression)", "ADLs limited by neural compression"], "nicotine": "NOT required (decompression only)", "stenosis_minimum": "moderate"}, "uhc": {"guideline": "2026T0639H", "approximate_criteria": "Imaging correlation + failed conservative tx ~6 weeks"}}, "lumbar_laminectomy": {"description": "Lumbar Laminectomy / Decompression for stenosis (without fusion)", "cpt_codes": {"primary": ["63005", "63047"], "additional_level": ["63048"], "spondylolisthesis": ["63012"], "multi_level": ["63017"], "re_exploration": ["63042", "63044"]}, "cigna": {"guideline": "CMM-608", "pathways": {"radiculopathy": {"section": "CMM-608.2B", "criteria": "IDENTICAL to CMM-606.2B (microdiscectomy radiculopathy)", "conservative_tx_fail_2_of_3_x_6_weeks": true}, "neurogenic_claudication": {"section": "CMM-608.2A", "criteria": "IDENTICAL to CMM-606.2A (microdiscectomy claudication)", "conservative_tx_fail_2_of_3_x_6_weeks": true}, "repeat_decompression": {"section": "CMM-608.3", "additional": ">12 weeks since prior decompression, post-op imaging required"}}, "nicotine": "NOT required (no fusion)", "mental_health": "required", "CRITICAL_NOTE": "If laminectomy will create instability (>50% bilateral facetectomy or >=75% single facet), convert to fusion case (CMM-609.4.2 pathway - no additional conservative tx needed)"}, "aetna": {"guideline": "CPB 0743 Sections I.C, I.D, I.E", "pathways": {"herniated_disc": {"section": "I.C", "criteria": "Same as microdiscectomy criteria"}, "spinal_stenosis": {"section": "I.D.6", "criteria_ALL": ["Stenosis >=moderate on imaging", "Unremitting pain", "Neurological findings", "Failed 6 weeks conservative (or waiver)"]}, "specific_conditions_no_conservative": {"section": "I.D", "conditions": ["Fracture with displaced fragments causing >=moderate stenosis", "Spinal infection", "Spinal tumor", "Epidural hematoma"]}, "rapid_neurological_deterioration": {"section": "I.E", "criteria": "Foot drop, extremity weakness, saddle anesthesia, bowel/bladder dysfunction + >=moderate stenosis", "conservative_tx": "NOT required"}}, "nicotine": "NOT required (no fusion)", "stenosis_minimum": "moderate"}, "uhc": {"guideline": "2026T0639H", "approximate_criteria": "Imaging correlation with >=moderate stenosis + failed conservative tx ~6 weeks"}}, "kyphoplasty": {"description": "Balloon Kyphoplasty / Percutaneous Vertebroplasty for vertebral compression fractures", "cpt_codes": {"vertebroplasty_cervicothoracic": ["22510"], "vertebroplasty_lumbosacral": ["22511"], "vertebroplasty_additional": ["22512"], "kyphoplasty_thoracic": ["22513"], "kyphoplasty_lumbar": ["22514"], "kyphoplasty_additional": ["22515"], "sacroplasty_unilateral_NOT_COVERED_CIGNA": ["0200T"], "sacroplasty_bilateral_NOT_COVERED_CIGNA": ["0201T"]}, "billing_note": "All VP/KP codes include bone biopsy and imaging guidance \u2014 do NOT bill imaging separately", "note": "SEPARATE policy from fusion/decompression guidelines", "cigna": {"guideline": "CMM-607 V1.0.2025", "effective_date": "2025-07-01", "guideline_status": "FULLY DECOMPOSED", "spinal_region_limit": "T5-L5 ONLY (cervical and T1-T4 NOT covered)", "level_limit_non_malignant": "Maximum 2 levels per session", "level_limit_malignant": "No explicit limit (case-by-case)", "nicotine": "NOT required", "mental_health": "NOT required", "urgent_emergent": {"bypass_conservative_tx": true, "conditions_EITHER": ["Primary or metastatic neoplastic disease causing pathologic fracture", "Condition meeting procedure criteria with severe debilitating/crippling pain to point of incapacitation"], "still_required": "Imaging findings from applicable procedure section"}, "pathways": {"prophylactic_with_fusion": {"section": "CMM-607.2 Category A", "description": "Prophylactic vertebroplasty to facilitate fusion surgery (prevent junctional fractures)", "criteria": "Performed as prophylactic VP including adjacent vertebrae if needed", "level_limit": "Maximum 2 levels T5-L5 on same date of service", "conservative_tx": "NOT required (part of fusion case)"}, "malignant_conditions": {"section": "CMM-607.2 Category B", "criteria_ALL": ["Imaging concordant with symptoms and exam showing: osteolytic metastases (including myeloma) OR primary malignant neoplasm of bone/marrow", "Significant daily pain with clinically significant functional impairment"], "conservative_tx": "NOT explicitly required (urgent/emergent typically applies)", "level_limit": "Not specified for malignant (case-by-case)"}, "non_malignant_acute": {"section": "CMM-607.2 Category C \u2014 Acute Pathway", "timing": "0-6 weeks from fracture", "criteria_ALL": ["Imaging concordant with symptoms/exam showing ANY of: osteoporotic VCF, osteolytic VCF, aggressive hemangioma/eosinophilic granuloma, Kummel disease, steroid-induced VCF", "Maximum 2 levels T5-L5", "Significant daily pain with functional impairment", "Axial pain in thoracic/lumbar spine that PREVENTS INDEPENDENT TRANSFERS AND/OR AMBULATION", "Pain correlates with fracture level"], "conservative_tx": "NOT required if pain prevents transfers/ambulation", "KEY_THRESHOLD": "Patient must be unable to independently transfer or ambulate. If they can still walk, route to subacute pathway.", "osteoporosis_program": "Required if osteoporotic VCF \u2014 must be enrolled in osteoporosis treatment and prevention program"}, "non_malignant_subacute": {"section": "CMM-607.2 Category C \u2014 Subacute Pathway", "timing": ">6 weeks from fracture", "criteria_ALL": ["Imaging concordant with symptoms/exam showing ANY of: osteoporotic VCF, osteolytic VCF, aggressive hemangioma/eosinophilic granuloma, Kummel disease, steroid-induced VCF", "Maximum 2 levels T5-L5", "Significant daily pain with functional impairment", "Less than clinically meaningful improvement despite conservative treatment"], "conservative_tx": {"must_fail_BOTH": ["Rx analgesics, steroids, and/or NSAIDs \u00d7 4 weeks", "Provider-directed exercise program (PT/chiro/DO/MD) \u00d7 4 weeks"], "exception": "Unless contraindicated"}, "osteoporosis_program": "Required if osteoporotic VCF"}}, "non_indications_not_medically_necessary": {"alternative_pain_sources": ["Lumbar/thoracic radiculopathy or facet disease", "Lumbar/thoracic/sacral trigger points", "Insufficiency fractures or lesions of sacrum/coccyx"], "specific_exclusions": ["Sacroplasty and coccygeoplasty (ALL indications)", "Non-painful/non-aggressive vertebral hemangioma", "Cervical spine (C1-C7)", "Thoracic levels T1-T4", "Prophylactic treatment for osteoporosis without acute fracture", "Chronic back pain >6 months even if associated with old VCF(s)", "Spinoplasty (OptiMesh system)", "Non-FDA-approved cement/devices (Norian XR, Norian SRS)", "Radiofrequency Kyphoplasty (StabiliT System)", "Vertebral body stenting"], "contraindications_ANY_present_equals_denial": ["Allergy to procedure materials", "Uncorrected coagulation disorders or anticoagulation therapy", "Myelopathy from bone fragment in canal or cord compression from tumor", "Extensive vertebral destruction", "Burst fracture with widened pedicles and/or retropulsed bone fragments", "Space-occupying lesion causing cord compression (tumor/bone fragment)", "Collapse to less than vertebra plana", "Radiculopathy from herniated disc", "Untreated symptomatic foraminal/canal stenosis, facet arthropathy, or other coexistent pain generators", "Unstable fracture requiring stabilization in same/adjacent region", "Septicemia or any active infection (including UTI)", "Active osteomyelitis of target vertebra", "Severe cardiopulmonary disease"]}, "documentation_required": ["CT or MRI confirming fracture acuity and level", "Fracture level must be T5-L5", "Functional impairment documentation", "If acute: documentation of inability to independently transfer/ambulate", "If subacute: 4-week medication trial records AND 4-week PT/exercise records", "If osteoporotic VCF: osteoporosis treatment program enrollment", "Imaging confirming no burst fracture/retropulsion/canal compromise", "Clinical documentation ruling out competing pain generators"]}, "aetna": {"guideline": "CPB 0016", "criteria": {"covered_indications_ANY": ["Painful debilitating osteoporotic VCF", "Painful debilitating steroid-induced VCF", "Osteolytic vertebral metastasis or myeloma with severe pain not involving major cortical bone", "Vertebral hemangioma with aggressive signs (after failed radiation)"], "requirements_ALL": ["Persistent debilitating pain in thoracic or lumbar vertebrae", "Failed standard medical therapy (analgesics, bed rest, bracing, PT)", "CT or MRI ruling out other causes of spinal pain", "Fracture confirmed on imaging"], "not_covered": ["Prophylactic treatment of non-fractured vertebrae", "Chronic stable fractures without ongoing pain", "Burst fractures with posterior cortex disruption", "More than 4 levels per session (typical limit)", "Sacral fractures (sacroplasty - separate criteria)", "Radiofrequency kyphoplasty (experimental per some sub-policies)"]}, "nicotine": "NOT required (not a fusion)", "conservative_tx": "Must have failed standard medical therapy (no specific duration stated in CPB 0016 but typically 2-6 weeks)"}, "uhc": {"guideline": "Percutaneous Vertebroplasty and Kyphoplasty Policy", "criteria": {"covered_for": "Pain causing functional/physical impairment in cervical/thoracic/lumbar vertebrae within 4 months of pain onset", "must_have_failed": "Optimal Medical Therapy", "indications_ANY": ["Osteoporotic VCF", "Steroid-induced VCF", "Osteolytic metastasis/myeloma with vertebral body destruction", "Vertebral hemangioma with aggressive features"], "imaging_required": "CT or MRI ruling out other causes", "time_limit": "Within 4 months of pain onset (acute/subacute only)", "not_covered": ["Chronic fractures >4 months", "Asymptomatic VCFs", "Sacral/coccyx lesions (separate policy)", "Indications not listed above"]}, "nicotine": "NOT required"}}, "posterior_cervical_fusion": {"description": "Posterior cervical laminectomy/decompression with or without instrumented fusion (C2-T2)", "cpt_codes": {"decompression": ["63047 (first segment)", "63048 (each additional)"], "fusion": ["22600 (posterior cervical arthrodesis, first segment)", "22614 (each additional segment)"], "instrumentation": ["22840 (1-2 segments)", "22842 (3-6 segments)", "22843 (7-12 segments)"], "grafts": ["20936 (local autograft)", "20930 (allograft morselized)"], "navigation": ["61783 (spinal navigation)"], "osteotomy": ["22210 (posterior cervical osteotomy, 1-column)"]}, "cigna": {"guideline": "CMM-603 (decompression) + CMM-604 (fusion)", "PREREQUISITE": "CMM-603.2 decompression criteria MUST be met before CMM-604 fusion criteria apply", "pathways": {"myelopathy": {"section": "CMM-603.2 + CMM-604.4", "FASTEST_PATHWAY": true, "description": "Myelopathy = urgent/emergent. Bypasses conservative tx, nicotine, mental health", "decompression_criteria_ALL": ["Candidate for decompression per CMM-603.2 (auto-satisfied by myelopathy)", "MRI/CT shows cervical cord compression OR stenosis with cord signal changes", "Exam findings ANY: hyperreflexia, Hoffmann sign, Babinski, clonus, gait disturbance, myelopathic hand, increased muscle tone/spasticity"], "fusion_criteria_ALL": ["Meets decompression criteria above", "Instability present OR multilevel (3+ levels) requiring stabilization", "Plain X-rays with flex-ext performed"], "conservative_tx": "NOT required", "nicotine": "NOT required (waived for myelopathy)", "mental_health": "NOT required", "imaging_requirement": "MRI showing cord compression + plain X-rays with flex-ext", "KEY_DOCUMENTATION": ["Document specific myelopathy signs on exam (Hoffmann, hyperreflexia, clonus, gait)", "MRI must say 'cord compression' not just 'impingement'", "Document why posterior approach chosen over ACDF (multilevel, kyphosis, OPLL, prior anterior)"]}, "radiculopathy": {"section": "CMM-603.2 + CMM-604.4", "criteria_ALL": ["Significant daily pain with functional impairment", "Unremitting radicular pain to shoulder girdle/upper extremity", "Objective exam finding (ANY): dermatomal sensory deficit, motor deficit, reflex changes, Spurling test", "Failed at least 2 of 3 conservative modalities for 6 weeks each", "Plain X-rays with flex-ext of cervical spine", "MRI/CT shows neural compression at requested level concordant with symptoms", "Mental health screening: absence of untreated disorders", "Nicotine: never-smoker attestation OR cotinine <=10 ng/mL within 6 weeks"], "conservative_tx_fail_2_of_3": ["Rx analgesics/steroids/gabapentinoids/NSAIDs x 6 weeks", "Provider-directed exercise (PT/chiro/physician) x 6 weeks", "Injection: ESI or selective nerve root block at SAME level"], "fusion_additional": ["Decompression criteria met per CMM-603.2", "Instability demonstrated on flex-ext (>3.5mm subluxation OR >11 degrees angulation)", "OR multilevel decompression requiring stabilization", "OR deformity correction needed"]}, "instability_without_decompression": {"section": "CMM-604.3", "description": "Fusion only, no decompression needed. For cervical instability alone.", "criteria_ALL": ["Plain X-rays with flex-ext performed", "Imaging shows >3.5mm subluxation OR >11 degrees sagittal angulation", "OR congenital/acquired instability (RA, Down syndrome, os odontoideum, etc.)", "Failed reasonable conservative tx (rest, meds, cervical collar)", "Mental health screening", "Nicotine: never-smoker or cotinine <=10"], "urgent_if": "X-rays show >3.5mm or >11 degrees \u2192 urgent pathway (waives conservative tx)"}}, "contraindications": ["Active infection at surgical site", "Uncorrected coagulopathy", "Medical comorbidities prohibiting safe anesthesia"], "routing_logic": {"STRATEGY": "If ANY myelopathy signs \u2192 myelopathy pathway (fastest). If radiculopathy with multilevel compression \u2192 posterior approach justified. Always document why posterior chosen over anterior."}}, "aetna": {"guideline": "CPB 0743", "pathways": {"myelopathy": {"FASTEST_PATHWAY": true, "criteria_ALL": ["Objective myelopathy signs documented on exam", "MRI shows cord compression (must use word 'compression' - NOT 'impingement', 'effacement', 'mass effect')", "Stenosis must be graded moderate or severe (mild/mild-to-moderate = denial)"], "conservative_tx": "WAIVED for myelopathy", "nicotine": "WAIVED for myelopathy", "CRITICAL_IMAGING_LANGUAGE": ["ACCEPTED: compression, cord compression, severe stenosis", "REJECTED: mass effect, impingement, abutment, effacement, indentation, flattening", "If radiologist uses rejected term, surgeon must request addendum"]}, "radiculopathy": {"criteria_ALL": ["Radicular symptoms concordant with imaging", "Failed 6 weeks ALL: education, exercise, medications, psychological screen", "MRI shows neural compression using accepted terminology", "Nicotine-free >=6 weeks with lab confirmation if smoker within past year"], "fusion_additional": ["Instability: >=3mm sagittal translation OR >11 degrees angulation", "OR multilevel decompression (3+ levels)"]}}, "CRITICAL_NOTES": ["Aetna may question posterior approach for 1-2 level disease \u2014 document why anterior not appropriate", "Verify MRI report uses 'compression' not alternative terms", "Radiologist report required (surgeon interpretation alone insufficient)", "PT discharge note documenting inability to tolerate counts as conservative tx waiver (UNIQUE to Aetna)"]}, "uhc": {"guideline": "2026T0639H (defers to InterQual)", "pathways": {"general": {"criteria": "InterQual criteria \u2014 exact requirements not publicly available", "known_requirements": ["Failed conservative treatment (duration varies by indication)", "Concordant imaging findings", "Functional impairment documented"], "nicotine": "Not explicitly required but recommended to document", "approximate_criteria": "Generally similar to Cigna requirements. InterQual criteria accessed at point of care by UM reviewer."}}, "LIMITATION": "UHC defers to InterQual which is not publicly decomposable. Use most conservative (Cigna-like) criteria as safety net."}}}, "cross_payer_comparison": {"conservative_tx_duration": {"microdiscectomy_laminectomy": {"cigna": "6 weeks, fail 2 of 3 modalities", "aetna": "6 weeks, ALL modalities (education + PT + meds + psych)", "uhc": "~6 weeks (InterQual)"}, "fusion_with_instability_decompression": {"cigna": "NOT required when instability present with decompression", "aetna": "6 weeks (decompression criteria)", "uhc": "~6 weeks"}, "fusion_spondylolisthesis_standalone": {"cigna": "3 months, EITHER meds OR PT", "aetna": "6 weeks, ALL modalities", "uhc": "~6-12 weeks"}, "fusion_DDD_no_instability": {"cigna": "12 months, 2 of 4 modalities, structured program", "aetna": "NOT COVERED (experimental)", "uhc": "Unknown (InterQual)"}, "acdf_radiculopathy": {"cigna": "6 weeks, fail 2 of 3", "aetna": "6 weeks, ALL modalities", "uhc": "~6 weeks"}, "acdf_myelopathy": {"cigna": "NONE", "aetna": "NONE (waived)", "uhc": "Likely NONE"}, "kyphoplasty": {"cigna": "Acute (0-6wk): NO conservative tx if prevents transfers/ambulation. Subacute (>6wk): failed BOTH meds AND exercise x 4 weeks. Chronic >6mo: NOT COVERED.", "aetna": "Failed standard medical therapy (no fixed duration)", "uhc": "Failed optimal medical therapy, within 4 months of onset"}}, "instability_thresholds": {"cigna_lumbar": ">3mm translation on flex-ext", "aetna_lumbar": ">=4mm translation OR >=10 degrees angular motion", "uhc_lumbar": ">=3mm sagittal displacement OR >11 degrees angulation", "cigna_cervical": ">3.5mm subluxation OR >11 degrees angulation", "aetna_cervical": ">=3mm sagittal translation OR >11 degrees angulation", "WARNING": "Translation 3.0-3.9mm passes Cigna and UHC but FAILS Aetna"}, "nicotine_requirements": {"fusions": {"cigna": "Lab required. Never-smoker attestation accepted. Waived for urgent.", "aetna": "Lab required if nicotine use within past year. NO never-smoker attestation. Waived for myelopathy/cauda equina/severe weakness/infection/tumor/fracture.", "uhc": "Not explicitly stated (InterQual may require)"}, "decompressions": "NOT required by any payer", "kyphoplasty": "NOT required by any payer"}, "DDD_coverage": {"cigna": "COVERED but strictest pathway (12 months, single-level only)", "aetna": "NOT COVERED - experimental/investigational", "uhc": "Unknown (InterQual)"}, "myelopathy_fast_track": {"description": "Myelopathy is the FASTEST approval path for cervical procedures across all payers", "bypasses": ["Conservative treatment", "Nicotine requirement (Cigna/Aetna)", "Mental health screening (Cigna)"], "KEY": "Even subtle myelopathy signs (Hoffmann, hyperreflexia) qualify for fast-track"}, "posterior_cervical": {"myelopathy_pathway": {"cigna": "FASTEST - waives all conservative tx, nicotine, mental health", "aetna": "FAST - waives conservative tx and nicotine. CRITICAL: imaging must say 'compression'", "uhc": "Unknown exact criteria (InterQual). Likely similar waiver for myelopathy."}, "approach_justification": {"cigna": "Not explicitly required but recommended", "aetna": "May question posterior for 1-2 levels \u2014 document why anterior not appropriate", "uhc": "Unknown requirement"}, "KEY_WARNING": "All payers may question posterior approach for fewer than 3 levels. Document: multilevel compression, kyphosis, OPLL, prior anterior surgery, or patient anatomy preventing anterior approach."}}, "automation_decision_tree": {"step_1_identify_payer": "Pull from FHIR Coverage resource \u2192 payor reference", "step_2_identify_procedure": "From ServiceRequest or surgeon input \u2192 map to procedure category", "step_3_check_urgent_emergent": {"if_yes": "Bypass conservative tx, nicotine, mental health. Still need imaging.", "urgent_conditions": "Cauda equina, progressive deficit, motor weakness <=3/5, bowel/bladder, fracture with instability, infection, tumor"}, "step_4_check_myelopathy": {"if_cervical_and_myelopathy": "Fast-track: imaging + exam findings only. No conservative tx, no nicotine, no mental health.", "exam_triggers": ["Hoffmann sign", "hyperreflexia", "Babinski", "clonus", "myelopathic hand", "gait disturbance"]}, "step_5_check_instability": {"if_spondylolisthesis_present": "Route to instability pathway (much easier than DDD)", "check_for": "Any anterolisthesis on imaging, dynamic instability on flex-ext, prior decompression instability", "CRITICAL": "This is the single most important routing decision"}, "step_6_route_to_pathway": "Based on payer + procedure + indication \u2192 select specific pathway", "step_7_gap_analysis": "Check each requirement against available EHR data \u2192 identify missing items", "step_8_generate_checklist": "Produce document checklist with traffic light status (green/yellow/red)"}, "fhir_to_policy_field_mapping": {"Patient": {"maps_to": "Demographics, DOB, gender for payer forms", "fields": ["name", "birthDate", "gender", "identifier (MRN)"]}, "Coverage": {"maps_to": "Payer identification, member ID, group number", "fields": ["payor", "subscriberId", "class (group)", "period"], "determines": "Which payer's policy engine to run"}, "Condition": {"maps_to": "Diagnoses, ICD-10 codes, symptom duration", "key_codes": {"M43.16": "Spondylolisthesis lumbar", "M47.816": "Spondylosis with radiculopathy lumbar", "M48.06": "Spinal stenosis lumbar", "M51.16": "Disc degeneration lumbar with radiculopathy", "M50.12": "Cervical disc disorder with radiculopathy", "M50.02": "Cervical disc disorder with myelopathy", "G95.20": "Unspecified cord compression", "M80.08XA": "Osteoporosis with compression fracture"}, "onset_date": "Use to calculate symptom duration"}, "Observation": {"maps_to": "Smoking status, lab results, vitals", "key_observations": {"smoking_status": "LOINC 72166-2 (us-core-smokingstatus profile)", "cotinine_lab": "LOINC 3426-4 (cotinine blood) or 34693-7 (cotinine urine)", "ODI_score": "LOINC 93026-3 (if structured)"}}, "MedicationRequest": {"maps_to": "Conservative treatment medication trials", "key_medications": {"NSAIDs": "Look for ibuprofen, naproxen, meloxicam, diclofenac, celecoxib", "gabapentinoids": "gabapentin, pregabalin", "muscle_relaxants": "cyclobenzaprine, tizanidine, methocarbamol", "steroids": "prednisone, methylprednisolone dose pack"}, "use_authoredOn": "Calculate duration of medication trial"}, "Procedure": {"maps_to": "Prior surgeries, injection history", "key_procedures": {"prior_fusion": "CPT 22612, 22630, 22633, 22551", "prior_decompression": "CPT 63005, 63030, 63047", "ESI": "CPT 62322, 62323", "facet_injection": "CPT 64490-64495", "RFA": "CPT 64635, 64636"}, "use_performedDateTime": "Calculate time since prior surgery (12-week minimum for repeat, 6-month for fusion revision)"}, "DocumentReference": {"maps_to": "PT notes, radiology reports, outside records", "classification_needed": {"RADIOLOGY_REPORT": "Check for compression language (Aetna), stenosis grading, spondylolisthesis grade", "PT_NOTES": "Check for initial eval date, discharge date, session count, functional status", "CONSULTATION_NOTE": "Specialist evaluations", "LAB_RESULTS": "Cotinine/nicotine results", "OPERATIVE_REPORT": "Prior surgery details"}}, "DiagnosticReport": {"maps_to": "Lab results (cotinine), imaging reports", "cotinine_check": {"code": "LOINC 3426-4 or 34693-7", "value_threshold": "<=10 ng/mL", "date_check": "Within 6 weeks of planned surgery"}}, "ServiceRequest": {"maps_to": "The authorization request itself", "can_create": true, "fields": ["code (CPT)", "subject (patient)", "requester (surgeon)", "reasonCode (ICD-10)"]}, "Encounter": {"maps_to": "Visit history, structured management plan appointments", "use_for": "Documenting regular follow-up (required for Cigna DDD pathway)"}}};
  return policyEngine;
}

async function runAuthCheck(){
  const{payer,procedure}=authState;
  if(!payer||!procedure){authState.err="Select payer and procedure.";render();return;}
  if(!API_KEY){authState.err="Add API key in Settings.";render();return;}
  authState.phase="checking";authState.err=null;authState.results=null;authState.letter="";render();
  try{
    const pe=await loadPolicyEngine();
    const procData=pe.procedures?.[procedure]||{};
    const globalRules=pe.global_rules||{};
    let policyContext="";
    if(payer==="other"){
      policyContext="PAYER: Unknown — use MOST CONSERVATIVE criteria across all payers.\n\n";
      ["cigna","aetna","uhc"].forEach(p=>{if(procData[p])policyContext+=p.toUpperCase()+" CRITERIA:\n"+JSON.stringify(procData[p],null,2)+"\n\n";if(globalRules[p])policyContext+=p.toUpperCase()+" GLOBAL:\n"+JSON.stringify(globalRules[p],null,2)+"\n\n";});
    }else{
      policyContext="PAYER: "+payer.toUpperCase()+"\n";
      if(procData[payer])policyContext+="CRITERIA:\n"+JSON.stringify(procData[payer],null,2)+"\n\n";
      if(globalRules[payer])policyContext+="GLOBAL:\n"+JSON.stringify(globalRules[payer],null,2)+"\n\n";
    }
    let clinicalData="\n=== CLINICAL DATA (organized by source) ===\n";
    if(authState.mriText)clinicalData+="\n--- MRI/IMAGING (radiology findings ONLY) ---\n"+authState.mriText+"\n";
    if(authState.medsText)clinicalData+="\n--- MEDICATIONS (drug history) ---\n"+authState.medsText+"\n";
    if(authState.ptText)clinicalData+="\n--- PT/CONSERVATIVE TREATMENT (therapy records) ---\n"+authState.ptText+"\n";
    if(authState.labsText)clinicalData+="\n--- LABS (laboratory results) ---\n"+authState.labsText+"\n";
    if(authState.priorText)clinicalData+="\n--- PRIOR PROCEDURES (surgical history) ---\n"+authState.priorText+"\n";
    clinicalData+="\n=== END CLINICAL DATA ===\n";
    const sys=`You are a prior authorization specialist for neurosurgery with EXACT payer policy criteria.
Compare clinical data against SPECIFIC payer requirements.

CRITICAL DATA ZONE RULES:
- The clinical data below is organized into LABELED SECTIONS: MRI/IMAGING, MEDICATIONS, PT/CONSERVATIVE TX, LABS, PRIOR PROCEDURES.
- ONLY use data from the appropriate section for each criterion check.
- MRI/IMAGING section = ONLY radiology findings. If this section contains exam findings (ROS, physical exam, neurological exam, vital signs), IGNORE them — they are not imaging data.
- Do NOT cite Review of Systems, physical exam findings, or clinical symptoms as "imaging findings."
- If a section is empty or missing, mark that criterion as RED (not documented), do NOT fabricate or pull from wrong section.
- Imaging findings = what the radiologist reported (disc herniation, stenosis, compression, signal change, measurements).
- Clinical findings = what the surgeon found on exam (weakness, reflex changes, Hoffmann, gait). These support the case but are NOT imaging.

RESPONSE FORMAT (use EXACTLY):

PATHWAY: [which coverage pathway and why]

CHECKLIST:
GREEN: [requirement] — [evidence from clinical data with source section]
YELLOW: [requirement] — [needs attention/clarification]
RED: [requirement] — [missing or not documented]

CRITICAL_WARNINGS:
- [payer-specific language traps, timing issues, denial triggers]

ESTIMATED_APPROVAL: [LIKELY / POSSIBLE / UNLIKELY] — [reason]
PEER_TO_PEER: [ANTICIPATED / NOT ANTICIPATED] — [reason]

===LETTER===
To: Medical Director, [PAYER] Utilization Review
Re: [PATIENT NAME], DOB: [DOB], Member ID: [MEMBER ID]

Dear Medical Director,
[Clinical justification referencing SPECIFIC payer criteria. Include procedure with CPT, diagnosis with ICD-10, clinical findings, imaging, conservative treatment history. Be assertive but factual. Reference specific policy by name/number.]

Sincerely,
[SURGEON NAME], MD`;
    const procName=AUTH_PROCEDURES.find(p=>p.id===procedure)?.name||procedure;
    const userMsg=policyContext+"\nPROCEDURE: "+procName+"\n\n"+clinicalData+"\n\nAnalyze against the SPECIFIC payer criteria. Be precise.";
    const{txt}=await callC([{role:"user",content:userMsg}],2,sys);
    const letterSplit=txt.split("===LETTER===");
    const checklistPart=letterSplit[0]||txt;
    const letterPart=(letterSplit[1]||"").trim();
    const items=[];
    checklistPart.split("\n").forEach(line=>{
      const gm=line.match(/^GREEN:\s*(.*)/i);const ym=line.match(/^YELLOW:\s*(.*)/i);const rm=line.match(/^RED:\s*(.*)/i);
      if(gm)items.push({status:"green",text:gm[1].trim()});if(ym)items.push({status:"yellow",text:ym[1].trim()});if(rm)items.push({status:"red",text:rm[1].trim()});
    });
    const pathwayMatch=checklistPart.match(/PATHWAY:\s*(.*?)(?:\n|$)/i);
    const approvalMatch=checklistPart.match(/ESTIMATED_APPROVAL:\s*(.*?)(?:\n|$)/i);
    const p2pMatch=checklistPart.match(/PEER_TO_PEER:\s*(.*?)(?:\n|$)/i);
    const warningsMatch=checklistPart.match(/CRITICAL_WARNINGS:\s*\n([\s\S]*?)(?=\nESTIMATED|\nPEER|\n===|$)/i);
    const warnings=warningsMatch?warningsMatch[1].split("\n").filter(l=>l.trim().startsWith("-")).map(l=>l.replace(/^-\s*/,"").trim()):[];
    authState.results={items,pathway:pathwayMatch?pathwayMatch[1].trim():"",approval:approvalMatch?approvalMatch[1].trim():"",p2p:p2pMatch?p2pMatch[1].trim():"",warnings};
    authState.letter=letterPart;authState.phase="done";render();
  }catch(e){authState.err="Auth check failed: "+e.message;authState.phase="done";render();}
}
function resetAuth(){authState={payer:"",procedure:"",mriText:"",medsText:"",ptText:"",labsText:"",priorText:"",results:null,letter:"",phase:"",err:null};render();}
function populateAuthFromNote(noteText){
  if(!noteText)return;
  const nt=noteText;
  // Extract imaging section (everything between IMAGING: and next major header)
  const imgHeaders=/(?:IMAGING|RADIOLOGY|MRI|CT SCAN|DIAGNOSTIC STUDIES)[^:]*:/i;
  const nextHeaders=/\n(?:DIFFERENTIAL|ASSESSMENT|PLAN|DISPOSITION|PRECAUTIONS|PRE-AUTH|BILLING|REVIEW OF SYSTEMS|ROS|PHYSICAL EXAM|EXAM|SOCIAL HISTORY|FAMILY HISTORY|PAST MEDICAL|PAST SURGICAL|ALLERGIES|MEDICATIONS|WORKUP)/i;
  const imgM=nt.match(imgHeaders);
  if(imgM){
    const start=imgM.index;
    const rest=nt.slice(start+imgM[0].length);
    const end=rest.search(nextHeaders);
    authState.mriText=(end>0?rest.slice(0,end):rest).trim();
  }
  // Extract medication history
  const medHeaders=/(?:MEDICATIONS|MEDICATION HISTORY|CURRENT MEDICATIONS|MED LIST)[^:]*:/i;
  const medM=nt.match(medHeaders);
  if(medM){
    const start=medM.index;
    const rest=nt.slice(start+medM[0].length);
    const end=rest.search(nextHeaders);
    authState.medsText=(end>0?rest.slice(0,end):rest).trim();
  }
  // Extract conservative treatment / PT from HPI or dedicated section
  const ptPhrases=[];
  if(/physical therapy|PT\b/i.test(nt))ptPhrases.push("Physical therapy documented in note");
  const ptDuration=nt.match(/(\d+)\s*(?:weeks?|months?)\s*(?:of\s*)?(?:physical therapy|PT|conservative)/i);
  if(ptDuration)ptPhrases.push(ptDuration[0]);
  const meds=nt.match(/(?:failed|tried|completed|taking)\s+[\w\s,]+(?:gabapentin|meloxicam|naproxen|ibuprofen|prednisone|NSAIDs|muscle relaxants|pregabalin|cyclobenzaprine|tizanidine|duloxetine|methocarbamol)/gi);
  if(meds)ptPhrases.push(...meds.map(m=>m.trim()));
  const injections=nt.match(/(?:epidural|ESI|injection|nerve root block|facet)[^.;\n]*/gi);
  if(injections)ptPhrases.push(...injections.map(m=>m.trim()));
  if(ptPhrases.length)authState.ptText=ptPhrases.join("\n");
  // Extract labs if mentioned
  const labM=nt.match(/(?:cotinine|nicotine|lab|hemoglobin|HbA1c)[^.;\n]*/gi);
  if(labM)authState.labsText=labM.join("\n");
  // Extract prior procedures
  const priorM=nt.match(/(?:prior surgery|previous surgery|surgical history|prior procedure|revision|prior decompression|prior fusion)[^.;\n]*/gi);
  if(priorM)authState.priorText=priorM.join("\n");
  // Procedure detection
  const procMatch=nt.match(/(?:recommended procedure|procedure|recommend(?:ing)?)[^:]*:?\s*([^\n]+)/i);
  if(procMatch){
    const pt=procMatch[1].toLowerCase();
    if(pt.includes("acdf")&&pt.includes("3"))authState.procedure="acdf_3_level";
    else if(pt.includes("acdf")&&pt.includes("2"))authState.procedure="acdf_2_level";
    else if(pt.includes("acdf"))authState.procedure="acdf_1_level";
    else if(pt.includes("tlif")&&pt.includes("2"))authState.procedure="tlif_2_level";
    else if(pt.includes("tlif"))authState.procedure="tlif_1_level";
    else if(pt.includes("laminect")&&pt.includes("cerv"))authState.procedure="posterior_cervical_fusion";
    else if(pt.includes("posterior cervical"))authState.procedure="posterior_cervical_fusion";
    else if(pt.includes("laminect"))authState.procedure="lumbar_laminectomy";
    else if(pt.includes("microdiscect")||pt.includes("discect"))authState.procedure="lumbar_microdiscectomy";
    else if(pt.includes("kyphoplasty"))authState.procedure="kyphoplasty";
  }
  state.view="auth";render();
}

// ---- NOTE TYPES ----
const TYPES={operative:{l:"Operative Note",e:"🔪"},clinic:{l:"Clinic Note",e:"🏥"},consult:{l:"Inpatient Consult",e:"📞"},progress:{l:"Progress Note",e:"🛏️"},critical:{l:"Critical Care",e:"🚨"}};
function typeCat(id){return id==="operative"?"Operative":id==="clinic"?"Clinic":"Inpatient";}
function noteTypeLabel(t){return TYPES[t]?TYPES[t].e+" "+TYPES[t].l:"📋 Note";}

// ---- API ----
async function callAPI(msgs,sys){
  const body={model:"claude-sonnet-4-20250514",max_tokens:8192,messages:msgs};
  if(sys)body.system=sys;
  const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify(body)});
  if(!res.ok){const et=await res.text();throw new Error("API "+res.status+": "+et.slice(0,300));}
  const d=await res.json();if(d.error)throw new Error(d.error.message);
  return{txt:d.content.map(c=>c.type==="text"?c.text:"").filter(Boolean).join("\n"),stop:d.stop_reason};
}
async function callC(msgs,mx,sys){
  let{txt,stop}=await callAPI(msgs,sys);let full=txt;let m=[...msgs];
  for(let i=0;i<(mx||2);i++){if(stop!=="max_tokens")break;m=[...m,{role:"assistant",content:full},{role:"user",content:"Continue exactly where you left off."}];const r=await callAPI(m,sys);full+="\n"+r.txt;stop=r.stop;}
  return{txt:full,msgs:m};
}

// ---- WHISPER ----
let mR=null,aC=[],rST=0,rTm=null,rS="idle";
async function startRec(){try{const s=await navigator.mediaDevices.getUserMedia({audio:true});aC=[];const m=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"";mR=m?new MediaRecorder(s,{mimeType:m}):new MediaRecorder(s);mR.ondataavailable=e=>{if(e.data.size>0)aC.push(e.data);};mR.onstop=async()=>{s.getTracks().forEach(t=>t.stop());clearInterval(rTm);if(!aC.length){rS="idle";render();return;}rS="transcribing";render();try{const b=new Blob(aC,{type:mR.mimeType||"audio/webm"});const t=await whisper(b);if(t)state.text=(state.text?state.text+"\n":"")+t;rS="idle";render();}catch(e){state.err="Transcription: "+e.message;rS="idle";render();}};mR.start(1000);rST=Date.now();rS="recording";rTm=setInterval(()=>render(),1000);render();}catch{state.err="Mic denied.";rS="idle";render();}}
function stopRec(){if(mR?.state==="recording")mR.stop();}
function toggleRec(){rS==="recording"?stopRec():rS==="idle"&&startRec();}
async function whisper(blob){const key=state.wk;if(!key)throw new Error("Add OpenAI key for dictation.");const fd=new FormData();fd.append("file",blob,"r.webm");fd.append("model","whisper-1");fd.append("language","en");fd.append("prompt","Neurosurgery: ACDF, TLIF, laminectomy, kyphoplasty, craniotomy, myelopathy, radiculopathy, SSEPs, MEPs, pedicle screws, interbody cage, allograft, autograft.");const res=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{"Authorization":"Bearer "+key},body:fd});const d=await res.json();if(d.error)throw new Error(d.error.message);return d.text||"";}
function rD(){if(rS!=="recording")return"";const s=Math.floor((Date.now()-rST)/1000);return Math.floor(s/60)+":"+(s%60<10?"0":"")+(s%60);}

// ---- IMAGE ANALYSIS ----
const IMG_PROMPT="You are a clinical document extractor for neurosurgery. IF MEDICAL IMAGING: Extract findings in surgical format. IF TEXT: Transcribe. No patient identifiers.";
function resizeImage(file){return new Promise((resolve,reject)=>{const img=new Image();img.onload=()=>{const max=2048;let w=img.width,h=img.height;if(w>max||h>max){const r=Math.min(max/w,max/h);w=Math.round(w*r);h=Math.round(h*r);}const c=document.createElement("canvas");c.width=w;c.height=h;c.getContext("2d").drawImage(img,0,0,w,h);resolve(c.toDataURL("image/jpeg",0.85).split(",")[1]);};img.onerror=reject;img.src=URL.createObjectURL(file);});}
async function analyzeImage(file,target){
  setState({phase:"image",err:null});
  try{let b64,mt=file.type||"image/jpeg";if(file.size>4*1024*1024){b64=await resizeImage(file);mt="image/jpeg";}else{b64=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(",")[1]);r.onerror=rej;r.readAsDataURL(file);});}
  const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2048,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mt,data:b64}},{type:"text",text:IMG_PROMPT}]}]})});
  if(!res.ok)throw new Error("API "+res.status);const data=await res.json();const txt=data.content.map(c=>c.type==="text"?c.text:"").join("");
  if(txt){if(target==="addend")state.addend=(state.addend?state.addend+"\n\n":"")+txt;else state.text=(state.text?state.text+"\n\n":"")+txt;}
  setState({phase:state.noteText?"done":""});}catch(e){setState({err:"Image: "+e.message,phase:state.noteText?"done":""});}
}
function pickImage(target){const inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.onchange=()=>{if(inp.files[0])analyzeImage(inp.files[0],target||"text");};inp.style.cssText="position:fixed;top:-9999px;left:-9999px;opacity:0";document.body.appendChild(inp);setTimeout(()=>{inp.click();},100);setTimeout(()=>{try{inp.remove();}catch{}},120000);}

// ---- HELPERS ----
function stripAll(t){return(t||"").replace(/\*[^*]+\*/g,"").replace(/\*{2,3}\s*ASSUMED\s*\*{2,3}\s*/gi,"").replace(/\*{2,3}\s*IMPLANT\s*\*{2,3}\s*/gi,"").replace(/\*{2,3}\s*ADDED\s*\*{2,3}\s*/gi,"").replace(/\*\*([^*]+)\*\*/g,"$1").replace(/#{1,4}\s*/g,"").replace(/---+/g,"").replace(/\n{3,}/g,"\n\n").replace(/  +/g," ");}
function stripBilling(t){return(t||"").replace(/\n*BILLING ANALYSIS:[\s\S]*$/i,"").replace(/\n*PRIMARY PROCEDURES:[\s\S]*$/i,"").trim();}
function dedupNote(t){if(!t)return t;const headers=["PREOPERATIVE DIAGNOSIS","POSTOPERATIVE DIAGNOSIS","PROCEDURE","INDICATIONS","TECHNIQUE","ASSESSMENT AND PLAN","HISTORY OF PRESENT ILLNESS","PHYSICAL EXAMINATION","DISPOSITION"];let out=t;headers.forEach(h=>{const rx=new RegExp("(^|\\n)("+h+"[:\\s])","gi");const matches=[...out.matchAll(rx)];if(matches.length>1){out=out.slice(0,matches[0].index)+out.slice(matches[1].index);}});return out.trim();}
const INC_SUFFIX="\n\nCRITICAL: Output ONLY the single updated note. REPLACE changed sections in-place. Do NOT append or duplicate. One note only.";
function fmtTime(ms){if(!ms)return"";const s=Math.round(ms/1000);return s<60?s+"s":Math.floor(s/60)+"m "+s%60+"s";}

function parseQuestions(raw){
  const qs=[];let ni=raw.indexOf("\nNOTE:");if(ni<0)ni=raw.indexOf("NOTE:");
  const qS=ni>0?raw.slice(0,ni):null;
  let nS=ni>=0?raw.slice(ni).replace(/^[\n]*NOTE:\s*\n?/,"").trim():raw.replace(/^[\n]*NOTE:\s*\n?/,"").trim();
  if(qS){qS.split(/(?=Q:\s)/).forEach(p=>{const qm=p.match(/Q:\s*(.*?)(?:\n|$)/);const dm=p.match(/DEFAULT:\s*([\s\S]*?)(?:\n---|$)/);if(qm)qs.push({q:qm[1].trim(),def:(dm?dm[1].trim():"")});});}
  return{questions:qs,note:nS};
}
function parseWorkup(raw){const m=raw.match(/\nWORKUP:\s*\n([\s\S]*?)$/i);if(!m)return{note:raw,wu:[]};const items=[];m[1].split("\n").filter(l=>l.trim()).forEach(l=>{const x=l.match(/^\d+[\.\)]\s*(.*)/)||l.match(/^-\s*(.*)/);if(x)items.push(x[1].trim());});return{note:raw.slice(0,m.index).trim(),wu:items};}
function parseGaps(raw){if(!raw)return[];const gaps=[];let cur=null;raw.split("\n").forEach(l=>{const t=l.trim();if(t.startsWith("IMPACT:")){if(cur&&cur.issue)gaps.push(cur);cur={impact:(t.match(/(HIGH|MED|LOW)/i)||["","MED"])[1].toUpperCase(),issue:"",language:""};}else if(t.startsWith("ISSUE:")&&cur)cur.issue=t.slice(6).trim();else if(t.startsWith("LANGUAGE:")&&cur)cur.language=t.slice(9).trim();else if(t==="---"){if(cur&&cur.issue)gaps.push(cur);cur=null;}else if(cur){if(cur.language)cur.language+="\n"+t;else if(cur.issue)cur.issue+="\n"+t;}});if(cur&&cur.issue)gaps.push(cur);return gaps;}
function parseFlags(raw){if(!raw)return[];const flags=[];let cur=null;raw.split("\n").forEach(l=>{const t=l.trim();const m=t.match(/^(RED|YELLOW|GREEN):\s*(.*)/i);if(m){if(cur)flags.push(cur);cur={type:m[1].toUpperCase(),text:m[2].trim(),input:null};}else if(t.startsWith("INPUT_NEEDED:")&&cur)cur.input=t.slice(13).trim();else if(cur&&t)cur.text+="\n"+t;});if(cur)flags.push(cur);return flags;}
function parseFinancial(raw){if(!raw)return null;const f={};const rm=raw.match(/TOTAL RVU:\s*([\d.]+)/i);if(rm)f.rvu=rm[1];const cm=raw.match(/CURRENT ESTIMATE:\s*\$?([\d,.\-$\s]+)/i);if(cm)f.current=cm[1].trim();const wm=raw.match(/WITH GAPS.*?:\s*\$?([\d,.\-$\s]+)/i);if(wm)f.potential=wm[1].trim();const cr=raw.match(/CAPTURE RATE:\s*([\d.%]+)/i);if(cr)f.capture=cr[1].trim();return Object.keys(f).length?f:null;}
function parseBillFull(raw){
  const clean=raw.replace(/\*{2}(CODES|MODIFIERS|ICD-?10|BUNDLING|GAPS|FLAGS|PRE-AUTH[A-Z ]*|FINANCIAL)\*{2}:?/gi,"$1:");
  const sec={codes:"",modifiers:"",icd:"",bundling:"",gaps:"",flags:"",financial:"",preauth:"",mdm:""};
  const markers=[{key:"mdm",rx:/^E\/M MDM SCORING:\s*\n/im},{key:"codes",rx:/^CODES:\s*\n/im},{key:"modifiers",rx:/^MODIFIERS:\s*\n/im},{key:"icd",rx:/^ICD-?10:\s*\n/im},{key:"bundling",rx:/^BUNDLING:\s*\n/im},{key:"gaps",rx:/^GAPS:\s*\n/im},{key:"flags",rx:/^FLAGS:\s*\n/im},{key:"preauth",rx:/^PRE-AUTH[A-Z ]*:\s*\n/im},{key:"financial",rx:/^FINANCIAL:\s*\n/im}];
  const found=[];markers.forEach(m=>{const match=clean.match(m.rx);if(match)found.push({key:m.key,idx:match.index,len:match[0].length});});
  found.sort((a,b)=>a.idx-b.idx);
  found.forEach((f,i)=>{const s=f.idx+f.len;const e=i+1<found.length?found[i+1].idx:clean.length;sec[f.key]=clean.slice(s,e).trim();});
  if(!found.length)sec.codes=clean;
  return sec;
}
function mdmLevel(codes){if(!codes)return"";const m=codes.match(/99(2[01]\d|2[1-5]\d)/);if(!m)return"";const c=parseInt(m[0]);if([99211,99212,99202,99252].includes(c))return"STRAIGHTFORWARD COMPLEXITY";if([99213,99203,99253].includes(c))return"LOW COMPLEXITY";if([99214,99204,99254].includes(c))return"MODERATE COMPLEXITY";if([99215,99205,99255].includes(c))return"HIGH COMPLEXITY";return"";}
function injectMDM(noteText,codes,nt){if(!noteText||!codes)return noteText;if(nt==="clinic")return noteText;if(nt!=="consult")return noteText;const lvl=mdmLevel(codes);if(!lvl)return noteText;const out=noteText.replace(/((?:CONSULTATION|CONSULT)\s*(?:NOTE)?)\s*([:\-—.]?\s*)/i,(m,header)=>header+" — "+lvl+"\n");return out!==noteText?out:lvl+"\n"+noteText;}
function formatEMR(t){var s=stripAll(stripBilling(t));s=s.replace(/\.\s+(HEENT|Cardiovascular|Pulmonary|Neurological|Musculoskeletal|Psychiatric|Gastrointestinal|Genitourinary|Skin|Extremities|General|Cranial|Gait|Motor|Sensory|Reflexes)(?=[\s:.])/g,".\n$1");s=s.replace(/\n(?=[A-Z][A-Z /&\-]{2,}:)/g,"\n\n");s=s.replace(/\n{3,}/g,"\n\n");return s.trim();}
function copyHTML(t,bid){const txt=formatEMR(t);const lines=txt.split("\n");let html="",plain="";lines.forEach(ln=>{const tr=ln.trim();if(/^[A-Z][A-Z /&\-]{2,}:/.test(tr))html+="<b>"+esc(tr)+"</b><br>";else if(!tr)html+="<br>";else html+=esc(tr)+"<br>";plain+=tr+"\n";});plain=plain.trim();try{navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([html],{type:"text/html"}),"text/plain":new Blob([plain],{type:"text/plain"})})]).catch(()=>navigator.clipboard.writeText(plain));}catch{navigator.clipboard.writeText(plain).catch(()=>{});}if(!state.tCopy)setState({tCopy:Date.now()});const b=document.getElementById(bid);if(b){const o=b.innerHTML;b.innerHTML="✅ Copied!";b.style.background="#059669";setTimeout(()=>{if(b){b.innerHTML=o;b.style.background="";}},2000);}}
function copyPlain(t,bid){navigator.clipboard.writeText(formatEMR(t)).catch(()=>{});if(!state.tCopy)setState({tCopy:Date.now()});const b=document.getElementById(bid);if(b){const o=b.innerHTML;b.innerHTML="✅";b.style.background="#059669";setTimeout(()=>{if(b){b.innerHTML=o;b.style.background="";}},2000);}}

function copyForAgent(bid){
  var noteText=formatEMR(state.editing?state.editText:state.noteText);
  // Strip *assumed xxx* and any *xxx* placeholders
  noteText=noteText.replace(/\*[^*]+\*/g,'').replace(/  +/g,' ').trim();
  var icdRaw=state.billICD||"";
  var icd10_codes=[];
  icdRaw.split("\n").forEach(function(line){
    var m=line.match(/([A-Z]\d{1,2}\.?\d{0,4})\s*[-\u2013\u2014:]\s*(.*)/i);
    if(m)icd10_codes.push({code:m[1].trim(),description:m[2].trim()});
  });
  var payload={
    _type:"opnote-emr-agent",
    _timestamp:new Date().toISOString(),
    note_type:state.nt,
    note_text:noteText,
    icd10_codes:icd10_codes,
    primary_icd10:icd10_codes.length?icd10_codes[0].code:null,
    surgeon:state.sn||"Diaz"
  };
  navigator.clipboard.writeText(JSON.stringify(payload)).catch(function(){});
  var b=document.getElementById(bid);
  if(b){var o=b.innerHTML;b.innerHTML="\u2705 Copied!";b.style.background="#059669";setTimeout(function(){if(b){b.innerHTML=o;b.style.background="";}},2000);}
}

// ---- SYSTEM PROMPT ----
function getSYS(){return `You are OpNote Intelligence — neurosurgery note generator and billing engine.
Date: ${TODAY}
Surgeon: ${state.sn||"Diaz"}
RULES:
- NEVER fabricate. DRAFT only. THOROUGH.
- NO patient demographics. NO ** bold. CAPS WITH COLONS for headers.
- NO blanks, underscores, or square brackets.
- NEVER output placeholder text: *EXAM NEEDED*, **fill in here**, [fill in], {description}, or any template artifact. If data is missing, generate clinically appropriate ***ASSUMED*** content instead.
- Assumed: ***ASSUMED*** prefix. Missing implants: ***IMPLANT*** prefix. Added: ***ADDED*** prefix.
- NEVER mark dates or today's date as ***ASSUMED***. Only mark clinical assumptions.
- NEVER invent patient occupation, employer, specific activities, hobbies, or lifestyle details not stated in dictation. Only assume CLINICAL details (exam findings, durations, dates).
- NEVER fabricate specific calendar dates for treatments. Use "per patient report" instead of invented dates.
- NEVER put billing codes/CPT/RVU in the clinical note body. Billing goes ONLY in separate billing analysis.
- First line = clinical content. No preamble.
- OPERATIVE NOTES must include "SURGEON: ${state.sn||"Diaz"}" and "ASSISTANTS: None" (unless specified).
- OPERATIVE NOTES ONLY: include "ATTENDING: ${state.sn||"Diaz"}". Do NOT include ATTENDING/SURGEON in clinic/consult/progress/critical.
QUESTIONS (max 3, only if changes PRIMARY CPT):
Q: [question]
DEFAULT: [assumption]
---
Then ALWAYS produce complete note.
MDM COMPLEXITY LINE (non-operative): first line = single sentence.
MEDICOLEGAL (OPERATIVE): TIME OUT, CONSENT in INDICATIONS, ANTIBIOTICS, NEUROMONITORING (ONLY if mentioned), COUNTS x2, SPECIMEN, TOTAL OPERATIVE TIME.
OPERATIVE STRUCTURE: PREOP DX, POSTOP DX, PROCEDURE, INDICATIONS, ANESTHESIA, ANTIBIOTICS, POSITION, TIME OUT, NEUROMONITORING, TECHNIQUE, TOTAL OPERATIVE TIME, IMPLANTS, EBL, COMPLICATIONS, DRAINS, SPECIMENS, COUNTS, CLOSURE, DISPOSITION
NEUROCHECK FREQ: Complex=q1h x4h then q2h x8h then q4h. Standard=q2h x8h then q4h. Single level=q4h. Critical=q1h continuous. Clinic=No neurochecks.
OPERATIVE NOTE PHYSICAL EXAM RULES:
- ALL operative notes MUST include a filled PHYSICAL EXAMINATION section. NEVER leave *EXAM NEEDED*, **fill in here**, [fill in], or any placeholder/template text.
- If dictation includes exam findings, use them exactly.
- If dictation has NO exam or PARTIAL exam, auto-fill a complete, clinically appropriate exam with ***ASSUMED*** markers based on the procedure and diagnosis:
  PHYSICAL EXAMINATION:
    General: Alert, oriented, in no acute distress. ***ASSUMED***
    Neurological (procedure-appropriate):
    - Lumbar procedures → Pre-operative motor: 5/5 bilateral lower extremities (hip flexors, quadriceps, tibialis anterior, EHL, gastrocnemius). Sensory: Intact to light touch L2-S1 dermatomes bilaterally. Reflexes: 2+ patellar, 2+ Achilles bilaterally. ***ASSUMED***
    - Cervical procedures → Pre-operative motor: 5/5 bilateral upper extremities (deltoids, biceps, triceps, wrist extensors, grip, finger abduction). Reflexes: 2+ biceps, triceps, brachioradialis bilaterally. ***ASSUMED***
    - If HPI or indication mentions weakness/deficit, adjust assumed exam to match: e.g. "Left EHL 4/5 ***ASSUMED FROM HPI***, right 5/5"
- NEVER output template artifacts: any text in curly braces, "EXAM NEEDED", "fill in", "[blank]", or instruction text must be replaced with appropriate assumed findings.
- The assumed exam goes BEFORE the TECHNIQUE section.
CLINIC NOTE RULES:
- MANDATORY FIRST LINE for ALL clinic notes: "[NEW/ESTABLISHED] PATIENT — [COMPLEXITY] COMPLEXITY"
  Examples: "NEW PATIENT — MODERATE COMPLEXITY"
            "ESTABLISHED PATIENT — HIGH COMPLEXITY"
            "ESTABLISHED PATIENT — POST-OPERATIVE — MODERATE COMPLEXITY"
  Determine NEW vs ESTABLISHED from clinicPt input. Include POST-OPERATIVE if visit type is postop.
  COMPLEXITY IS DETERMINED BY MDM RISK — use these EXACT rules:
    - Note recommends ANY surgery → RISK=HIGH → at minimum MODERATE COMPLEXITY (99204/99214)
    - Note recommends surgery AND patient has motor deficit, myelopathy, or progressive neuro deficit → HIGH COMPLEXITY (99205/99215)
    - Follow-up, stable, no med changes → LOW COMPLEXITY (99213)
    - Post-op routine check → LOW or MODERATE COMPLEXITY
  This header replaces any other opening line. The MDM summary sentence goes on the SECOND line.
- MANDATORY PHYSICAL EXAM: ALL clinic notes MUST include a PHYSICAL EXAMINATION section. This is NON-NEGOTIABLE.
  If the input contains exam findings, use them exactly. If input has NO physical exam data or PARTIAL exam data, auto-fill with clinically appropriate ASSUMED NORMAL defaults marked ***ASSUMED***. Generate a COMPLETE exam — never leave blank markers.
  PHYSICAL EXAMINATION:
    General: Alert, oriented, no acute distress. ***ASSUMED***
    Spine: No visible deformity. Mild tenderness to palpation at [relevant level from imaging]. Range of motion limited by pain. ***ASSUMED***
  Then add NEUROLOGICAL exam elements SPECIFIC to the complaint with assumed normals:
    - Lumbar complaint → Motor: 5/5 bilateral lower extremities (hip flexors, quadriceps, tibialis anterior, EHL, gastrocnemius) ***ASSUMED***, Sensory: Intact to light touch L2-S1 dermatomes bilaterally ***ASSUMED***, Reflexes: Patellar 2+ bilaterally, Achilles 2+ bilaterally ***ASSUMED***, SLR: Negative bilaterally ***ASSUMED***
    - Cervical complaint → Motor: 5/5 bilateral upper extremities (deltoids, biceps, triceps, wrist extensors, grip, intrinsics) ***ASSUMED***, Reflexes: Biceps 2+, triceps 2+, brachioradialis 2+ bilaterally ***ASSUMED***, Hoffmann: Negative bilaterally ***ASSUMED***, Spurling: Negative bilaterally ***ASSUMED***
    - Bowel/bladder symptoms or cauda equina concern → DO NOT assume normal. Use: Rectal tone: ***NOT EXAMINED — DOCUMENT***, Perianal sensation: ***NOT EXAMINED — DOCUMENT***, Post-void residual: ***NOT EXAMINED — DOCUMENT***
    - Myelopathy concern → DO NOT assume normal. Use: Gait: ***NOT EXAMINED — DOCUMENT***, Hoffmann: ***NOT EXAMINED — DOCUMENT***, Babinski: ***NOT EXAMINED — DOCUMENT***, Clonus: ***NOT EXAMINED — DOCUMENT***
    - If findings in HPI suggest abnormality (e.g. patient reports left leg weakness), adjust the assumed exam to MATCH: e.g. "Left tibialis anterior 4/5 ***ASSUMED FROM HPI***, right 5/5"
  CRITICAL: For cauda equina red flags and myelopathy signs, NEVER auto-fill normals — these require actual examination. Use ***NOT EXAMINED — DOCUMENT*** instead.
  The Q: section should ask about exam findings that were assumed, especially any abnormals.
- TEMPLATE ARTIFACT HANDLING: If input contains text in curly braces like {description}, instruction-style text like "if mentioned", "as stated by", "as discussed", or section descriptions rather than actual clinical data, treat these as EMPTY — the data was NOT collected. Do NOT interpret template instructions as clinical findings. Do NOT fabricate values for unfilled template fields.
- Do NOT ask Q:/DEFAULT: about EBL, blood loss, neuromonitoring, or any operative details. These are irrelevant to clinic visits.
- Do NOT include a NEUROCHECK or DISPOSITION neurocheck line. Just return precautions.
- Do NOT invent patient occupation, hobbies, or specific activities not mentioned in dictation.
- NEVER fabricate specific dates for treatments. If dates not given, say "per patient" not invented dates.
- Focus Q:/DEFAULT: on: duration of conservative treatments, imaging date, and follow-up interval ONLY.
- Include REVIEW OF SYSTEMS in all clinic notes. If not dictated, use: "ROS: Positive for [relevant symptoms from HPI]. Negative for bowel/bladder dysfunction, fever, chills, night sweats, unexplained weight loss, bilateral symptoms, chest pain, shortness of breath."
- Include PAST MEDICAL/SURGICAL HISTORY. If not dictated: "PMH: Per chart review" not "ASSUMED unremarkable".
- Include FAMILY HISTORY if new patient. If not dictated: "FAMILY HISTORY: Noncontributory"
- Include SOCIAL HISTORY if new patient. If not dictated: "SOCIAL HISTORY: Per chart review. Smoking status documented."
CODE-SPECIFIC:
1. REGION from UPPERMOST level: C=22600, T=22610, L=22612. 22614=each additional.
2. SEGMENTS=vertebrae minus 1. Instrumentation: 22840(1-2), 22842(3-6), 22843(7-12), 22844(13+).
3. OSTEOTOMY: 1-column=22210/22212/22214. 3-column=22206(T)/22207(L).
4. GRAFTS: 20930=morselized allograft, 20931=structural, 20936=local autograft.
5. No hallucinate codes. Only bill what's EXPLICITLY described.
6. NAVIGATION: 61783=SPINAL, 61782=cranial only.
7. DECOMPRESSION: 63047/63048=standard. 63052/63053=transpedicular (with PSO).
8. NO DOUBLE-BILLING: 22633/22634 vs 22612/22614+22853/22854 MUTUALLY EXCLUSIVE.
9. NO DUPLICATES: Same CPT once only (except per-level add-ons with xN).
ANTERIOR CERVICAL: 22551/22552, 22845, 20931(structural), 20936(COMMONLY MISSED). Discectomy BUNDLED.
POSTERIOR CERVICAL: 22600(first), 22614(ea add'l), 22842/22843(instrumentation), 20936, 20930.
TLIF SINGLE: 22612+22853+22840+63047+20936+20930.
KYPHOPLASTY: 22513(T)/22514(L), 20251-59(biopsy).
LAMINECTOMY: 63047(first), 63048(ea add'l).
PRE-AUTHORIZATION (CLINIC NOTES recommending surgery):
PRE-AUTHORIZATION:
- Recommended procedure with CPT
- Medical necessity: specific failed treatments WITH DATES
- Imaging findings
- Required pre-op items
- Denial risk factors`;}
const P1END='\n\nProduce the note. Q:/DEFAULT: first, then full note after NOTE:. All medicolegal for operative. ***ASSUMED***/***IMPLANT*** markers. PRE-AUTHORIZATION for clinic notes recommending surgery.';
const P2=`Billing analysis. SPECIFIC, GRANULAR, MAXIMALLY AGGRESSIVE within defensible bounds.

E/M MDM SCORING — MANDATORY RULES (DO NOT OVERRIDE WITH CLINICAL JUDGMENT):
The E/M level is determined by the HIGHEST 2 of 3 MDM elements. Use this exact matrix:

RISK OF COMPLICATIONS (determines RISK element):
- HIGH: Decision for major surgery (ANY spine surgery = major), drug requiring intensive monitoring, decision for hospitalization, decision for DNR
- MODERATE: Prescription drug management, minor surgery decision, diagnostic test with sedation
- LOW: OTC meds, rest, PT referral
- MINIMAL: Self-limited problem

IF THE NOTE RECOMMENDS SURGERY → RISK = HIGH. ALWAYS. No exceptions. This is not debatable.

NUMBER/COMPLEXITY OF PROBLEMS:
- HIGH: Acute illness with threat to bodily function (motor deficit, myelopathy, cauda equina, progressive neuro deficit)
- MODERATE: New problem requiring workup (new radiculopathy, new herniation), chronic illness with mild exacerbation
- LOW: 2+ self-limited problems, 1 stable chronic illness

DATA REVIEWED:
- HIGH: Independent interpretation of imaging + discussion with external physician OR ordering tests
- MODERATE: Independent interpretation of imaging (surgeon personally reviewing MRI = moderate)
- LOW: Review of prior external notes/records
- MINIMAL: Ordering a test only

SCORING:
- 99205/99215: 2 of 3 elements at HIGH
- 99204/99214: 2 of 3 elements at MODERATE (or 1 HIGH + 1 MODERATE)
- 99203/99213: 2 of 3 elements at LOW
- New patient: 99202-99205. Established: 99211-99215. Consult: 99252-99255.

EXAMPLES:
- Clinic note recommending ACDF → Risk=HIGH (surgery), Problems=MODERATE (new radiculopathy), Data=MODERATE (MRI review) → 99204 minimum. If motor deficit → Problems=HIGH → 99205.
- Follow-up stable post-op → Risk=LOW, Problems=LOW → 99213
- New myelopathy patient with motor deficit recommending surgery → Risk=HIGH, Problems=HIGH, Data=MODERATE → 99205

MANDATORY:
1. NEVER list same CPT twice (add-ons get xN).
2. 22633/22634 and 22612/22614+22853/22854 MUTUALLY EXCLUSIVE.
3. Navigation: 61783 for SPINE.
4. PSO decompression=63052/63053.
5. No 69990 without explicit microscope.
FORMAT:
E/M MDM SCORING:
-RISK: [HIGH/MODERATE/LOW/MINIMAL] ([justification])
-PROBLEMS: [HIGH/MODERATE/LOW/MINIMAL] ([justification])
-DATA: [HIGH/MODERATE/LOW/MINIMAL] ([justification])
→ [scoring summary] = [E/M code] ([new/established])
CODES:
[CODE - Description (X.X RVU) CONFIDENCE]
MODIFIERS: [with justification]
ICD-10: [one per line]
ICD-10 ACCURACY RULES:
- Lumbar radiculopathy = M54.41 (left), M54.42 (right), M54.40 (unspecified)
- Cervical radiculopathy = M54.12 (cervical), M54.13 (cervicothoracic)
- Lumbar disc herniation with radiculopathy = M51.16 (lumbar), M51.17 (lumbosacral)
- Cervical disc herniation with radiculopathy = M50.12 (mid-cervical), M50.13 (cervicothoracic)
- Cervical myelopathy = M47.12 (with myelopathy, cervical)
- Lumbar stenosis = M48.06 (lumbar), M48.07 (lumbosacral)
- Cervical stenosis = M48.02 (cervical)
- Spondylolisthesis = M43.16 (lumbar), M43.12 (cervical)
- NEVER use M25.5xx (joint pain) for radicular leg pain. Use M79.604 (left leg) or M79.601 (right leg) only if needed.
- NEVER use M79.2 for radiculopathy. Use M54.4x codes.
BUNDLING: [notes]
GAPS:
CLINIC NOTE PHYSICAL EXAM VALIDATION (MANDATORY for clinic/consult notes):
- If note has NO PHYSICAL EXAMINATION section → ALWAYS flag as HIGH gap
- If note has PE but NO neurological exam (motor, sensory, reflexes) → flag as HIGH gap for spine patients
- If note has bowel/bladder complaints + ***NOT EXAMINED — DOCUMENT*** for rectal tone/perianal → flag as RED FLAG for cauda equina screening with urgent incorporate language
- If ***ASSUMED*** markers present → flag as MED gap: "Physical exam auto-filled — verify findings match your examination"
- If ***ASSUMED FROM HPI*** markers present → flag as MED gap: "Exam finding inferred from history — confirm on examination"
- If ***NOT EXAMINED — DOCUMENT*** markers present → flag as HIGH gap with specific incorporate language for each
- These PE gaps take PRIORITY over billing optimization gaps
IMPACT: HIGH/MED/LOW
ISSUE: [missing] — [CPT] ([+X.X RVU])
LANGUAGE: [exact text]
---
FLAGS:
RED/YELLOW/GREEN: [issue]
FINANCIAL:
TOTAL RVU: [#]
CURRENT ESTIMATE: $[range]
WITH GAPS FILLED: $[range]
CAPTURE RATE: [%]`;

const SMART_QS={critical:[{q:"Total critical care time?",def:"45 minutes"}],operative:[{q:"Estimated blood loss?",def:"Minimal"},{q:"Was neuromonitoring used?",def:"No neuromonitoring utilized"}],clinic:[],consult:[],progress:[]};

// ---- STATE ----
let state={
  view:"input",text:"",nt:new Date().getDay()===5?"operative":"clinic",clinicVisit:"new",clinicPt:"new",
  noteText:"",billRaw:"",gaps:[],flags:[],financial:null,
  billCodes:"",billMod:"",billICD:"",billBundle:"",billPreauth:"",billMDM:"",
  workup:[],wuChecked:{},questions:[],qEdits:{},convo:[],phase:"",err:null,
  cases:ls(SK,[]),selCase:null,addend:"",caseTab:"all",
  wk:ls("opnote-wkey",""),ce:ls("opnote-email",""),sn:ls("opnote-surgeon","Diaz"),
  showSettings:false,editing:false,editText:"",_gc:{},_qc:{},
  billingValidation:null,levelUpResult:null,verifyItems:null,verifyCorrected:"",verifyRVU:"",
  tStart:null,tNote:null,tCopy:null,linkedTo:null,detailNoteIdx:0,detailAddendText:"",_draftId:null
};
function setState(p){Object.assign(state,p);render();}

// ---- EXPORT/IMPORT ----
function exportCases(){const d=JSON.stringify(ls(SK,[]),null,2);const blob=new Blob([d],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="opnote-backup-"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(a.href);}
function importCases(f){if(!f)return;const r=new FileReader();r.onload=e=>{try{const imp=JSON.parse(e.target.result);if(!Array.isArray(imp)){alert("Invalid");return;}const cur=ls(SK,[]);const ids=new Set(cur.map(c=>c.id));let n=0;imp.forEach(c=>{if(c.id&&!ids.has(c.id)){cur.push(c);ids.add(c.id);n++;}});cur.sort((a,b)=>(b.ts||"").localeCompare(a.ts||""));lsS(SK,cur);setState({cases:cur});syncPush().catch(()=>{});alert(n+" imported");}catch{alert("Import error");}};r.readAsText(f);}
function pickImport(){const inp=document.createElement("input");inp.type="file";inp.accept=".json";inp.onchange=()=>{if(inp.files[0])importCases(inp.files[0]);};inp.click();}

// ---- QUICK CAPTURE (phone → draft → desktop finishes) ----
let captureQueue=[];let captureActive=false;let captureErr="";let lastDraftId=null;

async function ocrImage(file){
  let b64,mt=file.type||"image/jpeg";
  if(file.size>4*1024*1024){b64=await resizeImage(file);mt="image/jpeg";}
  else{b64=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(",")[1]);r.onerror=rej;r.readAsDataURL(file);});}
  const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2048,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mt,data:b64}},{type:"text",text:IMG_PROMPT}]}]})});
  if(!res.ok)throw new Error("API "+res.status);
  const data=await res.json();return data.content.map(c=>c.type==="text"?c.text:"").join("");
}

function quickCapture(){
  if(!API_KEY){setState({err:"Add API key in Settings."});return;}
  captureErr="";lastDraftId=null;
  const inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.multiple=true;
  inp.onchange=async()=>{
    if(!inp.files||!inp.files.length)return;
    setState({phase:"image",err:null});
    captureActive=true;render();
    try{
      const texts=[];
      for(let i=0;i<inp.files.length;i++){
        captureErr="Analyzing "+(i+1)+" of "+inp.files.length+"...";render();
        const txt=await ocrImage(inp.files[i]);
        if(txt)texts.push(txt);
      }
      if(!texts.length)throw new Error("No text extracted from image(s).");
      const combined=texts.join("\n\n---PAGE BREAK---\n\n");
      const txtLow=combined.toLowerCase();
      let label="📸 Capture";
      if(txtLow.includes("mri")||txtLow.includes("impression")||txtLow.includes("findings"))label="📸 MRI/Imaging";
      else if(txtLow.includes("physical therapy")||txtLow.includes("pt note"))label="📸 PT Notes";
      else if(txtLow.includes("medication")||txtLow.includes("prescription"))label="📸 Medications";
      else if(txtLow.includes("lab")||txtLow.includes("result")||txtLow.includes("cotinine"))label="📸 Lab Results";
      if(texts.length>1)label+=" ("+texts.length+" pages)";
      const draftId=Date.now().toString(36)+Math.random().toString(36).slice(2,4);
      const draft={
        id:draftId,
        ts:new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),
        date:new Date().toLocaleDateString("en-US",{month:"short",day:"numeric"}),
        proc:label,cat:"Draft",draft:true,
        capturedText:combined,dict:"",note:"",billRaw:"",notes:[]
      };
      const cases=[draft,...state.cases].slice(0,200);
      lsS(SK,cases);
      lastDraftId=draftId;captureActive=false;captureErr="";
      setState({cases,phase:"",err:null,view:"cases",caseTab:"all"});
      syncPush().catch(()=>{});
    }catch(e){captureActive=false;captureErr="";setState({err:"Capture: "+e.message,phase:""});}
  };
  inp.style.cssText="position:fixed;top:-9999px;left:-9999px;opacity:0";
  document.body.appendChild(inp);
  setTimeout(()=>{inp.click();},100);
  setTimeout(()=>{try{inp.remove();}catch{}},120000);
}

function addPageToDraft(draftId){
  const inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.multiple=true;
  inp.onchange=async()=>{
    if(!inp.files||!inp.files.length)return;
    setState({phase:"image",err:null});
    try{
      const texts=[];
      for(let i=0;i<inp.files.length;i++){
        const txt=await ocrImage(inp.files[i]);
        if(txt)texts.push(txt);
      }
      if(!texts.length)throw new Error("No text extracted.");
      const cases=state.cases.map(c=>{
        if(c.id!==draftId)return c;
        return{...c,capturedText:(c.capturedText||"")+"\n\n---PAGE BREAK---\n\n"+texts.join("\n\n---PAGE BREAK---\n\n"),proc:c.proc.replace(/\(\d+ pages?\)/,"")+"("+((c.capturedText||"").split("---PAGE BREAK---").length+texts.length)+" pages)"};
      });
      lsS(SK,cases);setState({cases,phase:""});syncPush().catch(()=>{});
    }catch(e){setState({err:"Add page: "+e.message,phase:""});}
  };
  inp.style.cssText="position:fixed;top:-9999px;left:-9999px;opacity:0";
  document.body.appendChild(inp);
  setTimeout(()=>{inp.click();},100);
  setTimeout(()=>{try{inp.remove();}catch{}},120000);
}

function openDraft(caseId){
  const c=state.cases.find(x=>x.id===caseId);if(!c||!c.draft)return;
  setState({
    view:"input",
    text:c.capturedText||"",
    nt:"clinic",
    _draftId:caseId
  });
}

function processDraftAsCase(){
  // When processing a draft, remove the draft and let processCase create the real case
  if(state._draftId){
    const cases=state.cases.filter(c=>c.id!==state._draftId);
    lsS(SK,cases);
    setState({cases,_draftId:null});
  }
  processCase();
}
function deleteCase(id){const cases=state.cases.filter(c=>c.id!==id);lsS(SK,cases);setState({cases,selCase:null,view:"cases"});syncPush().catch(()=>{});}

function reopenCase(caseId,noteIdx){
  const c=state.cases.find(x=>x.id===caseId);if(!c)return;
  const notes=c.notes||[{type:c.cat==="Operative"?"operative":"clinic",note:c.note||"",billRaw:c.billRaw||"",dict:c.dict||""}];
  const ni=Math.min(noteIdx||0,notes.length-1);
  const dn=notes[ni];
  const sec=parseBillFull(dn.billRaw||"");
  const bv=validateBilling(sec.codes,dn.note);
  setState({
    view:"output",noteText:dn.note||"",billRaw:dn.billRaw||"",
    billCodes:sec.codes,billMod:sec.modifiers,billICD:sec.icd,billBundle:sec.bundling,billPreauth:sec.preauth,billMDM:sec.mdm,
    gaps:parseGaps(sec.gaps),flags:parseFlags(sec.flags),financial:parseFinancial(sec.financial),
    billingValidation:bv,nt:dn.type||"operative",text:dn.dict||"",
    convo:[{role:"user",content:"DICTATION:\n\n"+(dn.dict||"")},{role:"assistant",content:dn.note||""}],
    _sysPrompt:getSYS()+"\nNOTE TYPE: "+(TYPES[dn.type]?.l||dn.type)+P1END,
    phase:"done",editing:false,addend:"",questions:[],workup:[],
    _reopenedCase:caseId,_reopenedNoteIdx:ni,
    tStart:null,tNote:null,tCopy:null,levelUpResult:null,verifyItems:null
  });
}

async function detailAddend(caseId,noteIdx,text,target){
  if(!text.trim()||!API_KEY)return;
  const c=state.cases.find(x=>x.id===caseId);if(!c)return;
  const notes=c.notes||[{type:c.cat==="Operative"?"operative":"clinic",note:c.note||"",billRaw:c.billRaw||"",dict:c.dict||""}];
  const ni=Math.min(noteIdx||0,notes.length-1);
  const dn=notes[ni];
  setState({phase:"addend"});
  try{
    const sysPrompt=getSYS()+"\nNOTE TYPE: "+(TYPES[dn.type]?.l||dn.type)+P1END;
    const tLabels={hpi:"Add to HPI section",ap:"Add to ASSESSMENT AND PLAN",exam:"Add to EXAM section",note:"Add to appropriate section"};
    const msgs=[{role:"user",content:"DICTATION:\n\n"+(dn.dict||"")},{role:"assistant",content:dn.note}];
    const prompt=(tLabels[target]||tLabels.note)+". Mark ***ADDED***.\n\n"+text.trim()+INC_SUFFIX;
    const{txt}=await callC([...msgs,{role:"user",content:prompt}],2,sysPrompt);
    const{note:raw}=parseWorkup(txt.replace(/^[\n]*NOTE:\s*\n?/i,"").trim());
    const updated=dedupNote(stripBilling(raw))||dn.note;
    // Save back
    const updatedCases=state.cases.map(cc=>{
      if(cc.id!==caseId)return cc;
      const updatedNotes=[...(cc.notes||notes)];
      updatedNotes[ni]={...updatedNotes[ni],note:updated};
      return{...cc,notes:updatedNotes};
    });
    lsS(SK,updatedCases);
    setState({cases:updatedCases,selCase:updatedCases.find(x=>x.id===caseId),phase:"done",detailAddendText:""});
    syncPush().catch(()=>{});
  }catch(e){setState({err:"Update failed: "+e.message,phase:"done"});}
}

async function detailImageAnalyze(caseId,noteIdx,file){
  if(!file||!API_KEY)return;
  setState({phase:"image"});
  try{
    let b64,mt=file.type||"image/jpeg";
    if(file.size>4*1024*1024){b64=await resizeImage(file);mt="image/jpeg";}
    else{b64=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(",")[1]);r.onerror=rej;r.readAsDataURL(file);});}
    const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2048,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mt,data:b64}},{type:"text",text:IMG_PROMPT}]}]})});
    if(!res.ok)throw new Error("API "+res.status);
    const data=await res.json();const txt=data.content.map(c=>c.type==="text"?c.text:"").join("");
    setState({phase:"done",detailAddendText:(state.detailAddendText||"")+"\n"+txt});
  }catch(e){setState({err:"Image: "+e.message,phase:"done"});}
}
function pickDetailImage(caseId,noteIdx){const inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.onchange=()=>{if(inp.files[0])detailImageAnalyze(caseId,noteIdx,inp.files[0]);};inp.style.cssText="position:fixed;top:-9999px;left:-9999px;opacity:0";document.body.appendChild(inp);setTimeout(()=>{inp.click();},100);setTimeout(()=>{try{inp.remove();}catch{}},120000);}

// ---- GITHUB GIST SYNC ----
const GIST_TOKEN_KEY="opnote-gh-token";
const GIST_ID_KEY="opnote-gist-id";
const GIST_FILE="opnote-cases.json";
let ghToken=localStorage.getItem(GIST_TOKEN_KEY)||"";
let gistId=localStorage.getItem(GIST_ID_KEY)||"";
let syncStatus="";let lastSync=localStorage.getItem("opnote-last-sync")||"";

async function gistAPI(method,url,body){
  const opts={method,headers:{"Authorization":"Bearer "+ghToken,"Accept":"application/vnd.github+json","X-GitHub-Api-Version":"2022-11-28"}};
  if(body){opts.headers["Content-Type"]="application/json";opts.body=JSON.stringify(body);}
  const r=await fetch(url,opts);
  if(!r.ok){const t=await r.text();throw new Error("GitHub "+r.status+": "+t.slice(0,200));}
  return r.json();
}

function mergeCases(local,remote){
  const map=new Map();
  remote.forEach(c=>{if(c.id)map.set(c.id,c);});
  local.forEach(c=>{if(!c.id)return;const existing=map.get(c.id);if(!existing){map.set(c.id,c);}else{
    const lt=c.ts||c.date||"";const rt=existing.ts||existing.date||"";
    const lNotes=(c.notes||[]).length;const rNotes=(existing.notes||[]).length;
    if(lNotes>rNotes||lt>rt)map.set(c.id,c);
  }});
  return[...map.values()].sort((a,b)=>(b.ts||"").localeCompare(a.ts||""));
}

async function syncPull(){
  if(!ghToken)return;
  syncStatus="pulling";render();
  try{
    if(!gistId){
      const gists=await gistAPI("GET","https://api.github.com/gists?per_page=100");
      const found=gists.find(g=>g.files&&g.files[GIST_FILE]);
      if(found){gistId=found.id;localStorage.setItem(GIST_ID_KEY,gistId);}
      else{syncStatus="";render();return;}
    }
    const g=await gistAPI("GET","https://api.github.com/gists/"+gistId);
    const raw=g.files?.[GIST_FILE]?.content;
    if(!raw){syncStatus="";render();return;}
    const remote=JSON.parse(raw);
    if(!Array.isArray(remote)){syncStatus="";render();return;}
    const local=ls(SK,[]);
    const merged=mergeCases(local,remote);
    lsS(SK,merged);
    lastSync=new Date().toLocaleTimeString();localStorage.setItem("opnote-last-sync",lastSync);
    syncStatus="done";setState({cases:merged});
    setTimeout(()=>{syncStatus="";render();},3000);
  }catch(e){syncStatus="err:"+e.message;render();}
}

async function syncPush(){
  if(!ghToken)return;
  const data=JSON.stringify(ls(SK,[]),null,2);
  const body={files:{[GIST_FILE]:{content:data}}};
  if(!gistId){
    body.description="OpNote Intelligence case sync";body.public=false;
    const g=await gistAPI("POST","https://api.github.com/gists",body);
    gistId=g.id;localStorage.setItem(GIST_ID_KEY,gistId);
  }else{
    await gistAPI("PATCH","https://api.github.com/gists/"+gistId,body);
  }
  lastSync=new Date().toLocaleTimeString();localStorage.setItem("opnote-last-sync",lastSync);
}

async function syncFull(){
  if(!ghToken){alert("Add GitHub token in Settings.");return;}
  syncStatus="syncing";render();
  try{
    await syncPull();
    await syncPush();
    lastSync=new Date().toLocaleTimeString();localStorage.setItem("opnote-last-sync",lastSync);
    syncStatus="done";render();
    setTimeout(()=>{syncStatus="";render();},3000);
  }catch(e){syncStatus="err:"+e.message;render();}
}

// Auto-sync on load
setTimeout(()=>{if(ghToken)syncPull().catch(()=>{});},1000);

// ---- MAIN PROCESS ----
async function processCase(){
  let{text,nt}=state;if(!text.trim())return;
  if(!API_KEY){setState({err:"Add API key in Settings."});return;}
  const tStart=Date.now();
  setState({err:null,noteText:"",billRaw:"",billCodes:"",billMod:"",billICD:"",billBundle:"",billPreauth:"",billMDM:"",gaps:[],flags:[],financial:null,workup:[],wuChecked:{},questions:[],qEdits:{},addend:"",editing:false,view:"output",phase:"note",_gc:{},tStart,tNote:null,tCopy:null,billingValidation:null,levelUpResult:null});
  try{
    let clinicCtx="";
    if(nt==="clinic"){const vLabels={new:"NEW VISIT",followup:"FOLLOW-UP VISIT",postop:"POST-OPERATIVE VISIT"};clinicCtx="\nVISIT TYPE: "+(vLabels[state.clinicVisit]||"NEW VISIT")+"\nPATIENT: "+(state.clinicPt==="established"?"ESTABLISHED":"NEW");}
    const sysPrompt=getSYS()+"\nNOTE TYPE: "+(TYPES[nt]?.l||nt)+clinicCtx+P1END;
    const{txt:noteRaw,msgs}=await callC([{role:"user",content:"DICTATION:\n\n"+text.trim()}],3,sysPrompt);
    if(!noteRaw.trim())throw new Error("Empty response");
    const{questions,note:rN}=parseQuestions(noteRaw);
    const{note:rawNote,wu}=parseWorkup(rN);
    const note=stripBilling(rawNote);
    if(!note.trim())throw new Error("Note failed — add more detail.");
    const tNote=Date.now();
    const smartQs=(SMART_QS[nt]||[]).filter(sq=>!questions.some(q=>q.q.toLowerCase().includes(sq.q.split(" ").slice(0,3).join(" ").toLowerCase())));
    setState({noteText:note,workup:wu,questions:[...questions,...smartQs.map(sq=>({q:sq.q,def:sq.def}))],convo:msgs,phase:"billing",tNote,_sysPrompt:sysPrompt});
    try{
      const{txt:bRaw}=await callC([...msgs,{role:"assistant",content:noteRaw},{role:"user",content:P2}],2,sysPrompt);
      const sec=parseBillFull(bRaw);
      const updNote=injectMDM(state.noteText,sec.codes,state.nt);
      if(updNote!==state.noteText)state.noteText=updNote;
      const bv=validateBilling(sec.codes,state.noteText);
      setState({billRaw:bRaw,billCodes:sec.codes,billMod:sec.modifiers,billICD:sec.icd,billBundle:sec.bundling,billPreauth:sec.preauth,billMDM:sec.mdm,gaps:parseGaps(sec.gaps),flags:parseFlags(sec.flags),financial:parseFinancial(sec.financial),billingValidation:bv,phase:"done"});
    }catch(be){setState({err:"Billing failed: "+be.message,phase:"done"});}
    // Save case
    const pm=note.match(/PROCEDURE[^:]*:\s*([^\n]+)/i)||note.match(/ASSESSMENT[^:]*:\s*([^\n]+)/i);
    const proc=pm?pm[1].slice(0,70).trim():"Case";
    const noteEntry={type:nt,ts:new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),note:note,billRaw:state.billRaw||"",dict:text};
    if(state.linkedTo){
      const cases=state.cases.map(c=>{if(c.id!==state.linkedTo)return c;const notes=c.notes?[...c.notes]:[{type:typeCat(c.cat)==="Operative"?"operative":"clinic",note:c.note||"",billRaw:c.billRaw||"",dict:c.dict||""}];notes.push(noteEntry);return{...c,notes};});
      lsS(SK,cases);setState({cases});syncPush().catch(()=>{});
    }else{
      const entry={id:Date.now().toString(36)+Math.random().toString(36).slice(2,4),ts:new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),date:new Date().toLocaleDateString("en-US",{month:"short",day:"numeric"}),proc,cat:typeCat(nt),dict:text,note:note,billRaw:state.billRaw||"",notes:[noteEntry]};
      const cases=[entry,...state.cases].slice(0,200);lsS(SK,cases);setState({cases});syncPush().catch(()=>{});
    }
  }catch(e){setState({err:e.message,phase:""});}
}

// ---- INCORPORATE / ADDEND ----
async function incorporate(userPrompt,phase){
  setState({phase:phase||"incorporate",err:null});
  try{const msgs=[...state.convo,{role:"assistant",content:state.noteText},{role:"user",content:userPrompt+INC_SUFFIX}];const{txt}=await callC(msgs,2,state._sysPrompt);const{note:raw}=parseWorkup(txt.replace(/^[\n]*NOTE:\s*\n?/i,"").trim());const note=dedupNote(stripBilling(raw));return{note:note||state.noteText,msgs};}catch(e){setState({err:e.message,phase:"done"});return null;}
}
async function useQBatch(){
  const checked=state.questions.map((q,i)=>({q:q.q,val:(state.qEdits[i]!==undefined?state.qEdits[i]:q.def).trim(),idx:i,checked:state._qc[i]!==false})).filter(x=>x.val&&x.checked);
  if(!checked.length)return;
  const answers=checked.map((c,i)=>(i+1)+". "+c.q+"\n   Answer: "+c.val).join("\n\n");
  const r=await incorporate("Incorporate ALL answers. Regenerate COMPLETE note. Mark ***ADDED***.\n\n"+answers,"addend");
  if(r){const usedIdx=new Set(checked.map(c=>c.idx));setState({noteText:r.note,convo:r.msgs,questions:state.questions.filter((_,i)=>!usedIdx.has(i)),qEdits:{},_qc:{},phase:"done"});}
}
async function incGap(idx){const g=state.gaps[idx];if(!g)return;const r=await incorporate("Add to appropriate section. Mark ***ADDED***.\n\n"+(g.language||g.issue));if(r){const nG=[...state.gaps];nG.splice(idx,1);setState({noteText:r.note,convo:r.msgs,gaps:nG,_gc:{},phase:"done"});}}
async function incGapHPI(idx){const g=state.gaps[idx];if(!g)return;const r=await incorporate("Add SPECIFICALLY TO HPI section. Mark ***ADDED***.\n\n"+(g.language||g.issue));if(r){const nG=[...state.gaps];nG.splice(idx,1);setState({noteText:r.note,convo:r.msgs,gaps:nG,_gc:{},phase:"done"});}}
async function doAddendTarget(target){
  if(!state.addend.trim())return;
  const tLabels={hpi:"Add to HPI section",ap:"Add to ASSESSMENT AND PLAN",exam:"Add to EXAM section",note:"Add to appropriate section"};
  const r=await incorporate((tLabels[target]||tLabels.note)+". Mark ***ADDED***.\n\n"+state.addend.trim(),"addend");
  if(r)setState({noteText:r.note,convo:r.msgs,addend:"",phase:"done"});
}
async function incSelGaps(){const sel=state.gaps.filter((_,i)=>state._gc[i]);if(!sel.length)return;const langs=sel.map((g,i)=>(i+1)+". "+(g.language||g.issue)).join("\n\n");const r=await incorporate("Incorporate ALL. Mark ***ADDED***.\n\n"+langs);if(r)setState({noteText:r.note,convo:r.msgs,gaps:state.gaps.filter((_,i)=>!state._gc[i]),_gc:{},phase:"done"});}
async function incFlag(idx){const f=state.flags[idx];if(!f)return;const prompt=f.input?"Flag CONFIRMED. Incorporate. Mark ***ADDED***.\n\nFLAG: "+f.text+"\nACTION: "+f.input:"Flag CONFIRMED. Add documentation. Mark ***ADDED***.\n\nFLAG: "+f.text;const r=await incorporate(prompt);if(r){const nF=[...state.flags];nF[idx]={...nF[idx],type:"GREEN",text:nF[idx].text+" — RESOLVED"};setState({noteText:r.note,convo:r.msgs,flags:nF,phase:"done"});}}
function dismissFlag(idx){const nF=[...state.flags];nF[idx]={...nF[idx],type:"GREEN",text:nF[idx].text+" — N/A"};setState({flags:nF});}
async function incWU(){const sel=state.workup.filter((_,i)=>state.wuChecked[i]);if(!sel.length)return;const r=await incorporate("Add workup items to A/P. Mark ***ADDED***.\n\n"+sel.map((w,i)=>(i+1)+". "+w).join("\n"),"workup");if(r)setState({noteText:r.note,convo:r.msgs,workup:state.workup.filter((_,i)=>!state.wuChecked[i]),wuChecked:{},phase:"done"});}

// ---- VERIFY BILLING ----
async function verifyBilling(){
  setState({phase:"verify",err:null});
  try{
    const sys=`You are a neurosurgery billing COMPLIANCE AUDITOR. Be adversarial. Check for:
1. Codes without documentation support 2. Region mismatches 3. Segment count errors
4. Bundling violations 5. Missing billable codes 6. Modifier opportunities 7. RVU errors
8. Missing documentation elements (ROS, family history, social history, exam components)

For EACH finding, provide a FIX — the exact language to add to the note to resolve the issue.

Respond EXACTLY in this format (one per line):
RED: [error description] |FIX| [exact text to add to note to fix this]
YELLOW: [warning] |FIX| [exact text to add to note]
GREEN: [confirmed correct]

Common fixes to suggest:
- Missing ROS: "REVIEW OF SYSTEMS: Positive for back pain, leg pain, numbness. Negative for bowel/bladder dysfunction, fever, chills, night sweats, unexplained weight loss, progressive weakness, bilateral symptoms, chest pain, shortness of breath."
- Missing family history: "FAMILY HISTORY: Noncontributory to current surgical condition."
- Missing social history: "SOCIAL HISTORY: Per chart review. Smoking status: [document]. Alcohol: social. No illicit drug use."
- Missing allergy documentation: "ALLERGIES: No known drug allergies."
- Weak surgical discussion: "Extensive discussion of surgical risks including but not limited to nerve injury, infection, bleeding, dural tear, anesthesia risks, failure to improve, recurrence, and need for further surgery. Alternatives reviewed including continued conservative management, injections, and observation. Patient understands and wishes to proceed."

End with:
CORRECTED CODES:
[full corrected code list]
CORRECTED TOTAL RVU: [number]`;
    const{txt}=await callC([{role:"user",content:"NOTE:\n"+state.noteText+"\n\nPROPOSED BILLING:\n"+state.billRaw+"\n\nAudit this billing. Find every error and missing element."}],2,sys);
    // Parse into structured items
    const verifyItems=[];
    txt.split("\n").forEach(line=>{
      const rm=line.match(/^RED:\s*(.*?)(?:\|FIX\|\s*(.*))?$/i);
      const ym=line.match(/^YELLOW:\s*(.*?)(?:\|FIX\|\s*(.*))?$/i);
      const gm=line.match(/^GREEN:\s*(.*)/i);
      if(rm)verifyItems.push({type:"RED",text:rm[1].trim(),fix:rm[2]?.trim()||""});
      else if(ym)verifyItems.push({type:"YELLOW",text:ym[1].trim(),fix:ym[2]?.trim()||""});
      else if(gm)verifyItems.push({type:"GREEN",text:gm[1].trim(),fix:""});
    });
    // Extract corrected codes section
    const correctedMatch=txt.match(/CORRECTED CODES:\s*\n([\s\S]*?)(?=CORRECTED TOTAL|$)/i);
    const correctedRVU=txt.match(/CORRECTED TOTAL RVU:\s*([\d.]+)/i);
    setState({phase:"done",levelUpResult:txt,verifyItems,verifyCorrected:correctedMatch?correctedMatch[1].trim():"",verifyRVU:correctedRVU?correctedRVU[1]:""});
  }catch(e){setState({err:"Verify failed: "+e.message,phase:"done"});}
}
async function applyVerifyFix(idx){
  const item=state.verifyItems[idx];if(!item||!item.fix)return;
  const r=await incorporate("Add this documentation to the appropriate section. Mark ***ADDED***.\n\n"+item.fix,"addend");
  if(r){
    const updated=[...state.verifyItems];
    updated[idx]={...updated[idx],type:"GREEN",text:updated[idx].text+" — FIXED",fix:""};
    setState({noteText:r.note,convo:r.msgs,verifyItems:updated,phase:"done"});
  }
}

function sendToCoder(noteT,billR){
  const sec=parseBillFull(billR);const clean=stripAll(stripBilling(noteT));
  let out="CASE - "+TODAY+"\n\n"+clean+"\n\nCPT CODES:\n"+(sec.codes||"");
  if(sec.icd)out+="\n\nICD-10:\n"+sec.icd;
  out+="\n\nDecision-support only.";
  navigator.clipboard.writeText(out).catch(()=>{});
  const b=document.getElementById("coderBtn");if(b){const o=b.innerHTML;b.innerHTML="✅ Copied!";b.style.background="#059669";setTimeout(()=>{if(b){b.innerHTML=o;b.style.background="";}},2000);}
}

function saveBackToCase(){
  const caseId=state._reopenedCase;const ni=state._reopenedNoteIdx||0;
  if(!caseId)return;
  const updatedCases=state.cases.map(c=>{
    if(c.id!==caseId)return c;
    const notes=[...(c.notes||[])];
    if(notes[ni]){
      notes[ni]={...notes[ni],note:state.noteText,billRaw:state.billRaw};
    }
    return{...c,notes};
  });
  lsS(SK,updatedCases);
  setState({cases:updatedCases});
  syncPush().catch(()=>{});
  const b=document.querySelector('[onclick="saveBackToCase()"]');
  if(b){const o=b.innerHTML;b.innerHTML="✅ Saved!";b.style.background="#059669";setTimeout(()=>{if(b){b.innerHTML=o;b.style.background="";}},2000);}
}

// ---- NOTE RENDERING ----
function hlM(t){return t.replace(/\*{3}ASSUMED\*{3}\s*/g,'<span class="ma" onclick="this.remove()">ASSUMED</span> ').replace(/\*{3}IMPLANT\*{3}\s*/g,'<span class="mi" onclick="this.remove()">IMPLANT</span> ').replace(/\*{3}ADDED\*{3}\s*/g,'<span class="md2">ADDED</span> ').replace(/\*\*([^*]+)\*\*/g,'<strong style="color:#f1f5f9">$1</strong>');}
function renderNote(el,text){
  el.innerHTML="";if(!text)return;
  text.split("\n").forEach(ln=>{
    if(/^---+$/.test(ln.trim()))return;
    if(/^[A-Z][A-Z /&\-]{2,}:/.test(ln.trim())){const d=document.createElement("div");d.className="slabel";d.innerHTML=hlM(esc(ln));el.appendChild(d);return;}
    if(!ln.trim()){el.appendChild(Object.assign(document.createElement("div"),{style:"height:6px"}));return;}
    if(/^-\s/.test(ln.trim())){const d=document.createElement("div");d.style.cssText="display:flex;gap:8px;margin-bottom:3px;font-size:13px;color:#cbd5e1;line-height:1.5";d.innerHTML='<span style="color:#475569">-</span><span>'+hlM(esc(ln.trim().slice(2)))+"</span>";el.appendChild(d);return;}
    if(/^\d+[\.\)]\s/.test(ln.trim())){const d=document.createElement("div");d.style.cssText="display:flex;gap:8px;margin-bottom:3px;font-size:13px;color:#cbd5e1;line-height:1.5";const n=ln.trim().match(/^(\d+)[\.\)]\s*(.*)/);d.innerHTML='<span style="color:#64748b;min-width:18px">'+n[1]+'.</span><span>'+hlM(esc(n[2]))+"</span>";el.appendChild(d);return;}
    const d=document.createElement("div");d.style.cssText="font-size:13px;color:#cbd5e1;line-height:1.6;margin:1px 0";d.innerHTML=hlM(esc(ln));el.appendChild(d);
  });
}
function renderBillingCodes(el,text){
  el.innerHTML="";if(!text)return;
  text.split("\n").forEach(ln=>{
    const t=ln.trim();if(!t||/^---+$/.test(t))return;
    const codeMatch=t.match(/^(\d{5})\s*[-\u2013\u2014]\s*(.*)/);
    if(codeMatch){
      const code=codeMatch[1],rest=codeMatch[2];
      const rvuM=rest.match(/\(([0-9.]+)\s*RVU\)/i);
      const confM=rest.match(/(HIGH|MED(?:IUM)?|LOW)\s*CONFIDENCE/i);
      const desc=rest.replace(/\([0-9.]+\s*RVU\)/i,"").replace(/(HIGH|MED(?:IUM)?|LOW)\s*CONFIDENCE/i,"").replace(/\s{2,}/g," ").trim();
      const row=document.createElement("div");row.className="b-code-row";
      let h='<div><span class="b-cpt">'+esc(code)+'</span>';
      if(rvuM)h+='<span class="b-rvu">'+esc(rvuM[1])+' RVU</span>';
      if(confM){const cl=confM[1].toUpperCase()==="HIGH"?"hi":confM[1].toUpperCase()==="LOW"?"lo":"med";h+='<span class="b-conf '+cl+'">'+esc(confM[1].toUpperCase())+'</span>';}
      h+='</div>';
      if(desc)h+='<div class="b-code-desc">'+esc(desc)+'</div>';
      row.innerHTML=h;el.appendChild(row);
    }else if(/^[A-Z][A-Z /&\-]{2,}:/.test(t)){
      const d=document.createElement("div");d.className="slabel";d.style.marginTop="8px";d.innerHTML=esc(t);el.appendChild(d);
    }else if(/^\u2192|^[\u2192\u21D2]/.test(t)){
      const d=document.createElement("div");d.className="mdm-result";d.innerHTML=esc(t);el.appendChild(d);
    }else{
      const d=document.createElement("div");d.style.cssText="font-size:12px;color:#94a3b8;line-height:1.5;margin:2px 0;padding:0 2px";d.innerHTML=esc(t);el.appendChild(d);
    }
  });
}
function renderMDM(el,text){
  el.innerHTML="";if(!text)return;
  text.split("\n").forEach(ln=>{
    const t=ln.trim();if(!t||/^---+$/.test(t))return;
    const elemMatch=t.match(/^-\s*(RISK|PROBLEMS|DATA|NUMBER AND COMPLEXITY OF PROBLEMS|AMOUNT.*DATA|RISK OF COMPLICATIONS):\s*(HIGH|MODERATE|LOW|MINIMAL|STRAIGHTFORWARD)\s*(.*)/i);
    if(elemMatch){
      const label=elemMatch[1],level=elemMatch[2].toUpperCase(),detail=elemMatch[3]?elemMatch[3].replace(/^\(/,"").replace(/\)$/,""):"";
      const cls=level==="HIGH"?"high":level==="MODERATE"?"moderate":level==="LOW"?"low":"minimal";
      const row=document.createElement("div");row.className="mdm-row";
      row.innerHTML='<span class="mdm-lbl">'+esc(label)+'</span><span class="mdm-val '+cls+'">'+esc(level)+'</span>'+(detail?'<span class="mdm-detail">('+esc(detail)+')</span>':"");
      el.appendChild(row);
    }else if(/^\u2192|^[\u2192\u21D2]/.test(t)){
      const d=document.createElement("div");d.className="mdm-result";d.innerHTML=esc(t);el.appendChild(d);
    }else{
      const d=document.createElement("div");d.style.cssText="font-size:12px;color:#94a3b8;line-height:1.5;margin:2px 0";d.innerHTML=esc(t);el.appendChild(d);
    }
  });
}

// ============================================================
// RENDER
// ============================================================
function render(){
  const s=state;const app=document.getElementById("app");

  // PIN LOCK SCREEN
  if(vaultLocked){
    let h=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:80vh;text-align:center">`;
    h+=`<div style="font-size:32px;margin-bottom:12px">🔐</div>`;
    h+=`<div style="font-size:20px;font-weight:800;color:#fff;margin-bottom:4px">OpNote Intelligence</div>`;
    h+=`<div style="font-size:12px;color:#475569;margin-bottom:24px">v10.0 · Enter PIN to unlock</div>`;
    h+=`<input id="pin-input" type="password" inputmode="numeric" class="inp" placeholder="Enter PIN" style="width:200px;text-align:center;font-size:18px;letter-spacing:6px;margin-bottom:12px" onkeydown="if(event.key==='Enter')unlockVault(this.value)">`;
    h+=`<button class="btn" style="background:linear-gradient(135deg,#2563eb,#1d4ed8);padding:12px 32px;font-size:14px;font-weight:700" onclick="unlockVault(document.getElementById('pin-input').value)">Unlock</button>`;
    if(pinErr)h+=`<div style="color:#fca5a5;font-size:13px;margin-top:12px;font-weight:600">${esc(pinErr)}</div>`;
    h+=`<button style="background:none;border:none;color:#475569;font-size:11px;margin-top:20px;cursor:pointer;text-decoration:underline" onclick="if(confirm('This will erase your saved PIN and keys. You will need to re-enter all API keys manually.')){removeVault();}">Remove PIN & enter keys manually</button>`;
    h+=`</div>`;
    app.innerHTML=h;
    setTimeout(()=>{const pi=document.getElementById("pin-input");if(pi)pi.focus();},50);
    return;
  }

  const hasWK=!!s.wk;const isL=s.phase&&s.phase!=="done"&&s.phase!=="";

  // Key re-sync: ensure API keys match localStorage (catches vault unlock propagation issues)
  if(!vaultLocked){
    const lsKey=localStorage.getItem("opnote-api-key")||"";
    if(lsKey&&!API_KEY)API_KEY=lsKey;
    const lsWK=localStorage.getItem("opnote-wkey")||"";
    if(lsWK&&!s.wk){try{s.wk=JSON.parse(lsWK);}catch{s.wk=lsWK;}}
  }

  // Phase-stuck recovery: if loading for >90s, auto-clear
  if(isL){
    if(!state._phaseStart)state._phaseStart=Date.now();
    else if(Date.now()-state._phaseStart>90000){state.phase="";state._phaseStart=null;}
  }else{state._phaseStart=null;}
  const ph={note:"Generating note...",billing:"Analyzing billing...",incorporate:"Incorporating...",addend:"Updating...",workup:"Adding workup...",image:"Analyzing image...",verify:"Verifying billing...",checking:"Running auth check..."};
  let h="";

  // HEADER
  h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div><div style="font-size:20px;font-weight:800;color:#fff">OpNote Intelligence</div><div style="font-size:11px;color:#475569;margin-top:2px">v10.0 · ${TODAY}${ghToken?(syncStatus==="pulling"||syncStatus==="syncing"?" · 🔄":""):""}</div></div><div style="display:flex;gap:6px">`;
  if(localStorage.getItem(VAULT_KEY))h+=`<button class="btn" style="background:#334155" onclick="lockVault()" title="Lock">🔒</button>`;
  h+=`<button class="btn" style="background:#334155" onclick="setState({showSettings:!state.showSettings})">⚙️</button>`;
  if(s.view!=="input")h+=`<button class="btn" style="background:#1e3a5f" onclick="lastDraftId=null;setState({view:'input',noteText:'',billRaw:'',gaps:[],flags:[],financial:null,workup:[],questions:[],err:null,phase:'',editing:false,addend:'',text:'',_gc:{},_qc:{},tStart:null,tNote:null,tCopy:null,linkedTo:null,billingValidation:null,levelUpResult:null,verifyItems:null,verifyCorrected:'',verifyRVU:'',_reopenedCase:null,_reopenedNoteIdx:null,_draftId:null})">+ New</button>`;
  h+=`</div></div>`;

  // API KEY MISSING BANNER
  if(!API_KEY && !vaultLocked){
    h+=`<div style="background:#7f1d1d;border:1px solid #dc2626;border-radius:10px;padding:12px;margin-bottom:12px;display:flex;align-items:center;gap:10px;cursor:pointer" onclick="setState({showSettings:true})">`;
    h+=`<span style="font-size:18px">⚠️</span><div><div style="font-size:13px;font-weight:700;color:#fca5a5">API Key Required</div><div style="font-size:11px;color:#fca5a5aa">Tap here to open Settings and add your Anthropic API key</div></div>`;
    h+=`</div>`;
  }

  // SETTINGS
  if(s.showSettings){
    h+=`<div style="background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;margin-bottom:12px">`;
    h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin-bottom:10px">SETTINGS</div>`;
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">Anthropic API Key <span style="color:#f87171">(required)</span></div>`;
    h+=`<input type="password" class="inp" value="${esc(API_KEY)}" placeholder="sk-ant-..." onchange="API_KEY=this.value;localStorage.setItem('opnote-api-key',this.value);render()" style="margin-bottom:8px">`;
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">Surgeon Name</div>`;
    h+=`<input class="inp" value="${esc(s.sn)}" placeholder="Last name" onchange="state.sn=this.value;lsS('opnote-surgeon',this.value);render()" style="margin-bottom:8px">`;
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">OpenAI Key (Whisper)</div>`;
    h+=`<input type="password" class="inp" value="${esc(s.wk)}" placeholder="sk-..." onchange="state.wk=this.value;lsS('opnote-wkey',this.value);render()" style="margin-bottom:8px">`;
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">Coder Email</div>`;
    h+=`<input class="inp" value="${esc(s.ce)}" placeholder="coder@practice.com" onchange="state.ce=this.value;lsS('opnote-email',this.value);render()" style="margin-bottom:12px">`;
    h+=`<div style="border-top:1px solid #1e293b;padding-top:12px;margin-top:4px">`;
    h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin-bottom:8px">☁️ CLOUD SYNC</div>`;
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">GitHub Token <span style="color:#475569">(gist scope only)</span></div>`;
    h+=`<input type="password" class="inp" value="${esc(ghToken)}" placeholder="ghp_..." onchange="ghToken=this.value;localStorage.setItem('${GIST_TOKEN_KEY}',this.value);render()" style="margin-bottom:4px">`;
    h+=`<div style="font-size:10px;color:#475569;margin-bottom:8px">GitHub → Settings → Developer Settings → Personal Access Tokens → Tokens (classic) → Generate → check "gist" only</div>`;
    if(ghToken){
      const syncCol=syncStatus==="done"?"#86efac":syncStatus.startsWith("err")?"#fca5a5":syncStatus?"#60a5fa":"#94a3b8";
      const syncTxt=syncStatus==="done"?"✅ Synced":syncStatus==="pulling"?"⬇️ Pulling...":syncStatus==="syncing"?"🔄 Syncing...":syncStatus.startsWith("err")?"❌ "+syncStatus.slice(4):lastSync?"Last sync: "+lastSync:"Not synced yet";
      h+=`<div style="display:flex;gap:8px;margin-bottom:6px"><button class="btn" style="background:linear-gradient(135deg,#1d4ed8,#2563eb);flex:1;padding:10px" onclick="syncFull()">🔄 Sync Now</button></div>`;
      h+=`<div style="font-size:11px;color:${syncCol};margin-bottom:4px;word-break:break-all">${syncTxt}</div>`;
      if(syncStatus.startsWith("err"))h+=`<div style="font-size:10px;color:#475569;margin-bottom:4px">Check: token starts with ghp_, has "gist" scope, not expired</div>`;
      if(gistId)h+=`<div style="font-size:10px;color:#334155;word-break:break-all">Gist: ${gistId.slice(0,12)}... <button style="font-size:10px;color:#475569;background:none;border:none;text-decoration:underline" onclick="gistId='';localStorage.removeItem('${GIST_ID_KEY}');render()">reset</button></div>`;
    }
    h+=`</div>`;
    h+=`<div style="display:flex;gap:8px;margin-top:12px"><button class="btn" style="background:#334155;flex:1" onclick="exportCases()">📥 Export</button><button class="btn" style="background:#334155;flex:1" onclick="pickImport()">📤 Import</button></div>`;
    // PIN VAULT
    h+=`<div style="border-top:1px solid #1e293b;padding-top:12px;margin-top:12px">`;
    h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin-bottom:8px">🔐 PIN LOCK</div>`;
    if(localStorage.getItem(VAULT_KEY)){
      const keyPreview=API_KEY?("sk-ant-..."+API_KEY.slice(-4)):"⚠️ EMPTY — add key below then Update Vault";
      h+=`<div style="font-size:11px;color:${API_KEY?"#86efac":"#fca5a5"};margin-bottom:8px">${API_KEY?"✅":"⚠️"} PIN set — Key: ${keyPreview}</div>`;
      h+=`<div style="display:flex;gap:8px;margin-bottom:8px">`;
      h+=`<button class="btn" style="background:#2563eb;flex:1;padding:8px;font-size:11px" onclick="updateVault()">🔄 Update Vault</button>`;
      h+=`<button class="btn" style="background:#7c3aed;flex:1;padding:8px;font-size:11px" onclick="const p=prompt('Enter new PIN (3+ chars):');if(p)setVaultPIN(p)">Change PIN</button>`;
      h+=`</div>`;
      h+=`<div style="display:flex;gap:8px;margin-bottom:8px">`;
      h+=`<button class="btn" style="background:#334155;flex:1;padding:8px;font-size:11px" onclick="state._vaultBlob=localStorage.getItem('${VAULT_KEY}');render()">📋 Show Embed Code</button>`;
      h+=`<button class="btn" style="background:#7f1d1d;flex:1;padding:8px;font-size:11px" onclick="if(confirm('Remove PIN? Keys stay in settings until you clear them.')){removeVault();}">Remove PIN</button>`;
      h+=`</div>`;
    }else{
      h+=`<div style="font-size:11px;color:#475569;margin-bottom:8px">Set a PIN to auto-load all keys on any device. Enter your keys above first, then set PIN.</div>`;
      h+=`<button class="btn" style="background:linear-gradient(135deg,#2563eb,#1d4ed8);width:100%;padding:10px;font-size:12px;font-weight:700" onclick="const p=prompt('Choose a PIN (3+ chars):');if(p)setVaultPIN(p)" ${API_KEY?"":"disabled"}>🔐 Set PIN</button>`;
      if(!API_KEY)h+=`<div style="font-size:10px;color:#f87171;margin-top:4px">Add API key first</div>`;
    }
    if(state._vaultBlob){
      h+=`<div style="background:#020617;border:2px solid #2563eb;border-radius:8px;padding:10px;margin-top:8px">`;
      h+=`<div style="font-size:11px;font-weight:700;color:#60a5fa;margin-bottom:6px">📦 Embed Code — paste into HTML</div>`;
      h+=`<div style="font-size:10px;color:#94a3b8;margin-bottom:6px">In index.html, find <code>EMBEDDED_VAULT=""</code> and replace with:</div>`;
      h+=`<textarea id="vaultBlobTA" readonly style="width:100%;height:60px;background:#0f172a;color:#86efac;border:1px solid #1e293b;border-radius:6px;font-family:monospace;font-size:10px;padding:6px;resize:none">const EMBEDDED_VAULT='${state._vaultBlob.replace(/'/g,"\\'")}';</textarea>`;
      h+=`<button class="btn" style="background:#059669;width:100%;padding:8px;font-size:11px;margin-top:6px" onclick="navigator.clipboard.writeText(document.getElementById('vaultBlobTA').value);this.textContent='✅ Copied!'">📋 Copy Embed Code</button>`;
      h+=`<div style="font-size:10px;color:#475569;margin-top:4px">After pasting, commit & deploy. Any device can then unlock with your PIN.</div>`;
      h+=`</div>`;
    }
    h+=`</div>`;
    h+=`</div>`;
  }

  // TABS
  const draftCount=s.cases.filter(c=>c.draft).length;
  h+=`<div class="tabs"><button class="tab ${s.view==="input"||s.view==="output"?"on":""}" onclick="setState({view:state.noteText?'output':'input'})">${s.noteText?"📋 Current":"🎤 New"}</button><button class="tab ${s.view==="auth"?"on":""}" onclick="setState({view:'auth'})">🛡️ Auth</button><button class="tab ${s.view==="cases"||s.view==="detail"?"on":""}" onclick="setState({view:'cases'})">📂 Cases${s.cases.length?" ("+s.cases.length+")":""}${draftCount?" 📸"+draftCount:""}</button><button class="tab ${s.view==="stats"?"on":""}" onclick="setState({view:'stats'})">📊</button></div>`;

  // ---- INPUT VIEW ----
  if(s.view==="input"){
    h+=`<div style="display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap">`;
    Object.entries(TYPES).forEach(([id,t])=>{h+=`<button class="btn" style="background:${s.nt===id?"#2563eb":"#1e293b"};padding:10px 12px;font-size:12px;flex:1;min-width:0;white-space:nowrap" onclick="setState({nt:'${id}'})">${t.e} ${t.l.replace("Inpatient ","")}</button>`;});
    h+=`</div>`;
    if(s.nt==="clinic"){
      h+=`<div style="display:flex;gap:6px;margin-bottom:8px">`;["new","followup","postop"].forEach(v=>{const labels={new:"New Visit",followup:"Follow-up",postop:"Post-Op"};h+=`<button class="btn" style="background:${s.clinicVisit===v?"#2563eb":"#334155"};flex:1;padding:8px;font-size:12px" onclick="setState({clinicVisit:'${v}'})">${labels[v]}</button>`;});
      h+=`</div><div style="display:flex;gap:6px;margin-bottom:8px"><button class="btn" style="background:${s.clinicPt==="new"?"#7c3aed":"#334155"};flex:1;padding:8px;font-size:12px" onclick="setState({clinicPt:'new'})">New Patient</button><button class="btn" style="background:${s.clinicPt==="established"?"#7c3aed":"#334155"};flex:1;padding:8px;font-size:12px" onclick="setState({clinicPt:'established'})">Established</button></div>`;
    }
    const dur=rD();
    if(rS==="idle")h+=`<button class="rec-btn idle" onclick="toggleRec()"${!hasWK?' disabled style="opacity:0.3"':''}>🎤 ${hasWK?"TAP TO DICTATE":"Add OpenAI key for voice"}</button>`;
    else if(rS==="recording")h+=`<button class="rec-btn recording" onclick="toggleRec()">⏹ RECORDING <span class="timer">${dur}</span></button>`;
    else h+=`<button class="rec-btn transcribing" disabled>⏳ Transcribing...</button>`;
    h+=`<div style="display:flex;gap:8px;margin-bottom:10px"><button class="img-btn" style="flex:1;margin:0" onclick="pickImage()">${s.phase==="image"&&!captureActive?"⏳ Analyzing...":"📷 Add Image"}</button><button class="img-btn" style="flex:1;margin:0;border-color:#7c3aed40;color:#a78bfa" onclick="quickCapture()" ${s.phase==="image"?"disabled":""}>${captureActive?"⏳ Capturing...":"📸 Quick Capture"}</button></div>`;
    if(captureActive){
      h+=`<div style="background:#7c3aed20;border:2px solid #7c3aed;border-radius:12px;padding:14px;margin-bottom:10px;text-align:center">`;
      h+=`<div style="font-size:14px;font-weight:800;color:#c4b5fd;margin-bottom:8px">📸 Processing...</div>`;
      h+=`<div style="font-size:12px;color:#a78bfa">${captureErr||"Analyzing image..."}</div>`;
      h+=`</div>`;
    }
    if(lastDraftId&&!captureActive){
      h+=`<div style="background:#05966920;border:2px solid #059669;border-radius:12px;padding:12px;margin-bottom:10px">`;
      h+=`<div style="font-size:13px;color:#86efac;font-weight:700;margin-bottom:6px">✅ Draft saved!</div>`;
      h+=`<div style="display:flex;gap:8px"><button class="btn" style="background:#7c3aed;flex:1;padding:10px;font-size:12px" onclick="addPageToDraft('${lastDraftId}')" ${s.phase==="image"?"disabled":""}>📷 + Add More Pages</button><button class="btn" style="background:#059669;flex:1;padding:10px;font-size:12px" onclick="setState({view:'cases',caseTab:'all'})">📂 View Draft</button></div>`;
      h+=`</div>`;
    }
    if(s._draftId)h+=`<div style="background:#7c3aed20;border:1px solid #7c3aed;border-radius:8px;padding:8px 12px;margin-bottom:8px;font-size:12px;color:#a78bfa">📸 Draft loaded — add context above then process <button style="font-size:11px;color:#475569;background:none;border:none;float:right" onclick="setState({_draftId:null,text:''})">✕</button></div>`;
    h+=`<textarea class="ta" id="mainInput" rows="8" placeholder="Dictate, type, or paste..." oninput="state.text=this.value">${esc(s.text)}</textarea>`;
    if(s.text.trim()){const wc=s.text.trim().split(/\s+/).length;h+=`<div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:11px;color:#475569">${wc}w</span><button style="font-size:11px;color:#475569;background:none;border:none" onclick="state.text='';render()">Clear</button></div>`;}
    if(s.linkedTo){const lc=s.cases.find(c=>c.id===s.linkedTo);if(lc)h+=`<div style="background:#1e3a5f30;border:1px solid #1e3a5f;border-radius:8px;padding:8px 12px;margin-top:8px;font-size:12px;color:#60a5fa">🔗 Linked to: ${esc(lc.proc)} <button style="font-size:11px;color:#475569;background:none;border:none;float:right" onclick="setState({linkedTo:null})">✕</button></div>`;}
    h+=`<button class="big" style="background:${!s.text.trim()?"#1e293b":"linear-gradient(135deg,#1d4ed8,#2563eb)"};margin-top:10px;opacity:${!s.text.trim()?0.4:1}" onclick="${s._draftId?"processDraftAsCase()":"processCase()"}" ${!s.text.trim()||isL?"disabled":""}>⚡ ${s._draftId?"Process Draft":"Process Case"}</button>`;
    if(s.err)h+=`<div class="err"><div>${esc(s.err)}</div></div>`;
  }

  // ---- AUTH VIEW ----
  if(s.view==="auth"){
    const a=authState;
    h+=`<div style="font-size:16px;font-weight:800;color:#f1f5f9;margin-bottom:12px">🛡️ Prior Authorization Check</div>`;
    h+=`<div style="font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:6px">PAYER</div><div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">`;
    AUTH_PAYERS.forEach(p=>{h+=`<button class="btn" style="background:${a.payer===p.id?p.color:"#1e293b"};padding:10px 14px;font-size:12px;flex:1;min-width:0" onclick="authState.payer='${p.id}';render()">${p.name}</button>`;});
    h+=`</div>`;
    h+=`<div style="font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:6px">PROCEDURE</div><div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">`;
    AUTH_PROCEDURES.forEach(p=>{h+=`<button class="btn" style="background:${a.procedure===p.id?"#2563eb":"#1e293b"};padding:8px 10px;font-size:11px" onclick="authState.procedure='${p.id}';render()">${p.name}</button>`;});
    h+=`</div>`;
    h+=`<div style="font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:8px">CLINICAL DATA <span style="color:#475569;font-weight:400">(de-identified only)</span></div>`;
    const zones=[{id:"mriText",label:"📋 MRI / Imaging Report",ph:"Paste RADIOLOGY REPORT only (findings + impression). NOT exam, ROS, or clinical notes."},{id:"medsText",label:"💊 Medications",ph:"Failed meds with durations (e.g. gabapentin 6 weeks, meloxicam 3 months)..."},{id:"ptText",label:"🏋️ PT / Conservative Tx",ph:"PT visits, injection dates, durations, outcomes..."},{id:"labsText",label:"🧪 Labs",ph:"Cotinine level, DEXA T-score, HbA1c..."},{id:"priorText",label:"🔪 Prior Procedures",ph:"Prior spine surgery, injection history, dates..."}];
    zones.forEach(z=>{h+=`<div class="auth-zone"><div class="az-label">${z.label}</div><textarea class="az-ta" placeholder="${esc(z.ph)}" oninput="authState.${z.id}=this.value">${esc(a[z.id])}</textarea></div>`;});
    const canRun=a.payer&&a.procedure&&(a.mriText||a.medsText||a.ptText||a.labsText||a.priorText);
    h+=`<button class="big" style="background:${canRun?"linear-gradient(135deg,#059669,#10b981)":"#1e293b"};margin-top:6px;opacity:${canRun?1:0.4}" onclick="runAuthCheck()" ${!canRun||a.phase==="checking"?"disabled":""}>🛡️ Run Authorization Check</button>`;
    if(a.phase==="checking")h+=`<div class="ld">Running payer-specific analysis...</div>`;
    if(a.err)h+=`<div class="err"><div>${esc(a.err)}</div></div>`;
    // Auth Results
    if(a.results){
      const r=a.results;
      if(r.pathway)h+=`<div class="card" style="border-left:4px solid #2563eb;margin-top:12px"><div class="card-h"><span class="title">🔀 Pathway</span></div><div class="card-b" style="font-size:13px;color:#60a5fa;font-weight:600">${esc(r.pathway)}</div></div>`;
      if(r.approval){
        const isLikely=r.approval.toLowerCase().includes("likely")&&!r.approval.toLowerCase().includes("unlikely");
        const clr=isLikely?"#86efac":r.approval.toLowerCase().includes("unlikely")?"#fca5a5":"#fef08a";
        h+=`<div style="display:flex;gap:10px;margin:10px 0;padding:12px;background:#020617;border-radius:10px;border:1px solid #1e293b"><div style="flex:1"><div style="font-size:10px;font-weight:700;color:#64748b">APPROVAL</div><div style="font-size:14px;font-weight:800;color:${clr}">${esc(r.approval)}</div></div><div style="flex:1"><div style="font-size:10px;font-weight:700;color:#64748b">PEER-TO-PEER</div><div style="font-size:14px;font-weight:800;color:#94a3b8">${esc(r.p2p)}</div></div></div>`;
      }
      if(r.items.length){
        h+=`<div class="card" style="border-left:4px solid #eab308"><div class="card-h"><span class="title">📋 Checklist</span><span style="font-size:11px;color:#94a3b8">${r.items.filter(i=>i.status==="green").length}/${r.items.length} met</span></div><div class="card-b">`;
        r.items.forEach(item=>{
          const icons={green:"✅",yellow:"⚠️",red:"🔴"};const colors={green:"#86efac",yellow:"#fef08a",red:"#fca5a5"};const bgs={green:"rgba(34,197,94,0.1)",yellow:"rgba(234,179,8,0.1)",red:"rgba(220,38,38,0.15)"};
          h+=`<div style="padding:8px 10px;margin-bottom:4px;border-radius:8px;background:${bgs[item.status]};font-size:12px;color:${colors[item.status]};line-height:1.5">${icons[item.status]} ${esc(item.text)}`;
          if(item.status!=="green"){
            const noteFlag=item.text.replace(/\b(Cigna|Aetna|UHC|United\s*Healthcare|eviCore|CPB\s*\d+|CMM-\d+|InterQual)\b/gi,"").trim();
            h+=`<div style="margin-top:6px"><button class="btn" style="background:#1d4ed8;padding:4px 10px;font-size:10px" onclick="state.addend='${escJs(noteFlag)}';setState({view:state.noteText?'output':'input'})">📝 Flag for Note</button></div>`;
          }
          h+=`</div>`;
        });
        h+=`</div></div>`;
      }
      if(r.warnings.length){h+=`<div class="card" style="border-left:4px solid #ef4444"><div class="card-h"><span class="title">⚠️ Critical Warnings</span></div><div class="card-b">`;r.warnings.forEach(w=>{h+=`<div style="font-size:12px;color:#fca5a5;padding:6px 0;border-bottom:1px solid #1e293b20">⚠️ ${esc(w)}</div>`;});h+=`</div></div>`;}
      if(a.letter){h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">📝 Justification Letter</span><button class="btn" style="background:#334155" id="copyLetterBtn" onclick="navigator.clipboard.writeText(authState.letter);this.innerHTML='✅';setTimeout(()=>this.innerHTML='📋 Copy',2000)">📋 Copy</button></div><div class="card-b" id="authLetter"></div></div>`;}
    }
    if(a.results||a.payer||a.procedure)h+=`<button style="width:100%;margin-top:10px;padding:10px;font-size:12px;color:#64748b;background:none;border:none" onclick="resetAuth()">Reset</button>`;
  }

  // ---- OUTPUT VIEW ----
  if(s.view==="output"){
    if(isL)h+=`<div class="ld">${ph[s.phase]||"Processing..."}</div>`;
    if(s.tStart){h+=`<div class="tt">`;if(s.tNote)h+=`Note: <span>${fmtTime(s.tNote-s.tStart)}</span>`;if(s.tCopy)h+=` · Copy: <span>${fmtTime(s.tCopy-s.tStart)}</span>`;h+=`</div>`;}
    // Questions
    if(s.questions.length){
      h+=`<div class="card" style="border-left:4px solid #8b5cf6"><div class="card-h"><span class="title">❓ Questions (${s.questions.length})</span></div><div class="card-b">`;
      s.questions.forEach((q,i)=>{const val=s.qEdits[i]!==undefined?s.qEdits[i]:q.def;const ck=s._qc[i]!==false;h+=`<div class="qc" style="border-left:3px solid ${ck?"#8b5cf6":"#334155"};opacity:${ck?1:0.5}"><div style="display:flex;align-items:start;gap:8px;margin-bottom:6px"><button style="width:28px;height:28px;border-radius:6px;border:2px solid ${ck?"#8b5cf6":"#475569"};background:${ck?"#7c3aed":"#0f172a"};color:#fff;font-size:14px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center" onclick="state._qc[${i}]=state._qc[${i}]===false?undefined:false;render()">${ck?"✓":""}</button><div class="qt" style="margin:0">${esc(q.q)}</div></div><input class="qi" value="${esc(val)}" oninput="state.qEdits[${i}]=this.value"></div>`;});
      const qN=s.questions.filter((_,i)=>s._qc[i]!==false).length;
      h+=`<button class="big" style="background:#7c3aed;padding:10px;font-size:13px;margin-top:4px" onclick="useQBatch()" ${isL||!qN?"disabled":""}>✅ Apply ${qN} Answer${qN!==1?"s":""}</button></div></div>`;
    }
    // Note
    if(s.noteText){
      h+=`<div style="display:flex;gap:8px;margin-bottom:10px"><button id="copyEmrH" class="big" style="background:linear-gradient(135deg,#1d4ed8,#2563eb);flex:2" onclick="copyHTML(state.editing?state.editText:state.noteText,'copyEmrH')">📋 Copy → EMR</button><button id="copyAgent" class="btn" style="background:linear-gradient(135deg,#059669,#10b981);padding:14px 12px;border-radius:12px;font-size:11px;font-weight:700;color:#fff" onclick="copyForAgent('copyAgent')">🤖 Agent</button><button id="copyEmrP" class="btn" style="background:#334155;padding:14px 12px;border-radius:12px;font-size:12px" onclick="copyPlain(state.editing?state.editText:state.noteText,'copyEmrP')">Plain</button></div>`;
      h+=`<div class="card" style="border-left:4px solid #3b82f6"><div class="card-h"><span class="title">📋 Note</span><div style="display:flex;gap:6px">`;
      if(!s.editing)h+=`<button class="btn" style="background:#334155" onclick="state.editText=state.noteText;state.editing=true;render()">✏️</button>`;
      else h+=`<button class="btn" style="background:#059669" onclick="state.noteText=state.editText;state.editing=false;render()">💾</button><button class="btn" style="background:#7f1d1d" onclick="state.editing=false;render()">✕</button>`;
      h+=`</div></div>`;
      h+=s.editing?`<div class="card-b"><textarea class="edit-ta" oninput="state.editText=this.value">${esc(s.editText||s.noteText)}</textarea></div></div>`:`<div class="card-b" id="noteBox"></div></div>`;
      // Pre-auth link to auth tab
      if(s.noteText.includes("PRE-AUTHORIZATION:")&&(s.nt==="clinic"||s.nt==="consult"))h+=`<button class="big" style="background:linear-gradient(135deg,#7c3aed,#a855f7);margin-bottom:10px" onclick="populateAuthFromNote(state.noteText)">🛡️ Run Full Auth Check →</button>`;
      // Workup
      if(s.workup.length){h+=`<div class="card" style="border-left:4px solid #06b6d4"><div class="card-h"><span class="title">🔬 Workup</span></div><div class="card-b">`;s.workup.forEach((w,i)=>{h+=`<div class="wu-row"><input type="checkbox" ${s.wuChecked[i]?"checked":""} onchange="state.wuChecked[${i}]=this.checked;render()"><span>${esc(w)}</span></div>`;});const wuN=Object.values(s.wuChecked).filter(Boolean).length;if(wuN)h+=`<button class="big" style="background:#0891b2;padding:10px;font-size:13px;margin-top:10px" onclick="incWU()" ${isL?"disabled":""}>✅ Add ${wuN} to A/P</button>`;h+=`</div></div>`;}
      // Add Details
      h+=`<div class="card" style="border-left:4px solid #6366f1"><div class="card-h"><span class="title" style="font-size:13px;color:#c7d2fe">✏️ Add Details</span><button class="btn" style="background:${s.phase==="image"?"#2563eb":"#334155"}" onclick="pickImage('addend')" ${s.phase==="image"?"disabled":""}>${s.phase==="image"?"⏳":"📷"}</button></div><div class="card-b"><textarea class="ta" id="addendInput" rows="2" placeholder="Type details or paste image..." oninput="state.addend=this.value">${esc(s.addend)}</textarea>`;
      const adDis=!s.addend.trim()||isL;
      h+=`<div style="display:flex;gap:6px;margin-top:8px"><button class="btn" style="background:${adDis?"#1e293b":"#6366f1"};flex:2;padding:10px;font-size:12px;opacity:${adDis?0.4:1}" onclick="doAddendTarget('note')" ${adDis?"disabled":""}>✅ Add</button></div>`;
      h+=`<div style="display:flex;gap:6px;margin-top:4px"><button class="btn" style="background:${adDis?"#1e293b":"#7c3aed"};flex:1;padding:8px;font-size:11px;opacity:${adDis?0.4:1}" onclick="doAddendTarget('hpi')" ${adDis?"disabled":""}>📝 HPI</button><button class="btn" style="background:${adDis?"#1e293b":"#2563eb"};flex:1;padding:8px;font-size:11px;opacity:${adDis?0.4:1}" onclick="doAddendTarget('ap')" ${adDis?"disabled":""}>📋 A/P</button><button class="btn" style="background:${adDis?"#1e293b":"#059669"};flex:1;padding:8px;font-size:11px;opacity:${adDis?0.4:1}" onclick="doAddendTarget('exam')" ${adDis?"disabled":""}>🩺 Exam</button></div></div></div>`;
    }
    // Billing sections
    if(s.billCodes){
      const cptOnly=[...new Set(s.billCodes.split("\n").map(l=>{const m=l.match(/\b(\d{5})\b/);return m?m[1]:null;}).filter(Boolean))];
      h+=`<div class="card" style="border-left:4px solid #60a5fa"><div class="card-h"><span class="title">📋 CPT Codes</span><button class="btn" style="background:#334155" onclick="navigator.clipboard.writeText('${cptOnly.join("\\n")}');this.innerHTML='✅';setTimeout(()=>this.innerHTML='📋',2000)">📋</button></div><div class="card-b" style="font-family:monospace;font-size:14px;line-height:2;color:#60a5fa;font-weight:800">`;
      cptOnly.forEach(c=>{const rvu=RVU_TABLE[parseInt(c)];h+=`<div>${c}${rvu?` <span style="font-size:11px;color:#86efac;font-weight:400">${rvu} RVU</span>`:""}</div>`;});
      const bv=s.billingValidation;
      if(bv&&bv.correctedRVU)h+=`<div style="margin-top:8px;padding:8px;background:#020617;border-radius:6px;font-size:12px"><span style="color:#94a3b8">Validated Total:</span> <span style="color:#86efac;font-weight:800">${bv.correctedRVU.toFixed(1)} RVU</span></div>`;
      h+=`</div></div>`;
      if(s.billMDM)h+=`<div class="card" style="border-left:4px solid #8b5cf6"><div class="card-h"><span class="title">🧠 E/M MDM Scoring</span></div><div class="card-b" id="mdmBox"></div></div>`;
      h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">💰 Code Detail</span></div><div class="card-b" id="codesBox"></div></div>`;
    }
    // Billing Validator
    if(s.billingValidation){const bv=s.billingValidation;if(bv.fixes.length||bv.warnings.length){h+=`<div class="card" style="border-left:4px solid #f87171"><div class="card-h"><span class="title">🔍 Billing Validator</span></div><div class="card-b">`;bv.fixes.forEach(f=>{h+=`<div style="padding:8px;margin-bottom:6px;background:rgba(220,38,38,0.15);border:1px solid #991b1b;border-radius:8px;font-size:12px;color:#fca5a5"><span class="bv-fix">FIX</span> ${esc(f.msg)}</div>`;});bv.warnings.forEach(w=>{h+=`<div style="padding:8px;margin-bottom:6px;background:rgba(234,179,8,0.1);border:1px solid #92400e;border-radius:8px;font-size:12px;color:#fef08a"><span class="bv-warn">CHECK</span> ${esc(w.msg)}</div>`;});h+=`</div></div>`;}}
    if(s.billMod)h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">📎 Modifiers</span></div><div class="card-b" id="modBox"></div></div>`;
    if(s.billICD)h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">🏥 ICD-10</span></div><div class="card-b" id="icdBox"></div></div>`;
    if(s.billBundle)h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">📦 Bundling</span></div><div class="card-b" id="bundleBox"></div></div>`;
    if(s.billPreauth)h+=`<div class="card" style="border-left:4px solid #a78bfa"><div class="card-h"><span class="title">📋 Pre-Authorization</span></div><div class="card-b" id="preauthBox"></div></div>`;
    // Gaps
    if(s.gaps.length){
      h+=`<div class="card" style="border-left:4px solid #eab308"><div class="card-h"><span class="title">⚠️ Gaps (${s.gaps.length})</span></div><div class="card-b" style="padding:8px">`;
      s.gaps.forEach((g,i)=>{const ic=g.impact==="HIGH"?"high":g.impact==="LOW"?"low":"med";const gc=g.impact==="HIGH"?"g-high":g.impact==="LOW"?"g-low":"g-med";const chk=s._gc[i];h+=`<div class="gc ${gc}${chk?" ck":""}"><div class="gh" onclick="state._gc[${i}]=!state._gc[${i}];render()"><input type="checkbox" ${chk?"checked":""} onclick="event.stopPropagation();state._gc[${i}]=!state._gc[${i}];render()"><span class="gi ${ic}">${g.impact}</span><span class="gt">${esc(g.issue).split("\\n")[0]}</span></div><div class="gb">${g.language?`<div class="gl">${esc(g.language)}</div>`:""}<div style="display:flex;gap:6px;margin-top:8px"><button class="gib" onclick="event.stopPropagation();incGap(${i})" ${isL?"disabled":""}>⚡ Add</button><button class="gib" style="background:linear-gradient(135deg,#5b21b6,#7c3aed)" onclick="event.stopPropagation();incGapHPI(${i})" ${isL?"disabled":""}>📝 HPI</button></div></div></div>`;});
      const gcN=Object.values(s._gc).filter(Boolean).length;
      if(gcN>1)h+=`<button class="big" style="background:linear-gradient(135deg,#a16207,#ca8a04);padding:12px;font-size:13px;margin-top:8px" onclick="incSelGaps()" ${isL?"disabled":""}>✅ Incorporate ${gcN}</button>`;
      h+=`</div></div>`;
    }
    // Flags
    if(s.flags.length){h+=`<div class="card" style="border-left:4px solid #ef4444"><div class="card-h"><span class="title">🚩 Flags</span></div><div class="card-b">`;s.flags.forEach((f,i)=>{const cls=f.type==="RED"?"red":f.type==="YELLOW"?"yellow":"green";h+=`<div class="fc ${cls}"><span class="fl">${f.type}</span> ${esc(f.text)}`;if(f.type!=="GREEN")h+=`<div style="display:flex;gap:6px;margin-top:8px"><button class="btn" style="background:${f.type==="RED"?"#dc2626":"#ca8a04"};flex:1;padding:8px;font-size:12px" onclick="incFlag(${i})" ${isL?"disabled":""}>✅ Add</button><button class="btn" style="background:#334155;flex:1;padding:8px;font-size:12px" onclick="dismissFlag(${i})">❌ N/A</button></div>`;h+=`</div>`;});h+=`</div></div>`;}
    // Financial
    if(s.financial){const f=s.financial;h+=`<div class="fin"><div style="font-size:13px;font-weight:700;color:#f1f5f9;margin-bottom:8px">💵 Financial</div>`;if(f.rvu)h+=`<div class="fr"><span class="fl2">LLM RVU</span><span class="fv">${esc(f.rvu)}</span></div>`;if(s.billingValidation?.correctedRVU)h+=`<div class="fr"><span class="fl2">Validated RVU</span><span class="fv g">${s.billingValidation.correctedRVU.toFixed(1)}</span></div>`;if(f.current)h+=`<div class="fr"><span class="fl2">Current</span><span class="fv">$${esc(f.current)}</span></div>`;if(f.potential)h+=`<div class="fr"><span class="fl2">With Gaps</span><span class="fv g">$${esc(f.potential)}</span></div>`;h+=`</div>`;}
    // Verify result
    if(s.verifyItems&&s.verifyItems.length){
      h+=`<div class="card" style="border-left:4px solid #f59e0b"><div class="card-h"><span class="title">🔍 Billing Audit</span><span style="font-size:11px;color:#94a3b8">${s.verifyItems.filter(i=>i.type==="GREEN").length}/${s.verifyItems.length} pass</span></div><div class="card-b">`;
      s.verifyItems.forEach((item,i)=>{
        const cls=item.type==="RED"?"red":item.type==="YELLOW"?"yellow":"green";
        h+=`<div class="fc ${cls}" style="margin-bottom:6px"><span class="fl">${item.type}</span> ${esc(item.text)}`;
        if(item.fix&&item.type!=="GREEN"){
          h+=`<div style="margin-top:6px;padding:8px;background:#020617;border-radius:6px;font-size:11px;color:#86efac;line-height:1.4">${esc(item.fix)}</div>`;
          h+=`<div style="display:flex;gap:6px;margin-top:6px"><button class="btn" style="background:${item.type==="RED"?"#dc2626":"#ca8a04"};flex:1;padding:8px;font-size:12px" onclick="applyVerifyFix(${i})" ${isL?"disabled":""}>⚡ Add to Note</button><button class="btn" style="background:#334155;flex:1;padding:8px;font-size:12px" onclick="state.verifyItems[${i}]={...state.verifyItems[${i}],type:'GREEN',text:state.verifyItems[${i}].text+' — N/A',fix:''};render()">❌ N/A</button></div>`;
        }
        h+=`</div>`;
      });
      if(s.verifyRVU)h+=`<div style="margin-top:8px;padding:10px;background:#020617;border-radius:8px;font-size:13px"><span style="color:#94a3b8">Audited RVU:</span> <span style="color:#86efac;font-weight:800">${esc(s.verifyRVU)}</span></div>`;
      h+=`</div></div>`;
    }else if(s.levelUpResult){h+=`<div class="card" style="border-left:4px solid #f59e0b"><div class="card-h"><span class="title">🔍 Billing Audit</span></div><div class="card-b" id="verifyBox"></div></div>`;}
    // Actions
    if(s.noteText&&s.billRaw){
      h+=`<button class="big" style="background:linear-gradient(135deg,#b45309,#d97706);margin-top:8px" onclick="verifyBilling()" ${isL?"disabled":""}>🔍 Verify Billing</button>`;
      h+=`<button id="coderBtn" class="big" style="background:#334155;margin-top:8px" onclick="sendToCoder(state.noteText,state.billRaw)">📧 Copy → Coder</button>`;
    }
    if(s._reopenedCase){
      h+=`<button class="big" style="background:linear-gradient(135deg,#059669,#10b981);margin-top:8px" onclick="saveBackToCase()">💾 Save to Case</button>`;
      h+=`<div style="font-size:11px;color:#475569;text-align:center;margin-top:4px">Editing saved case — changes won't persist until you save</div>`;
    }
    if(s.err)h+=`<div class="err"><div>${esc(s.err)}</div></div>`;
  }

  // ---- CASES VIEW ----
  if(s.view==="cases"){
    h+=`<div class="tabs" style="padding:3px">`;
    ["all","Draft","Operative","Clinic","Inpatient"].forEach(t=>{const n=t==="all"?s.cases.length:s.cases.filter(c=>c.cat===t||(t==="Draft"&&c.draft)).length;if(t==="Draft"&&n===0)return;h+=`<button class="tab ${s.caseTab===t?"on":""}" style="font-size:11px;padding:6px 0" onclick="setState({caseTab:'${t}'})">${t==="all"?"All":t} (${n})</button>`;});
    h+=`</div>`;
    const filtered=s.caseTab==="all"?s.cases:s.caseTab==="Draft"?s.cases.filter(c=>c.draft):s.cases.filter(c=>c.cat===s.caseTab&&!c.draft);
    if(!filtered.length)h+=`<div style="text-align:center;padding:40px;color:#475569;font-size:14px">${s.caseTab==="Draft"?"No drafts":"No cases yet"}</div>`;
    filtered.slice(0,50).forEach(c=>{
      if(c.draft){
        const pages=(c.capturedText||"").split("---PAGE BREAK---").length;
        h+=`<div class="case-btn" style="border-color:#7c3aed;background:#7c3aed10;cursor:default"><div style="display:flex;justify-content:space-between;align-items:start;gap:8px"><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:700;color:#c4b5fd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.proc||"Capture")}</div><div style="font-size:11px;color:#7c3aed;margin-top:2px">${esc(c.ts||"")} · ${pages} page${pages!==1?"s":""}</div><div style="font-size:11px;color:#475569;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc((c.capturedText||"").slice(0,80))}</div></div><span class="tag" style="background:#7c3aed30;color:#a78bfa">DRAFT</span></div><div style="display:flex;gap:6px;margin-top:8px"><button class="btn" style="background:#2563eb;flex:2;padding:8px;font-size:12px" onclick="openDraft('${c.id}')">📝 Open</button><button class="btn" style="background:#7c3aed;padding:8px;font-size:12px" onclick="addPageToDraft('${c.id}')">📷+</button><button class="btn" style="background:#7f1d1d;padding:8px;font-size:12px" onclick="if(confirm('Delete draft?'))deleteCase('${c.id}')">🗑️</button></div></div>`;
      }else{
        const tagColor=c.cat==="Operative"?"#1d4ed8":c.cat==="Clinic"?"#7c3aed":"#059669";
        h+=`<button class="case-btn" onclick="setState({selCase:state.cases.find(x=>x.id==='${c.id}'),view:'detail',detailNoteIdx:0})"><div style="display:flex;justify-content:space-between;align-items:start;gap:8px"><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:700;color:#e2e8f0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.proc||"Case")}</div><div style="font-size:11px;color:#475569;margin-top:2px">${esc(c.ts||c.date||"")}</div></div><span class="tag" style="background:${tagColor}30;color:${tagColor.replace("1d","60").replace("7c","a8").replace("05","34")}">${c.cat||""}</span></div></button>`;
      }
    });
    if(s.cases.length)h+=`<div style="display:flex;gap:8px;margin-top:12px"><button class="btn" style="background:#334155;flex:1" onclick="exportCases()">📥 Export</button><button class="btn" style="background:#334155;flex:1" onclick="pickImport()">📤 Import</button></div>`;
  }

  // ---- DETAIL VIEW ----
  if(s.view==="detail"&&s.selCase){
    const c=s.selCase;
    const notes=c.notes||[{type:c.cat==="Operative"?"operative":"clinic",note:c.note||"",billRaw:c.billRaw||"",dict:c.dict||""}];
    const ni=Math.min(s.detailNoteIdx||0,notes.length-1);
    const dn=notes[ni]||notes[0];
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="flex:1"><div style="font-size:16px;font-weight:800;color:#e2e8f0">${esc(c.proc||"Case")}</div><div style="font-size:11px;color:#475569">${esc(c.ts||c.date||"")}</div></div><div style="display:flex;gap:6px"><button class="btn" style="background:#334155" onclick="setState({view:'cases',selCase:null})">← Back</button></div></div>`;
    // Note tabs if multiple
    if(notes.length>1){h+=`<div style="display:flex;gap:4px;margin-bottom:10px;overflow-x:auto">`;notes.forEach((n,i)=>{h+=`<button class="btn" style="background:${i===ni?"#2563eb":"#1e293b"};padding:6px 12px;font-size:11px;white-space:nowrap" onclick="setState({detailNoteIdx:${i}})">${noteTypeLabel(n.type)} ${n.ts||""}</button>`;});h+=`</div>`;}
    // Copy + Note
    if(dn.note){
      h+=`<div style="display:flex;gap:8px;margin-bottom:10px"><button id="dCopyH" class="big" style="background:linear-gradient(135deg,#1d4ed8,#2563eb);flex:2" onclick="copyHTML(state.selCase.notes[${ni}].note,'dCopyH')">📋 Copy → EMR</button><button id="dCopyP" class="btn" style="background:#334155;padding:14px 12px;border-radius:12px;font-size:12px" onclick="copyPlain(state.selCase.notes[${ni}].note,'dCopyP')">Plain</button></div>`;
      h+=`<div class="card" style="border-left:4px solid #3b82f6"><div class="card-h"><span class="title">📋 Note</span></div><div class="card-b" id="detailNoteBox"></div></div>`;
    }
    // Billing
    if(dn.billRaw){
      const sec=parseBillFull(dn.billRaw);
      if(sec.codes){
        const cpts=[...new Set(sec.codes.split("\n").map(l=>{const m=l.match(/\b(\d{5})\b/);return m?m[1]:null;}).filter(Boolean))];
        h+=`<div class="card" style="border-left:4px solid #60a5fa"><div class="card-h"><span class="title">📋 CPT Codes</span></div><div class="card-b" style="font-family:monospace;font-size:14px;line-height:2;color:#60a5fa;font-weight:800">`;
        cpts.forEach(c=>{const rvu=RVU_TABLE[parseInt(c)];h+=`<div>${c}${rvu?` <span style="font-size:11px;color:#86efac;font-weight:400">${rvu} RVU</span>`:""}</div>`;});
        h+=`</div></div>`;
      }
      if(sec.mdm)h+=`<div class="card" style="border-left:4px solid #8b5cf6"><div class="card-h"><span class="title">🧠 E/M MDM Scoring</span></div><div class="card-b" id="detailMdmBox"></div></div>`;
      h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">💰 Code Detail</span></div><div class="card-b" id="detailBillBox"></div></div>`;
    }
    // Add Details
    h+=`<div class="card" style="border-left:4px solid #6366f1"><div class="card-h"><span class="title" style="font-size:13px;color:#c7d2fe">✏️ Add Details</span><button class="btn" style="background:${s.phase==="image"?"#2563eb":"#334155"}" onclick="pickDetailImage('${c.id}',${ni})" ${s.phase==="image"?"disabled":""}>${s.phase==="image"?"⏳ Analyzing...":"📷"}</button></div><div class="card-b"><textarea class="ta" rows="3" placeholder="Add details, paste imaging, or capture photo..." oninput="state.detailAddendText=this.value">${esc(s.detailAddendText||"")}</textarea>`;
    const daDis=!(s.detailAddendText||"").trim()||isL;
    h+=`<div style="display:flex;gap:6px;margin-top:8px"><button class="btn" style="background:${daDis?"#1e293b":"#6366f1"};flex:2;padding:10px;font-size:12px;opacity:${daDis?0.4:1}" onclick="detailAddend('${c.id}',${ni},state.detailAddendText,'note')" ${daDis?"disabled":""}>✅ Add</button></div>`;
    h+=`<div style="display:flex;gap:6px;margin-top:4px"><button class="btn" style="background:${daDis?"#1e293b":"#7c3aed"};flex:1;padding:8px;font-size:11px;opacity:${daDis?0.4:1}" onclick="detailAddend('${c.id}',${ni},state.detailAddendText,'hpi')" ${daDis?"disabled":""}>📝 HPI</button><button class="btn" style="background:${daDis?"#1e293b":"#2563eb"};flex:1;padding:8px;font-size:11px;opacity:${daDis?0.4:1}" onclick="detailAddend('${c.id}',${ni},state.detailAddendText,'ap')" ${daDis?"disabled":""}>📋 A/P</button><button class="btn" style="background:${daDis?"#1e293b":"#059669"};flex:1;padding:8px;font-size:11px;opacity:${daDis?0.4:1}" onclick="detailAddend('${c.id}',${ni},state.detailAddendText,'exam')" ${daDis?"disabled":""}>🩺 Exam</button></div></div></div>`;
    if(isL)h+=`<div class="ld">${ph[s.phase]||"Processing..."}</div>`;
    if(s.err)h+=`<div class="err"><div>${esc(s.err)}</div></div>`;
    // Actions
    h+=`<div style="display:flex;gap:8px;margin-top:8px"><button class="btn" style="background:linear-gradient(135deg,#b45309,#d97706);flex:1" onclick="reopenCase('${c.id}',${ni})">🔓 Full Edit</button><button class="btn" style="background:#1e3a5f;flex:1" onclick="setState({view:'input',text:'',linkedTo:'${c.id}',nt:'progress'})">+ Linked</button><button class="btn" style="background:#7f1d1d" onclick="if(confirm('Delete?'))deleteCase('${c.id}')">🗑️</button></div>`;
  }

  // ---- STATS VIEW ----
  if(s.view==="stats"){
    const total=s.cases.filter(c=>!c.draft).length;
    const ops=s.cases.filter(c=>c.cat==="Operative"&&!c.draft).length;
    const clin=s.cases.filter(c=>c.cat==="Clinic"&&!c.draft).length;
    const inp=s.cases.filter(c=>c.cat==="Inpatient"&&!c.draft).length;
    const drafts=s.cases.filter(c=>c.draft).length;
    const allCpts=s.cases.flatMap(c=>{const bill=c.billRaw||"";return[...bill.matchAll(/\b(\d{5})\b/g)].map(m=>m[1]);});
    const cptCounts={};allCpts.forEach(c=>{cptCounts[c]=(cptCounts[c]||0)+1;});
    const topCpts=Object.entries(cptCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">`;
    h+=`<div style="background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;text-align:center"><div style="font-size:28px;font-weight:800;color:#60a5fa">${total}</div><div style="font-size:11px;color:#475569">Total Cases</div></div>`;
    h+=`<div style="background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;text-align:center"><div style="font-size:28px;font-weight:800;color:#f87171">${ops}</div><div style="font-size:11px;color:#475569">Operative</div></div>`;
    h+=`<div style="background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;text-align:center"><div style="font-size:28px;font-weight:800;color:#a78bfa">${clin}</div><div style="font-size:11px;color:#475569">Clinic</div></div>`;
    h+=`<div style="background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;text-align:center"><div style="font-size:28px;font-weight:800;color:#34d399">${inp}</div><div style="font-size:11px;color:#475569">Inpatient</div></div>`;
    h+=`</div>`;
    if(topCpts.length){
      h+=`<div class="card"><div class="card-h"><span class="title">Top CPT Codes</span></div><div class="card-b"><table><thead><tr><th>CPT</th><th>Count</th><th>RVU</th></tr></thead><tbody>`;
      topCpts.forEach(([c,n])=>{const rvu=RVU_TABLE[parseInt(c)];h+=`<tr><td style="font-weight:700;color:#60a5fa">${c}</td><td>${n}</td><td style="color:#86efac">${rvu||"—"}</td></tr>`;});
      h+=`</tbody></table></div></div>`;
    }
  }

  // ---- APPLY ----
  app.innerHTML=h;

  // Post-render DOM updates
  if(s.view==="output"&&!s.editing){const nb=document.getElementById("noteBox");if(nb)renderNote(nb,s.noteText);}
  if(s.view==="output"){
    const cb=document.getElementById("codesBox");if(cb)renderBillingCodes(cb,s.billCodes);
    const mdmB=document.getElementById("mdmBox");if(mdmB)renderMDM(mdmB,s.billMDM);
    const mb=document.getElementById("modBox");if(mb)renderNote(mb,s.billMod);
    const ib=document.getElementById("icdBox");if(ib)renderNote(ib,s.billICD);
    const bb=document.getElementById("bundleBox");if(bb)renderNote(bb,s.billBundle);
    const pb=document.getElementById("preauthBox");if(pb)renderNote(pb,s.billPreauth);
    const vb=document.getElementById("verifyBox");if(vb&&s.levelUpResult)renderNote(vb,s.levelUpResult);
  }
  if(s.view==="detail"&&s.selCase){
    const notes=s.selCase.notes||[{note:s.selCase.note||"",billRaw:s.selCase.billRaw||""}];
    const ni=Math.min(s.detailNoteIdx||0,notes.length-1);
    const dn=notes[ni];
    const dnb=document.getElementById("detailNoteBox");if(dnb)renderNote(dnb,dn.note);
    if(dn.billRaw){const dsec=parseBillFull(dn.billRaw);const dbb=document.getElementById("detailBillBox");if(dbb)renderBillingCodes(dbb,dsec.codes);const dmb=document.getElementById("detailMdmBox");if(dmb)renderMDM(dmb,dsec.mdm);}
  }
  if(s.view==="auth"&&authState.letter){const al=document.getElementById("authLetter");if(al)renderNote(al,authState.letter);}
}

// ---- INIT ----
render();
</script>
</body>
</html>
