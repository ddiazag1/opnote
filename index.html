<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OpNote">
<meta name="theme-color" content="#020617">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23020617' width='100' height='100' rx='20'/><text x='50' y='68' text-anchor='middle' font-size='50' fill='%233b82f6'>üß†</text></svg>">
<title>OpNote Intelligence v9.2</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#020617;color:#cbd5e1;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh;-webkit-tap-highlight-color:transparent}
.w{max-width:640px;margin:0 auto;padding:12px 12px 120px;padding-bottom:max(120px,calc(120px + env(safe-area-inset-bottom)))}
button,select{cursor:pointer;-webkit-appearance:none}
textarea,input,select{-webkit-appearance:none;outline:none}
.btn{padding:6px 14px;border-radius:8px;font-size:11px;font-weight:700;border:none;color:#fff;transition:all .15s;min-height:40px}
.big{width:100%;padding:14px;border-radius:12px;font-size:15px;font-weight:700;border:none;color:#fff;transition:all .15s;min-height:48px}
.card{border-radius:12px;border:1px solid #1e293b;margin-bottom:12px;overflow:hidden;background:#0c1220}
.card-h{display:flex;justify-content:space-between;align-items:center;padding:10px 14px}
.card-h .title{font-size:14px;font-weight:700;color:#f1f5f9}
.card-b{padding:14px;max-height:600px;overflow-y:auto}
.tabs{display:flex;gap:4px;margin-bottom:12px;background:#0f172a;border-radius:10px;padding:4px}
.tab{flex:1;padding:10px 0;border-radius:8px;font-size:12px;font-weight:700;border:none;color:#475569;background:transparent;transition:all .15s}
.tab.on{background:#334155;color:#fff}
.inp{width:100%;padding:10px 12px;border-radius:8px;font-size:13px;background:#020617;border:1px solid #1e293b;color:#e2e8f0}
.ta{width:100%;background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;font-size:14px;font-family:-apple-system,sans-serif;color:#e2e8f0;resize:none;line-height:1.6}
.sel{width:100%;padding:12px 14px;border-radius:10px;font-size:14px;font-weight:600;background:#0f172a;border:1px solid #1e293b;color:#e2e8f0;margin-bottom:8px}
.rec-btn{width:100%;padding:22px;border-radius:14px;font-size:18px;font-weight:800;border:none;color:#fff;display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px;transition:all .2s}
.rec-btn.idle{background:linear-gradient(135deg,#1e293b,#334155);border:2px solid #475569}
.rec-btn.recording{background:linear-gradient(135deg,#991b1b,#dc2626);border:2px solid #f87171;animation:pulse 1.5s infinite}
.rec-btn.transcribing{background:linear-gradient(135deg,#1e3a5f,#2563eb);border:2px solid #60a5fa}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.timer{font-variant-numeric:tabular-nums;font-size:16px}
.slabel{font-size:13px;font-weight:800;color:#fff;margin-top:12px;margin-bottom:3px;letter-spacing:.3px}
table{width:100%;border-collapse:collapse;font-size:12px;border-radius:6px;overflow:hidden}
th{padding:6px 10px;text-align:left;font-weight:700;color:#94a3b8;background:#0f172a;border-bottom:1px solid #1e293b}
td{padding:5px 10px;color:#cbd5e1;border-bottom:1px solid #0f172a0a}
tr:nth-child(odd) td{background:#060a14}tr:nth-child(even) td{background:#0a1020}
.ma{background:linear-gradient(135deg,#78350f,#92400e);color:#fbbf24;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;display:inline;margin:0 2px}
.mi{background:linear-gradient(135deg,#7f1d1d,#991b1b);color:#fca5a5;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer;display:inline;margin:0 2px}
.md2{background:linear-gradient(135deg,#14532d,#166534);color:#86efac;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;display:inline;margin:0 2px}
.ma:hover,.mi:hover{opacity:.7;text-decoration:line-through}
.gc{background:#0f172a;border:1px solid #1e293b;border-radius:10px;margin-bottom:8px;overflow:hidden}
.gc.ck{border-color:#eab308;background:#0f1a10}
.gc.g-high{border-color:#7f1d1d;background:#450a0a20}
.gc.g-med{border-color:#92400e;background:#78350f20}
.gc.g-low{border-color:#1e3a5f;background:#1e3a5f20}
.gh{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer}
.gh input[type=checkbox]{width:20px;height:20px;accent-color:#eab308;flex-shrink:0}
.gi{font-size:10px;font-weight:800;padding:2px 8px;border-radius:4px;flex-shrink:0}
.gi.high{background:#7f1d1d;color:#fca5a5}.gi.med{background:#78350f;color:#fbbf24}.gi.low{background:#1e3a5f;color:#93c5fd}
.gt{font-size:13px;color:#cbd5e1;line-height:1.5;flex:1}
.gb{padding:4px 12px 10px 46px;font-size:12px;color:#94a3b8;line-height:1.5}
.gl{background:#020617;border:1px solid #1e293b;border-radius:6px;padding:8px 10px;margin-top:6px;font-size:12px;color:#86efac;line-height:1.4}
.gib{margin-top:8px;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700;border:none;color:#fff;background:linear-gradient(135deg,#a16207,#ca8a04)}
.qc{background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:8px}
.qt{font-size:13px;color:#cbd5e1;margin-bottom:8px}
.qi{width:100%;padding:8px 10px;border-radius:6px;font-size:12px;background:#020617;border:1px solid #1e293b;color:#86efac;margin-bottom:8px}
.qb{padding:6px 14px;border-radius:6px;font-size:11px;font-weight:700;border:none;color:#fff;background:#7c3aed}
.fc{border-radius:10px;padding:12px;margin-bottom:8px;font-size:13px;line-height:1.5}
.fc.red{background:rgba(220,38,38,0.25);border:2px solid #ef4444;color:#fca5a5}
.fc.yellow{background:rgba(234,179,8,0.2);border:2px solid #eab308;color:#fef08a}
.fc.green{background:rgba(34,197,94,0.15);border:2px solid #22c55e;color:#86efac}
.fc .fl{font-size:10px;font-weight:800;padding:3px 8px;border-radius:4px;margin-right:6px;display:inline-block;margin-bottom:6px}
.fc.red .fl{background:#dc2626;color:#fff}.fc.yellow .fl{background:#eab308;color:#000}.fc.green .fl{background:#22c55e;color:#000}
.fc .finp{width:100%;padding:8px;border-radius:6px;font-size:12px;background:#020617;border:1px solid #1e293b;color:#e2e8f0;margin-top:8px}
.fc .finc{margin-top:8px;padding:6px 14px;border-radius:6px;font-size:11px;font-weight:700;border:none;color:#fff}
.fc.red .finc{background:#dc2626}.fc.yellow .finc{background:#ca8a04}
.fin{background:linear-gradient(135deg,#0f172a,#1e293b40);border:1px solid #1e293b;border-radius:12px;padding:14px;margin-top:10px}
.fr{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1e293b40}.fr:last-child{border:none}
.fl2{font-size:12px;color:#94a3b8}.fv{font-size:14px;font-weight:700;color:#e2e8f0}
.fv.g{color:#86efac}.fv.y{color:#fde047}
.wu-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #1e293b20}
.wu-row input{width:18px;height:18px;accent-color:#06b6d4;flex-shrink:0}.wu-row span{font-size:13px;color:#cbd5e1}
.case-btn{width:100%;text-align:left;background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:8px;display:block}
.case-btn:active{background:#1e293b}
.tag{font-size:10px;padding:2px 8px;border-radius:5px;font-weight:600}
.edit-ta{width:100%;min-height:300px;background:#0f172a;border:1px solid #1e293b;border-radius:8px;padding:12px;font-size:13px;font-family:monospace;color:#e2e8f0;resize:vertical;line-height:1.6}
.err{margin-top:8px;padding:12px;background:linear-gradient(135deg,#450a0a,#7f1d1d20);border:1px solid #7f1d1d;border-radius:10px}
.err div{color:#f87171;font-size:12px;word-break:break-all}
.ld{padding:12px 0;text-align:center;font-size:13px;color:#60a5fa;font-weight:600}
.rename-inp{background:#020617;border:1px solid #1e293b;border-radius:6px;padding:6px 8px;font-size:14px;color:#e2e8f0;font-weight:700;width:100%}
.mf{background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:10px}
.mf-row{margin-bottom:10px}
.mf-label{font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;letter-spacing:.3px}
.mf-inp{width:100%;padding:8px 10px;border-radius:6px;font-size:13px;background:#020617;border:1px solid #1e293b;color:#e2e8f0}
.mf-pills{display:flex;flex-wrap:wrap;gap:6px}
.mf-pill{padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;border:1px solid #1e293b;background:#020617;color:#94a3b8}
.mf-pill.on{background:#1d4ed8;border-color:#2563eb;color:#fff}
.img-btn{padding:10px 16px;border-radius:10px;font-size:13px;font-weight:700;border:1px solid #1e293b;background:#0f172a;color:#cbd5e1;display:flex;align-items:center;gap:8px;margin-bottom:10px}
.img-btn:active{background:#1e293b}
.tt{font-size:11px;color:#475569;text-align:center;margin-top:6px}
.tt span{color:#60a5fa;font-weight:600}
.ln-tabs{display:flex;gap:4px;margin-bottom:8px;overflow-x:auto}
.ln-tab{padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700;border:1px solid #1e293b;background:#020617;color:#475569;white-space:nowrap;flex-shrink:0}
.ln-tab.on{background:#334155;border-color:#475569;color:#fff}
</style>
</head>
<body>
<div id="app" class="w"></div>
<div id="odModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.85);overflow:auto">
  <div style="max-width:500px;margin:20px auto;background:#0f172a;border:1px solid #1e293b;border-radius:16px;overflow:hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#020617;border-bottom:1px solid #1e293b">
      <div id="odTitle" style="font-size:15px;font-weight:800;color:#e2e8f0">üìÇ OneDrive</div>
      <button onclick="closeOD()" style="background:none;border:none;color:#64748b;font-size:20px;padding:4px 8px">‚úï</button>
    </div>
    <div id="odPath" style="padding:8px 16px;font-size:11px;color:#475569;border-bottom:1px solid #0f172a"></div>
    <div id="odBody" style="padding:8px 16px;min-height:200px;max-height:60vh;overflow-y:auto"></div>
  </div>
</div>
<script>
// Dynamic MSAL loader with fallbacks
(function(){
  var cdns=[
    "https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js",
    "https://alcdn.msftauth.net/browser/2.38.3/js/msal-browser.min.js",
    "https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"
  ];
  var idx=0;
  function tryLoad(){
    if(idx>=cdns.length){console.error("All MSAL CDNs failed");return;}
    var s=document.createElement("script");
    s.src=cdns[idx];
    s.onload=function(){console.log("MSAL loaded from:",cdns[idx]);};
    s.onerror=function(){console.warn("MSAL CDN failed:",cdns[idx]);idx++;tryLoad();};
    document.head.appendChild(s);
  }
  tryLoad();
})();
</script>
<script>
// API key ‚Äî user enters once, saved in localStorage
let API_KEY=localStorage.getItem("opnote-api-key")||"";

// Auto-import API key from URL hash (e.g. #key=sk-ant-...)
(function(){
  const h=window.location.hash;
  if(h.startsWith("#key=")){
    const k=decodeURIComponent(h.slice(5));
    if(k.startsWith("sk-ant-")){
      API_KEY=k;
      localStorage.setItem("opnote-api-key",k);
      window.history.replaceState(null,"",window.location.pathname);// clear hash
      setTimeout(()=>alert("‚úÖ API key saved! You're ready to go."),500);
    }
  }
})();

// ==== ONEDRIVE CONFIG ====
// Replace with your Azure App Registration client ID
const OD_CLIENT_ID=localStorage.getItem("opnote-od-clientid")||"93ac9684-2a1b-4c06-8f49-6ae76e00ffc7";
const OD_AUTHORITY="https://login.microsoftonline.com/common";
const OD_SCOPES=["Files.ReadWrite.All","User.Read"];
let msalApp=null;
let odAccount=null;
let odPath=[];// breadcrumb stack [{name,id}]

function initMSAL(){
  if(!OD_CLIENT_ID||msalApp)return;
  if(typeof msal==="undefined"){
    console.warn("MSAL not yet loaded, will retry on next call");
    return;
  }
  try{
    msalApp=new msal.PublicClientApplication({auth:{clientId:OD_CLIENT_ID,authority:OD_AUTHORITY,redirectUri:window.location.origin+window.location.pathname},cache:{cacheLocation:"localStorage"}});
    console.log("MSAL redirect URI:",window.location.origin+window.location.pathname);
    // REQUIRED: handle redirect promise before any other MSAL calls
    msalApp.handleRedirectPromise().then(resp=>{
      if(resp&&resp.account){odAccount=resp.account;render();}
    }).catch(e=>console.error("MSAL redirect:",e));
    // Check for existing session
    const accts=msalApp.getAllAccounts();
    if(accts.length)odAccount=accts[0];
    console.log("MSAL initialized, accounts:",accts.length);
  }catch(e){console.error("MSAL init:",e);msalApp=null;}
}

async function odLogin(){
  initMSAL();// ensure initialized
  if(!msalApp){
    if(typeof msal==="undefined"){
      alert("OneDrive: Microsoft authentication library is still loading or was blocked.\n\n1. Disable any ad blockers for this site\n2. Refresh the page\n3. Try again\n\nIf it persists, try a different browser (Chrome works best).");
    }else{
      alert("OneDrive error: Could not initialize. Check your Client ID in Settings ‚Üí Reset Client ID and re-enter it.");
    }
    return null;
  }
  try{
    // Try silent first
    if(odAccount){
      const r=await msalApp.acquireTokenSilent({scopes:OD_SCOPES,account:odAccount});
      return r.accessToken;
    }
  }catch{}
  // Try popup login first
  try{
    const r=await msalApp.loginPopup({scopes:OD_SCOPES,prompt:"select_account"});
    odAccount=r.account;
    const t=await msalApp.acquireTokenSilent({scopes:OD_SCOPES,account:odAccount});
    odLoadData();
    return t.accessToken;
  }catch(e){
    console.error("OD popup login:",e);
    if(e.errorCode==="popup_window_error"||e.errorCode==="empty_window_error"){
      // Popup blocked ‚Äî fall back to redirect
      try{
        await msalApp.loginRedirect({scopes:OD_SCOPES,prompt:"select_account"});
        return null;// page will redirect
      }catch(e2){
        alert("Sign-in failed. Please allow popups for this site and try again.\n\nError: "+(e2.message||e2));
      }
    }else if(e.errorCode==="user_cancelled"){
      // user closed popup, no alert needed
    }else if(e.message&&e.message.includes("redirect_uri")){
      alert("Redirect URI mismatch!\n\nGo to Azure Portal ‚Üí App registrations ‚Üí OpNote Intelligence ‚Üí Authentication\n\nAdd this EXACT redirect URI as a Single-page application:\n\n"+window.location.origin+window.location.pathname+"\n\n(Copy from the browser console if needed)");
    }else{
      alert("OneDrive sign-in error:\n\n"+(e.errorMessage||e.message||JSON.stringify(e)));
    }
    return null;
  }
}

async function odGetToken(){
  if(!msalApp||!odAccount)return await odLogin();
  try{
    const r=await msalApp.acquireTokenSilent({scopes:OD_SCOPES,account:odAccount});
    return r.accessToken;
  }catch{return await odLogin();}
}

async function odListFolder(folderId){
  const token=await odGetToken();
  if(!token)return[];
  const url=folderId
    ?`https://graph.microsoft.com/v1.0/me/drive/items/${folderId}/children?$top=200&$orderby=name`
    :`https://graph.microsoft.com/v1.0/me/drive/root/children?$top=200&$orderby=name`;
  try{
    const r=await fetch(url,{headers:{Authorization:`Bearer ${token}`}});
    if(!r.ok)throw new Error(r.status);
    const d=await r.json();
    return(d.value||[]).map(i=>({id:i.id,name:i.name,isFolder:!!i.folder,size:i.size||0,modified:i.lastModifiedDateTime||""}));
  }catch(e){console.error("OD list:",e);return[];}
}

async function odDownloadFile(fileId){
  const token=await odGetToken();
  if(!token)return null;
  try{
    const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`,{headers:{Authorization:`Bearer ${token}`}});
    if(!r.ok)throw new Error(r.status);
    return await r.text();
  }catch(e){console.error("OD download:",e);return null;}
}

function openOD(){
  initMSAL();
  if(!OD_CLIENT_ID){
    // Show setup instructions
    const b=document.getElementById("odBody");
    b.innerHTML=`<div style="padding:20px 0">
      <div style="font-size:14px;font-weight:700;color:#e2e8f0;margin-bottom:12px">‚öôÔ∏è OneDrive Setup Required</div>
      <div style="font-size:12px;color:#94a3b8;line-height:1.7;margin-bottom:16px">
        Enter your Azure App Client ID below.<br><br>
        <b style="color:#e2e8f0">One-time setup (5 min):</b><br>
        1. Go to <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" style="color:#60a5fa">portal.azure.com ‚Üí App registrations</a><br>
        2. Click <b>New registration</b><br>
        3. Name: <b>OpNote Intelligence</b><br>
        4. Account type: <b>Personal + Work/School</b><br>
        5. Redirect URI ‚Üí <b>Single-page application</b> ‚Üí enter: <b>${window.location.origin+window.location.pathname}</b><br>
        6. Click <b>Register</b><br>
        7. Copy the <b>Application (client) ID</b><br>
        8. Go to <b>API permissions</b> ‚Üí Add ‚Üí Microsoft Graph ‚Üí Delegated ‚Üí <b>Files.ReadWrite.All</b> ‚Üí Add<br>
        9. Paste Client ID below
      </div>
      <input id="odClientInput" class="inp" placeholder="Paste Application (client) ID here..." style="margin-bottom:8px;font-size:13px">
      <button class="big" style="background:linear-gradient(135deg,#1d4ed8,#2563eb)" onclick="saveODClient()">üíæ Save & Connect</button>
    </div>`;
    document.getElementById("odModal").style.display="block";
    return;
  }
  odPath=[{name:"My Files",id:null}];
  document.getElementById("odModal").style.display="block";
  renderODFolder(null);
}

function saveODClient(){
  const v=document.getElementById("odClientInput").value.trim();
  if(!v||v.length<10){alert("Invalid Client ID");return;}
  localStorage.setItem("opnote-od-clientid",v);
  location.reload();
}

function closeOD(){document.getElementById("odModal").style.display="none";}

async function renderODFolder(folderId){
  const b=document.getElementById("odBody");
  const p=document.getElementById("odPath");
  b.innerHTML=`<div style="text-align:center;padding:30px;color:#64748b">Loading...</div>`;
  p.innerHTML=odPath.map((s,i)=>`<span style="cursor:pointer;color:${i===odPath.length-1?"#e2e8f0":"#60a5fa"}" onclick="odNav(${i})">${s.name}</span>`).join(` <span style="color:#334155">/</span> `);
  const items=await odListFolder(folderId);
  if(!items.length){b.innerHTML=`<div style="text-align:center;padding:30px;color:#64748b">Empty folder</div>`;return;}
  let h="";
  // Folders first, then files
  const folders=items.filter(i=>i.isFolder);
  const files=items.filter(i=>!i.isFolder);
  folders.forEach(f=>{
    h+=`<div onclick="odOpenFolder('${f.id}','${f.name.replace(/'/g,"\\'")}')" style="display:flex;align-items:center;gap:10px;padding:12px 4px;border-bottom:1px solid #1e293b;cursor:pointer">
      <span style="font-size:20px">üìÅ</span>
      <div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;color:#e2e8f0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name}</div></div>
      <span style="color:#334155;font-size:16px">‚Ä∫</span>
    </div>`;
  });
  files.forEach(f=>{
    const ext=f.name.split(".").pop().toLowerCase();
    const isTxt=["txt","text","rtf","doc","log","md","csv"].includes(ext);
    const icon=isTxt?"üìÑ":"üìé";
    const sz=f.size>1048576?(f.size/1048576).toFixed(1)+"MB":f.size>1024?(f.size/1024).toFixed(0)+"KB":f.size+"B";
    const clickable=isTxt?`onclick="odPickFile('${f.id}','${f.name.replace(/'/g,"\\'")}')"`:``; 
    const style=isTxt?"cursor:pointer":"cursor:default;opacity:0.4";
    h+=`<div ${clickable} style="display:flex;align-items:center;gap:10px;padding:12px 4px;border-bottom:1px solid #1e293b;${style}">
      <span style="font-size:20px">${icon}</span>
      <div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;color:${isTxt?"#e2e8f0":"#475569"};overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name}</div>
      <div style="font-size:10px;color:#475569">${sz}</div></div>
    </div>`;
  });
  b.innerHTML=h;
}

function odOpenFolder(id,name){
  odPath.push({name,id});
  renderODFolder(id);
}

function odNav(idx){
  odPath=odPath.slice(0,idx+1);
  renderODFolder(odPath[idx].id);
}

async function odPickFile(id,name){
  const b=document.getElementById("odBody");
  b.innerHTML=`<div style="text-align:center;padding:30px;color:#60a5fa">‚è≥ Loading ${name}...</div>`;
  const txt=await odDownloadFile(id);
  if(txt){
    state.text=txt;
    closeOD();
    render();
  }else{
    b.innerHTML=`<div style="text-align:center;padding:30px;color:#f87171">Failed to load file</div>`;
  }
}

// ==== ONEDRIVE CLOUD SYNC (auto read/write cases) ====
const OD_SYNC_PATH="OpNote";
const OD_SYNC_FILE="opnote-data.json";
let odSyncStatus="idle"; // idle, syncing, synced, error
let odSyncDebounce=null;

async function odEnsureFolder(){
  const token=await odGetToken();if(!token)return null;
  // Check if OpNote folder exists
  try{
    const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${OD_SYNC_PATH}`,{headers:{Authorization:`Bearer ${token}`}});
    if(r.ok){const d=await r.json();return d.id;}
  }catch{}
  // Create it
  try{
    const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/root/children`,{method:"POST",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},body:JSON.stringify({name:OD_SYNC_PATH,folder:{},conflictBehavior:"fail"})});
    if(r.ok){const d=await r.json();return d.id;}
  }catch{}
  return null;
}

async function odSaveData(){
  if(!msalApp||!odAccount)return;
  odSyncStatus="syncing";render();
  try{
    const token=await odGetToken();if(!token)throw new Error("no token");
    const cases=ls(SK,[]);
    const blob=JSON.stringify(cases,null,2);
    const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${OD_SYNC_PATH}/${OD_SYNC_FILE}:/content`,{
      method:"PUT",
      headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},
      body:blob
    });
    if(!r.ok)throw new Error(r.status);
    odSyncStatus="synced";
    console.log("OD sync: saved",cases.length,"cases");
  }catch(e){
    odSyncStatus="error";
    console.error("OD save:",e);
  }
  render();
}

function odSaveDebounced(){
  if(!msalApp||!odAccount)return;
  clearTimeout(odSyncDebounce);
  odSyncDebounce=setTimeout(()=>odSaveData(),2000);
}

async function odLoadData(){
  if(!msalApp||!odAccount)return;
  odSyncStatus="syncing";render();
  try{
    const token=await odGetToken();if(!token)throw new Error("no token");
    const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${OD_SYNC_PATH}/${OD_SYNC_FILE}:/content`,{headers:{Authorization:`Bearer ${token}`}});
    if(r.status===404){
      // No cloud data yet ‚Äî push local up
      odSyncStatus="synced";render();
      await odSaveData();
      return;
    }
    if(!r.ok)throw new Error(r.status);
    const cloud=JSON.parse(await r.text());
    if(!Array.isArray(cloud)){odSyncStatus="synced";render();return;}
    // Merge: cloud + local, dedup by id, keep newest version
    const local=ls(SK,[]);
    const merged=new Map();
    cloud.forEach(c=>{if(c.id)merged.set(c.id,c);});
    local.forEach(c=>{if(c.id){
      const existing=merged.get(c.id);
      if(!existing||((c.ts||"")>(existing.ts||"")))merged.set(c.id,c);
    }});
    const all=[...merged.values()].sort((a,b)=>(b.ts||"").localeCompare(a.ts||""));
    lsS_local(SK,all);// save locally without re-triggering cloud sync
    state.cases=all;
    odSyncStatus="synced";
    console.log("OD sync: loaded",all.length,"cases ("+cloud.length+" cloud, "+local.length+" local)");
    render();
  }catch(e){
    odSyncStatus="error";
    console.error("OD load:",e);
    render();
  }
}

// Local-only save (no cloud trigger, prevents infinite loop)
function lsS_local(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
const TODAY=new Date().toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"});
const SK="opnote-cases";
function ls(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}}
function lsS(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{} if(k===SK){if(syncDirHandle)syncSave();odSaveDebounced();}}
function migrateCases(){let a=ls(SK,[]);const ids=new Set(a.map(c=>c.id));["on3-cases","on32-cases","on4-cases","on5-cases","on6-cases"].forEach(k=>{ls(k,[]).forEach(c=>{if(c.id&&!ids.has(c.id)){a.push(c);ids.add(c.id);}});localStorage.removeItem(k);});a.sort((a,b)=>(b.ts||"").localeCompare(a.ts||""));lsS(SK,a);return a;}
// ---- EXPORT/IMPORT with Web Share API ----
function exportFileName(){return"opnote-backup-"+new Date().toISOString().slice(0,10)+".json";}
function shareKeyToPhone(){
  if(!API_KEY){alert("Set your API key first.");return;}
  setState({showQR:true,showSettings:true});
}

async function exportCases(){
  const d=JSON.stringify(ls(SK,[]),null,2);
  const blob=new Blob([d],{type:"application/json"});
  const file=new File([blob],exportFileName(),{type:"application/json"});
  // Try Web Share API (iOS share sheet ‚Üí OneDrive/Files/AirDrop)
  if(navigator.canShare&&navigator.canShare({files:[file]})){
    try{await navigator.share({files:[file],title:"OpNote Backup",text:"OpNote cases backup"});return;}catch(e){if(e.name==="AbortError")return;}
  }
  // Fallback: direct download
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=exportFileName();a.click();URL.revokeObjectURL(a.href);
}
function importCases(f){
  if(!f)return;
  const r=new FileReader();r.onload=e=>{try{
    const imp=JSON.parse(e.target.result);if(!Array.isArray(imp)){alert("Invalid file");return;}
    const cur=ls(SK,[]);const ids=new Set(cur.map(c=>c.id));let n=0,u=0;
    imp.forEach(c=>{if(!c.id)return;if(ids.has(c.id)){u++;}else{cur.push(c);ids.add(c.id);n++;}});
    cur.sort((a,b)=>(b.ts||"").localeCompare(a.ts||""));lsS(SK,cur);setState({cases:cur});
    alert(n+" new case"+(n!==1?"s":"")+" imported"+(u?" ("+u+" already existed)":""));
  }catch{alert("Import error ‚Äî invalid JSON");}};r.readAsText(f);
}
function pickImport(){const inp=document.createElement("input");inp.type="file";inp.accept=".json,application/json";inp.onchange=()=>{if(inp.files[0])importCases(inp.files[0]);};inp.click();}

// Load raw op note text file from Files/OneDrive
function pickOpNote(){
  const inp=document.createElement("input");inp.type="file";
  inp.accept=".txt,.text,.doc,.rtf,text/plain";
  inp.onchange=()=>{
    if(!inp.files[0])return;
    const f=inp.files[0];
    const r=new FileReader();
    r.onload=e=>{
      const txt=e.target.result.trim();
      if(txt){state.text=txt;render();
        const ta=document.getElementById("mainInput");if(ta){ta.value=txt;ta.dispatchEvent(new Event("input"));}
      }
    };
    r.readAsText(f);
  };
  inp.click();
}

// ---- CLOUD SYNC (universal ‚Äî works on desktop + iPhone) ----
const HAS_FSAPI=typeof window.showDirectoryPicker==="function";
const IS_IOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(/Macintosh/.test(navigator.userAgent)&&"ontouchend" in document);
let syncDirHandle=null;
let syncStatus="none";

// IndexedDB to persist directory handle across sessions (desktop Chrome only)
function openSyncDB(){return new Promise((res,rej)=>{const r=indexedDB.open("opnote-sync",1);r.onupgradeneeded=()=>r.result.createObjectStore("handles");r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
async function storeSyncHandle(handle){try{const db=await openSyncDB();const tx=db.transaction("handles","readwrite");tx.objectStore("handles").put(handle,"syncDir");await new Promise((r,j)=>{tx.oncomplete=r;tx.onerror=j;});}catch{}}
async function getSyncHandle(){try{const db=await openSyncDB();return new Promise((res)=>{const tx=db.transaction("handles","readonly");const r=tx.objectStore("handles").get("syncDir");r.onsuccess=()=>res(r.result||null);r.onerror=()=>res(null);});}catch{return null;}}

async function pickSyncFolder(){
  try{
    syncDirHandle=await window.showDirectoryPicker({mode:"readwrite"});
    await storeSyncHandle(syncDirHandle);
    syncStatus="ready";
    await syncSave();
    render();
  }catch(e){if(e.name!=="AbortError"){syncStatus="error";render();}}
}

async function syncSave(){
  if(!syncDirHandle)return;
  try{
    syncStatus="syncing";
    const fh=await syncDirHandle.getFileHandle("opnote-data.json",{create:true});
    const wr=await fh.createWritable();
    await wr.write(JSON.stringify(ls(SK,[]),null,2));
    await wr.close();
    syncStatus="ready";
  }catch(e){syncStatus="error";console.error("Sync save:",e);}
}

async function syncLoad(){
  if(!syncDirHandle)return false;
  try{
    const fh=await syncDirHandle.getFileHandle("opnote-data.json");
    const file=await fh.getFile();
    const txt=await file.text();
    const data=JSON.parse(txt);
    if(Array.isArray(data)&&data.length){
      // Merge: cloud data + local, dedup by id
      const local=ls(SK,[]);const ids=new Set(local.map(c=>c.id));
      let added=0;
      data.forEach(c=>{if(c.id&&!ids.has(c.id)){local.push(c);ids.add(c.id);added++;}});
      local.sort((a,b)=>(b.ts||"").localeCompare(a.ts||""));
      lsS(SK,local);
      return true;
    }
  }catch(e){if(e.name!=="NotFoundError")console.error("Sync load:",e);}
  return false;
}

async function initSync(){
  if(!HAS_FSAPI)return;
  const handle=await getSyncHandle();
  if(!handle)return;
  try{
    const perm=await handle.queryPermission({mode:"readwrite"});
    if(perm==="granted"){syncDirHandle=handle;syncStatus="ready";await syncLoad();}
    else{
      const req=await handle.requestPermission({mode:"readwrite"});
      if(req==="granted"){syncDirHandle=handle;syncStatus="ready";await syncLoad();}
    }
  }catch{syncStatus="none";}
}
// Auto-init sync on load
initSync().then(()=>{if(syncDirHandle)state.cases=ls(SK,[]);render();});

const TYPES={operative:{l:"Operative Note",e:"\u{1F52A}"},clinic:{l:"Clinic Note",e:"\u{1F3E5}"},consult:{l:"Inpatient Consult",e:"\u{1F4DE}"},progress:{l:"Progress Note",e:"\u{1F6CF}\uFE0F"},critical:{l:"Critical Care",e:"\u{1F6A8}"}};
// FIX #4: infer type label from category or type id
function typeCat(id){return id==="operative"?"Operative":id==="clinic"?"Clinic":"Inpatient";}
function noteTypeFromCat(cat){return cat==="Operative"?"operative":cat==="Clinic"?"clinic":"consult";}
function noteTypeLabel(t){if(TYPES[t])return TYPES[t].e+" "+TYPES[t].l;return"\u{1F4CB} Note";}

// ---- MACROS ----
const MACROS={
  acdf:{name:"ACDF",fields:[
    {id:"levels",label:"Levels",type:"pills",opts:["C3-4","C4-5","C5-6","C6-7","C7-T1"],multi:true},
    {id:"indication",label:"Indication",type:"pills",opts:["Radiculopathy","Myelopathy","Both"],multi:false},
    {id:"revision",label:"Revision/Adjacent segment",type:"pills",opts:["No","Yes - adjacent segment","Yes - revision"],multi:false},
    {id:"graft",label:"Graft Type",type:"pills",opts:["Structural allograft","PEEK cage","Titanium cage"],multi:false},
    {id:"graftSizes",label:"Graft Sizes (per level)",type:"text",ph:"7mm, 8mm"},
    {id:"plate",label:"Plate System",type:"text",ph:"Stryker Atlantis, Medtronic Zevo..."},
    {id:"pll",label:"PLL Resected",type:"pills",opts:["Yes","No"],multi:false},
    {id:"autograft",label:"Local Autograft Used",type:"pills",opts:["Yes","No"],multi:false},
    {id:"ebl",label:"EBL (mL)",type:"text",ph:"50"},
    {id:"complications",label:"Complications",type:"text",ph:"None"},
    {id:"extras",label:"Additional Details",type:"text",ph:"Osteophytes, foraminal stenosis..."}
  ]},
  tlif:{name:"TLIF/PLIF",fields:[
    {id:"levels",label:"Levels",type:"pills",opts:["L2-3","L3-4","L4-5","L5-S1"],multi:true},
    {id:"approach",label:"Approach",type:"pills",opts:["TLIF unilateral","TLIF bilateral","PLIF"],multi:false},
    {id:"indication",label:"Indication",type:"pills",opts:["Spondylolisthesis","Stenosis+instability","DDD","Revision"],multi:false},
    {id:"cage",label:"Interbody Cage",type:"text",ph:"Medtronic Capstone 10x26mm..."},
    {id:"screws",label:"Pedicle Screws",type:"text",ph:"DePuy Expedium 6.5x45mm..."},
    {id:"decomp",label:"Decompression",type:"pills",opts:["Laminectomy","Hemilaminectomy","Foraminotomy"],multi:true},
    {id:"autograft",label:"Autograft Source",type:"pills",opts:["Local laminectomy bone","ICBG","Both"],multi:false},
    {id:"neuromon",label:"Neuromonitoring",type:"pills",opts:["SSEPs+MEPs+EMG","SSEPs+MEPs","None"],multi:false},
    {id:"ebl",label:"EBL (mL)",type:"text",ph:"200"},
    {id:"complications",label:"Complications",type:"text",ph:"None"},
    {id:"extras",label:"Additional Details",type:"text",ph:"BMP, navigated screws..."}
  ]},
  kyphoplasty:{name:"Kyphoplasty",fields:[
    {id:"levels",label:"Levels",type:"pills",opts:["T10","T11","T12","L1","L2","L3","L4","L5"],multi:true},
    {id:"indication",label:"Indication",type:"pills",opts:["Osteoporotic VCF","Pathologic fracture","Traumatic"],multi:false},
    {id:"approach",label:"Approach",type:"pills",opts:["Bilateral transpedicular","Unilateral extrapedicular"],multi:false},
    {id:"cement",label:"Cement per Level (mL)",type:"text",ph:"3cc, 4cc"},
    {id:"biopsy",label:"Bone Biopsy Taken",type:"pills",opts:["Yes (20251-59)","No"],multi:false},
    {id:"system",label:"System",type:"text",ph:"Medtronic Kyphon, Stryker iVAS..."},
    {id:"fluoro",label:"Fluoroscopy Used",type:"pills",opts:["Yes","No"],multi:false},
    {id:"ebl",label:"EBL (mL)",type:"text",ph:"Minimal"},
    {id:"complications",label:"Complications",type:"text",ph:"None, cement extravasation..."},
    {id:"extras",label:"Additional Details",type:"text",ph:"Height restoration, dexa results..."}
  ]},
  craniotomy:{name:"Craniotomy",fields:[
    {id:"type",label:"Pathology",type:"pills",opts:["Acute SDH","Chronic SDH","EDH","Tumor","Chiari"],multi:false},
    {id:"side",label:"Side",type:"pills",opts:["Left","Right","Bilateral","Posterior fossa"],multi:false},
    {id:"approach",label:"Approach",type:"text",ph:"Frontotemporal, suboccipital..."},
    {id:"navigation",label:"Navigation Used",type:"pills",opts:["Yes (61781)","No"],multi:false},
    {id:"evd",label:"EVD Placed",type:"pills",opts:["Yes (61210)","No"],multi:false},
    {id:"icpMon",label:"ICP Monitor",type:"pills",opts:["Yes","No"],multi:false},
    {id:"duraClosure",label:"Dura Closure",type:"pills",opts:["Primary","Duraplasty with graft","Left open (decompressive)"],multi:false},
    {id:"boneFlap",label:"Bone Flap",type:"pills",opts:["Replaced","Left off (decompressive)","Mesh cranioplasty"],multi:false},
    {id:"drain",label:"Drain",type:"pills",opts:["Subdural drain","Subgaleal drain","None"],multi:false},
    {id:"ebl",label:"EBL (mL)",type:"text",ph:"150"},
    {id:"complications",label:"Complications",type:"text",ph:"None"},
    {id:"extras",label:"Additional Details",type:"text",ph:"GCS pre/post, pupil status..."}
  ]},
  laminectomy:{name:"Laminectomy",fields:[
    {id:"levels",label:"Levels",type:"pills",opts:["L2-3","L3-4","L4-5","L5-S1"],multi:true},
    {id:"approach",label:"Approach",type:"pills",opts:["Open midline","MIS tubular","Bilateral"],multi:false},
    {id:"indication",label:"Indication",type:"pills",opts:["Stenosis","HNP/Disc herniation","Cauda equina","Recurrent disc"],multi:false},
    {id:"decomp",label:"Decompression",type:"pills",opts:["Laminectomy","Hemilaminectomy","Laminotomy","Foraminotomy"],multi:true},
    {id:"discectomy",label:"Discectomy",type:"pills",opts:["Yes ‚Äî microdiscectomy","Yes ‚Äî standard","No"],multi:false},
    {id:"laterality",label:"Laterality",type:"pills",opts:["Left","Right","Bilateral"],multi:false},
    {id:"tubular",label:"Tubular System",type:"text",ph:"METRx 18mm, Pipeline..."},
    {id:"microscope",label:"Microscope/Loupe",type:"pills",opts:["Operating microscope","Surgical loupes","None"],multi:false},
    {id:"neuromon",label:"Neuromonitoring",type:"pills",opts:["SSEPs+MEPs+EMG","SSEPs+EMG","None"],multi:false},
    {id:"ebl",label:"EBL (mL)",type:"text",ph:"50"},
    {id:"complications",label:"Complications",type:"text",ph:"None, dural tear..."},
    {id:"extras",label:"Additional Details",type:"text",ph:"Free fragment, ligamentum flavum hypertrophy, lateral recess..."}
  ]},
  pcf:{name:"Post Cerv Fusion",fields:[
    {id:"levels",label:"Levels",type:"pills",opts:["C2-3","C3-4","C4-5","C5-6","C6-7","C7-T1","C7-T2"],multi:true},
    {id:"indication",label:"Indication",type:"pills",opts:["Myelopathy","Kyphosis","Trauma","Tumor","Revision"],multi:false},
    {id:"decomp",label:"Decompression",type:"pills",opts:["Laminectomy","Laminoplasty","Foraminotomy","None ‚Äî fusion only"],multi:true},
    {id:"screws",label:"Lateral Mass/Pedicle Screws",type:"text",ph:"DePuy Mountaineer 3.5x14mm lateral mass..."},
    {id:"rodType",label:"Rod",type:"text",ph:"3.5mm CoCr rod, titanium..."},
    {id:"graft",label:"Graft",type:"pills",opts:["Local autograft","ICBG","Allograft","BMP"],multi:true},
    {id:"decortication",label:"Decortication",type:"pills",opts:["Yes ‚Äî with high-speed burr","Yes ‚Äî manual","No"],multi:false},
    {id:"neuromon",label:"Neuromonitoring",type:"pills",opts:["SSEPs+MEPs+EMG","SSEPs+MEPs","None"],multi:false},
    {id:"drain",label:"Drain",type:"pills",opts:["Subfascial drain","None"],multi:false},
    {id:"ebl",label:"EBL (mL)",type:"text",ph:"200"},
    {id:"complications",label:"Complications",type:"text",ph:"None"},
    {id:"extras",label:"Additional Details",type:"text",ph:"C2 pars screws, navigated, subaxial technique..."}
  ]}
};
function macroToDict(macroId,vals){
  const m=MACROS[macroId];if(!m)return"";
  let lines=[m.name+" OPERATIVE NOTE"];
  m.fields.forEach(f=>{const v=vals[f.id];if(!v||(Array.isArray(v)&&!v.length))return;const val=Array.isArray(v)?v.join(", "):v;if(val&&val!=="No"&&val!=="None")lines.push(f.label+": "+val);});
  return lines.join("\n");
}
// ---- SYSTEM PROMPT ----
function getSYS(){return `You are OpNote Intelligence ‚Äî neurosurgery note generator and billing engine.
Date: ${TODAY}
Surgeon: ${state.sn||"Diaz"}

RULES:
- NEVER fabricate. DRAFT only. THOROUGH.
- NO patient demographics. NO ** bold. CAPS WITH COLONS for headers.
- NO blanks, underscores, or square brackets.
- Assumed: ***ASSUMED*** prefix. Missing implants: ***IMPLANT*** prefix. Added: ***ADDED*** prefix.
- NEVER mark dates, date formats, or today's date as ***ASSUMED***. Only mark clinical assumptions.
- NEVER put billing codes, CPT codes, RVU values, or billing lines (e.g. "BILLING: 99214") in the clinical note body. Billing goes ONLY in the separate billing analysis.
- CODING COMPLETE. Abbreviations OK.
- First line = clinical content. No preamble.
- OPERATIVE NOTES must include "SURGEON: ${state.sn||"Diaz"}" and "ASSISTANTS: None" (unless assistants specified in dictation) as header fields after ANESTHESIA.
- OPERATIVE NOTES ONLY: include "ATTENDING: ${state.sn||"Diaz"}". Do NOT include ATTENDING/SURGEON lines in clinic, consult, progress, or critical care notes.

QUESTIONS (max 3, only if changes PRIMARY CPT):
Q: [question]
DEFAULT: [assumption]
---
Then ALWAYS produce complete note.

MDM COMPLEXITY LINE (non-operative): first line = single sentence.

MEDICOLEGAL (OPERATIVE): TIME OUT, CONSENT in INDICATIONS, ANTIBIOTICS, NEUROMONITORING (ONLY if mentioned in dictation ‚Äî if not mentioned, include as Q:/DEFAULT: "Was neuromonitoring used?" DEFAULT: "No neuromonitoring utilized"), COUNTS x2, SPECIMEN, TOTAL OPERATIVE TIME.

CRITICAL CARE TIME ATTESTATION (CRITICAL CARE NOTES):
Always ask as question: Q: Total time spent on this patient encounter including history, examination, review of imaging, discussion with patient/family, and coordination of care? DEFAULT: [estimate from complexity] minutes total encounter time.
Include in note: "Patient is critically ill with life-threatening neurological condition requiring high-complexity decision making and continuous attention. I personally provided >[X] minutes of direct critical care time today, including [list activities]. Time spent: [X] minutes."

OPERATIVE STRUCTURE:
PREOP DX, POSTOP DX, PROCEDURE, INDICATIONS, ANESTHESIA, ANTIBIOTICS, POSITION, TIME OUT, NEUROMONITORING, TECHNIQUE, TOTAL OPERATIVE TIME, IMPLANTS, EBL, COMPLICATIONS, DRAINS, SPECIMENS, COUNTS, CLOSURE, DISPOSITION

NEUROCHECK FREQ (DISPOSITION/A&P ‚Äî inpatient notes only, NOT for clinic notes):
- Complex/myelopathy/intradural/craniotomy/SDH/SAH: q1h x4h then q2h x8h then q4h
- Standard multilevel: q2h x8h then q4h
- Single level/kyphoplasty: q4h
- Critical care/ICU: q1h continuous
- CLINIC NOTES: No neurochecks. Use return precautions instead.

CRITICAL CARE BILLING:
ICU + life-threatening pathology (SDH, SAH, herniation, ICP crisis, cord injury with resp failure):
- Evaluate 99291/99292 (10.0/5.0 RVU) vs standard consult (99255 = 3.86)
- Requires time attestation: "Total critical care time: [X] min including [activities]"
- Default to critical care format if ICU + life-threatening neuro

CODE-SPECIFIC:
CRITICAL CODING RULES ‚Äî READ CAREFULLY:
1. REGION DETECTION: Determine primary region from the UPPERMOST level of fusion.
   - C1-C7 start = CERVICAL codes (22600/22614)
   - T1-T12 start = THORACIC codes (22610/22614)  
   - L1-S1 start = LUMBAR codes (22612/22614)
   22600 = posterior cervical arthrodesis, first segment
   22610 = posterior thoracic arthrodesis, first segment
   22612 = posterior lumbar arthrodesis, first segment
   22614 = each additional segment (all regions)
2. SEGMENT COUNTING: Count vertebrae spanned minus 1 = fused segments. C2-T8 = 13 segments. Then 22614 √ó (total-1).
   Instrumentation: 22840 (1-2 segments), 22842 (3-6), 22843 (7-12), 22844 (13+). COUNT ACTUAL SEGMENTS.
3. OSTEOTOMY CODES by TYPE and REGION:
   Posterior 1-column (Smith-Petersen/Ponte/facetectomy):
   - 22210 cervical, 22212 thoracic, 22214 lumbar
   Posterior 3-column (pedicle subtraction/PSO/vertebral column resection):
   - 22206 thoracic, 22207 lumbar
   The osteotomy region is where the osteotomy is PERFORMED, not where fusion starts.
4. GRAFT CODES ‚Äî read the note carefully:
   - 20930 = allograft morselized (chips, DBM, crushed)
   - 20931 = allograft structural (femoral ring, fibula strut, cage with structural graft)
   - 20936 = autograft local (from laminectomy/decompression bone, same incision)
   - 20937 = autograft morselized separate incision (ICBG)
   - 20938 = autograft structural separate incision
   Do NOT code 20931 when note says morselized, chips, or DBM.
5. DO NOT HALLUCINATE: Only bill codes for procedures EXPLICITLY described in the note. Do not add 69990 (microsurgery) unless operative microscope use is explicitly documented. Do not add 22849 (reinsertion) unless a SEPARATE reinsertion is documented. If hardware removal documented, bill 22852 (cervical), 22855 (thoracic/lumbar).
6. NAVIGATION CODES: 61781 = cranial intradural, 61782 = cranial extradural, 61783 = SPINAL. For ALL spine surgery navigation use 61783. Only use 61782 for craniotomy cases.
7. DECOMPRESSION CODE SELECTION:
   - 63047/63048 = laminectomy/facetectomy/foraminotomy (standard posterior approach)
   - 63052/63053 = laminectomy/facetectomy via TRANSPEDICULAR approach. Use when pedicle is removed (PSO, transpedicular decompression, TLIF with pedicle removal).
   If pedicle subtraction osteotomy is performed, decompression = 63052/63053 NOT 63047/63048.
8. NO DOUBLE-BILLING: 22633/22634 (combined TLIF) vs 22612/22614+22853/22854 (separate arthrodesis+interbody) are MUTUALLY EXCLUSIVE. Pick ONE. Calculate both totals, use whichever yields higher RVU. NEVER list both.
9. NO DUPLICATE CODES: Never list same CPT twice unless it is an add-on billed per-level (22614, 22634, 63048, 63053, 22854).
10. OSTEOTOMY ‚Äî 1-COLUMN vs 3-COLUMN:
   - 1-column (Smith-Petersen, Ponte, facetectomy osteotomy): 22210/22212/22214 by region
   - 3-column (pedicle subtraction osteotomy/PSO, vertebral column resection/VCR): 22206 thoracic, 22207 lumbar
   "PSO" or "pedicle subtraction" or "3-column" ‚Üí 22206/22207. "Smith-Petersen" or "Ponte" or "facetectomy osteotomy" ‚Üí 22210/22212/22214.

ANTERIOR CERVICAL: 22551 (first level)/22552 (each additional), 22845 (anterior instrumentation), 20931 (structural allograft if cage+graft), 20936 (COMMONLY MISSED). Discectomy BUNDLED with 22551.
CORPECTOMY: 63081 (cervical first segment)/63082 (each additional), 22554 (anterior arthrodesis after corpectomy).
POSTERIOR CERVICAL FUSION: 22600 (first segment), 22614 (each additional), 22842/22843 (posterior segmental instrumentation by segment count), 20936 (autograft), 20930 (allograft). C1-C2 fusion: 22595. Lateral mass screws included in instrumentation code.
FRONT-BACK: both families. Reposition. -22 mandatory.
TLIF SINGLE LEVEL: 22612 (posterior arthrodesis, first segment) + 22853 (interbody device) + 22840 (posterior non-segmental instrumentation, 1-2 segments) + 63047 (laminectomy/facetectomy for decompression) + 20936 (local autograft) + 20930 (allograft if used). If osteotomy performed (Smith-Petersen/facetectomy osteotomy): ADD 22214 (posterior osteotomy single segment). If bilateral facetectomy: document as osteotomy for 22214.
TLIF MULTI-LEVEL: 22612 (first) + 22614 (each additional) + 22853 (first interbody) + 22854 (each additional interbody) + 22842 (posterior segmental instrumentation, 3-6 segments) or 22840 (1-2 segments) + 63047/63048 + 20936 + 20930.
CRITICAL TLIF RULES: 22633/22634 is ALTERNATIVE coding (combined posterior interbody arthrodesis) ‚Äî use 22612+22853 instead when separate codes yield higher RVU. Always compare both approaches and use whichever is higher. 22840 for 1-2 vertebral segments, 22842 for 3-6. Count INSTRUMENTED segments not fused levels.
KYPHOPLASTY: 22513(T)/22514(L), 20251-59 bone biopsy (MISSED).
CRANIOTOMY: 61304/61312/61510, nav 61781/61782, EVD 61210.
LAMINECTOMY/DECOMPRESSION: 63047 (first segment), 63048 (each additional), 63030 (hemilaminotomy+disc 1 level), 63035 (each additional), 63042 (re-exploration/laminotomy), 63056 (transpedicular). Microdiscectomy 63030 NOT separately billable with 63047 at same level ‚Äî bundling alert.
HARDWARE REMOVAL: 22852 (posterior cervical), 22855 (posterior thoracic/lumbar). Bill when prior hardware is explicitly removed.

MODIFIER LOGIC:
-22: "INCREASED PROCEDURAL COMPLEXITY:" section with specific factors
-58: Staged procedure. If planned return to OR within global period of prior procedure. Document: "Planned staged procedure, initial [procedure] performed [date]. -58 modifier applied."
-59: Distinct procedural service. When two procedures could appear bundled but are anatomically or procedurally distinct. Document clearly why procedures are separate (different incision, different pathology, different anatomical site). Common: bone biopsy with kyphoplasty (20251-59), separate decompression levels.

PRE-AUTHORIZATION SUPPORT (CLINIC NOTES ONLY):
When surgical recommendation is made, include section:
PRE-AUTHORIZATION:
- Recommended procedure with CPT codes
- Medical necessity: specific failed conservative treatments WITH DATES
- Imaging findings supporting surgery
- Required pre-op items: nicotine screening (if fusion), DEXA scan (if osteoporosis concern/age>65), medical clearance
- Implant/system anticipated (insurers sometimes require)
- Items likely to require peer-to-peer: [list any]
- Denial risk factors: [smoking status, BMI>40, <6wk conservative tx]

CLINIC: MDM opener, HPI (failed tx WITH DATES), exam, imaging, A/P, PRE-AUTH if surgical
CLINIC VISIT TYPES:
- NEW PATIENT: Header "NEW PATIENT ENCOUNTER". Full HPI, comprehensive exam, complete imaging review.
- FOLLOW-UP: Header "FOLLOW-UP VISIT". Interval history, focused exam, treatment response.
- POST-OP VISIT: Header "POST-OPERATIVE VISIT ‚Äî POD #[X] ‚Äî [procedure]". Wound check, imaging review, activity progression, return to work/restrictions, follow-up plan.
Include visit type header as FIRST LINE of note when specified.
CONSULT: MDM opener, reason, HPI, exam, imaging, recommendations, neurocheck
PROGRESS: MDM opener, subjective (overnight/drains), exam, imaging, A/P, neurocheck
CRITICAL CARE: MDM opener, time attestation, neuro exam (GCS/pupils/motor/CNs/EVD), interventions, A/P

WORKUP (non-operative): "WORKUP:" numbered items.`;}

const P1END='\n\nProduce the note. Questions in Q:/DEFAULT: format first, then full note after NOTE: line. All medicolegal elements for operative. Neurocheck frequency for inpatient/operative/consult notes ONLY ‚Äî never for clinic notes. ***ASSUMED***/***IMPLANT*** markers. WORKUP: for non-operative. PRE-AUTHORIZATION: section for clinic notes recommending surgery.';

const P2=`Billing analysis. Be SPECIFIC, GRANULAR, and MAXIMALLY AGGRESSIVE within defensible bounds.

MANDATORY RULES ‚Äî VIOLATION OF THESE IS AN ERROR:
1. NEVER list the same CPT code more than once. Each code appears EXACTLY once (add-ons like 22614 get "x[N]" notation).
2. 22633/22634 and 22612/22614+22853/22854 are MUTUALLY EXCLUSIVE. Pick ONE strategy. Show your RVU comparison.
3. Navigation: 61783 for SPINE. 61782 for CRANIAL ONLY.
4. PSO/3-column osteotomy = 22206 (thoracic) or 22207 (lumbar). NOT 22214.
   22214 = 1-column only (Smith-Petersen, Ponte, facetectomy osteotomy).
5. If PSO performed, decompression = 63052/63053 (transpedicular). NOT 63047/63048.
6. Do NOT add 69990 unless operative microscope explicitly documented.
7. Region: primary arthrodesis code from UPPERMOST fused level (cervical=22600, thoracic=22610, lumbar=22612).

FORMAT ‚Äî list each code ONCE:
CODES:
[CODE - Description (X.X RVU) CONFIDENCE]
[For add-ons: CODE x[N] - Description (X.X RVU each) CONFIDENCE]

MODIFIERS:
[with justification, include -22/-58/-59 evaluation]

ICD-10:
[one per line]

BUNDLING:
[notes]

GAPS:
IMPACT: HIGH
ISSUE: [missing] ‚Äî [CPT] ([+X.X RVU / +$XX])
LANGUAGE: [exact text to add]
---

FLAGS:
RED: [issue] ‚Äî [reason]
INPUT_NEEDED: [what data needed]

YELLOW: [issue] ‚Äî [missed revenue]
INPUT_NEEDED: [what data needed]

GREEN: [confirmed correct]

PRE-AUTH ASSESSMENT (clinic notes only):
- Likelihood of approval: HIGH/MED/LOW
- Required documentation still needed
- Likely peer-to-peer triggers
- Recommended submission strategy

FINANCIAL:
TOTAL RVU: [#]
CURRENT ESTIMATE: $[range]
WITH GAPS FILLED: $[range]
CAPTURE RATE: [% ‚Äî never 100% if gaps or yellow/red flags exist]`;
// ---- HELPERS ----
function stripAll(t){return(t||"").replace(/\*{2,3}\s*ASSUMED\s*\*{2,3}\s*/gi,"").replace(/\*{2,3}\s*IMPLANT\s*\*{2,3}\s*/gi,"").replace(/\*{2,3}\s*ADDED\s*\*{2,3}\s*/gi,"").replace(/\[ASSUMED\]\s*/gi,"").replace(/\(ASSUMED\)\s*/gi,"").replace(/\bASSUMED:\s*/gi,"").replace(/\bASSUMED\s*[-‚Äî‚Äì]\s*/gi,"").replace(/Q:\s*[^\n]+\nDEFAULT:\s*[^\n]+\n?/g,"").replace(/^Q:\s*.*\n?/gm,"").replace(/^DEFAULT:\s*.*\n?/gm,"").replace(/\b(?:CPT|E\/M)\s*(?:code)?:?\s*\d{5}\b/gi,"").replace(/\b99[0-5]\d{2}\b/g,"").replace(/\*{2}([^*]+)\*{2}/g,"$1").replace(/#{1,4}\s*/g,"").replace(/---+/g,"").replace(/\n{3,}/g,"\n\n");}
function stripBilling(t){return(t||"").replace(/\n*BILLING ANALYSIS:[\s\S]*$/i,"").replace(/\n*PRIMARY PROCEDURES:[\s\S]*$/i,"").replace(/\n*BILLING:.*$/gim,"").replace(/\n*(?:CPT|E\/M):\s*\d{5}.*$/gim,"").replace(/\n*TOTAL RVU:.*$/gim,"").replace(/\n*ESTIMATED ADDITIONAL RVU.*$/gim,"").replace(/\n*DOCUMENTATION SUPPORTS:[\s\S]*$/i,"").replace(/\n*MODIFIER -22.*RECOMMENDED[\s\S]*$/i,"").replace(/\n*INCREASED PROCEDURAL COMPLEXITY:[\s\S]*$/i,"").trim();}
// Fix 4: Dedup ‚Äî if major section headers appear twice, keep only the last occurrence
function dedupNote(t){if(!t)return t;const headers=["PREOPERATIVE DIAGNOSIS","POSTOPERATIVE DIAGNOSIS","PROCEDURE","INDICATIONS","TECHNIQUE","ASSESSMENT AND PLAN","HISTORY OF PRESENT ILLNESS","PHYSICAL EXAMINATION","DISPOSITION"];let out=t;headers.forEach(h=>{const rx=new RegExp("(^|\\n)("+h+"[:\\s])","gi");const matches=[...out.matchAll(rx)];if(matches.length>1){const firstIdx=matches[0].index;const secondIdx=matches[1].index;out=out.slice(0,firstIdx)+out.slice(secondIdx);}});return out.trim();}
const INC_SUFFIX="\n\nCRITICAL: Output ONLY the single updated note. REPLACE changed sections in-place. Do NOT append or duplicate. Do NOT include the previous version. One note only.";
function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function escJs(s){return String(s||"").replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\n/g,"\\n");}

// FIX #9: parseQuestions returns cleanNote (stripped of Q/DEFAULT) for storage
function parseQuestions(raw){
  const qs=[];let ni=raw.indexOf("\nNOTE:");if(ni<0)ni=raw.indexOf("NOTE:");
  const qS=ni>0?raw.slice(0,ni):null;
  let nS=ni>=0?raw.slice(ni).replace(/^[\n]*NOTE:\s*\n?/,"").trim():raw.replace(/^[\n]*NOTE:\s*\n?/,"").trim();
  if(qS){qS.split(/(?=Q:\s)/).forEach(p=>{const qm=p.match(/Q:\s*(.*?)(?:\n|$)/);const dm=p.match(/DEFAULT:\s*([\s\S]*?)(?:\n---|$)/);if(qm)qs.push({q:qm[1].trim(),def:(dm?dm[1].trim():"")});});}
  // Fallback: strip any remaining Q:/DEFAULT: from note body
  nS=nS.replace(/^Q:\s*.*\n(?:DEFAULT:\s*.*\n?)?(?:---\s*\n?)?/gm,"").trim();
  // Also strip inline Q:/DEFAULT: blocks that weren't caught
  nS=nS.replace(/Q:\s*[^\n]+\nDEFAULT:\s*[^\n]+\n?/g,"").trim();
  return{questions:qs,note:nS};
}
function parseWorkup(raw){const m=raw.match(/\nWORKUP:\s*\n([\s\S]*?)$/i);if(!m)return{note:raw,wu:[]};const items=[];m[1].split("\n").filter(l=>l.trim()).forEach(l=>{const x=l.match(/^\d+[\.\)]\s*(.*)/)||l.match(/^-\s*(.*)/);if(x)items.push(x[1].trim());});return{note:raw.slice(0,m.index).trim(),wu:items};}
function parseGaps(raw){if(!raw)return[];const gaps=[];let cur=null;raw.split("\n").forEach(l=>{const t=l.trim();if(t.startsWith("IMPACT:")){if(cur&&cur.issue)gaps.push(cur);cur={impact:(t.match(/(HIGH|MED|LOW)/i)||["","MED"])[1].toUpperCase(),issue:"",language:""};}else if(t.startsWith("ISSUE:")&&cur)cur.issue=t.slice(6).trim();else if(t.startsWith("LANGUAGE:")&&cur)cur.language=t.slice(9).trim();else if(t==="---"){if(cur&&cur.issue)gaps.push(cur);cur=null;}else if(cur){if(cur.language)cur.language+="\n"+t;else if(cur.issue)cur.issue+="\n"+t;}});if(cur&&cur.issue)gaps.push(cur);return gaps;}
function parseFlags(raw){if(!raw)return[];const flags=[];let cur=null;raw.split("\n").forEach(l=>{const t=l.trim();const m=t.match(/^(RED|YELLOW|GREEN):\s*(.*)/i);if(m){if(cur)flags.push(cur);cur={type:m[1].toUpperCase(),text:m[2].trim(),input:null};}else if(t.startsWith("INPUT_NEEDED:")&&cur)cur.input=t.slice(13).trim();else if(cur&&t&&!m)cur.text+="\n"+t;});if(cur)flags.push(cur);return flags;}
function parseFinancial(raw){if(!raw)return null;const f={};const rm=raw.match(/TOTAL RVU:\s*([\d.]+)/i);if(rm)f.rvu=rm[1];const cm=raw.match(/CURRENT ESTIMATE:\s*\$?([\d,.\-$\s]+)/i);if(cm)f.current=cm[1].trim();const wm=raw.match(/WITH GAPS.*?:\s*\$?([\d,.\-$\s]+)/i);if(wm)f.potential=wm[1].trim();const cr=raw.match(/CAPTURE RATE:\s*([\d.%]+)/i);if(cr)f.capture=cr[1].trim();return Object.keys(f).length?f:null;}
function parseBillFull(raw){
  // Strip ** bold from section headers before parsing
  const clean=raw.replace(/\*{2}(CODES|MODIFIERS|ICD-?10|BUNDLING|GAPS|FLAGS|PRE-AUTH[A-Z ]*|FINANCIAL|DOCUMENTATION):\*{2}/gi,"$1:").replace(/\*{2}(CODES|MODIFIERS|ICD-?10|BUNDLING|GAPS|FLAGS|PRE-AUTH[A-Z ]*|FINANCIAL|DOCUMENTATION)\*{2}:/gi,"$1:");
  const sec={codes:"",modifiers:"",icd:"",bundling:"",gaps:"",flags:"",financial:"",preauth:""};
  const markers=[{key:"codes",rx:/^CODES:\s*\n/im},{key:"modifiers",rx:/^MODIFIERS:\s*\n/im},{key:"icd",rx:/^ICD-?10:\s*\n/im},{key:"bundling",rx:/^BUNDLING:\s*\n/im},{key:"gaps",rx:/^GAPS:\s*\n/im},{key:"flags",rx:/^FLAGS:\s*\n/im},{key:"preauth",rx:/^PRE-AUTH[A-Z ]*:\s*\n/im},{key:"financial",rx:/^FINANCIAL:\s*\n/im}];
  const found=[];markers.forEach(m=>{const match=clean.match(m.rx);if(match)found.push({key:m.key,idx:match.index,len:match[0].length});});
  found.sort((a,b)=>a.idx-b.idx);
  found.forEach((f,i)=>{const s=f.idx+f.len;const e=i+1<found.length?found[i+1].idx:clean.length;sec[f.key]=clean.slice(s,e).trim();});
  if(!found.length)sec.codes=clean;
  // Fallback: if flags section empty but raw contains RED:/YELLOW:/GREEN: patterns, extract directly
  if(!sec.flags){const fm=clean.match(/\n((?:RED|YELLOW|GREEN):[\s\S]*?)(?=\nFINANCIAL:|\nPRE-AUTH|\n*$)/i);if(fm)sec.flags=fm[1].trim();
    if(!sec.flags){const fm2=clean.match(/((?:RED|YELLOW|GREEN):[\s\S]*?)(?=\nFINANCIAL:|\nPRE-AUTH|\n*$)/i);if(fm2)sec.flags=fm2[1].trim();}
  }
  // Clean: strip any trailing FLAGS/FINANCIAL/PRE-AUTH content that leaked into other sections
  [sec.codes,sec.modifiers,sec.icd,sec.bundling].forEach((v,i)=>{
    const keys=["codes","modifiers","icd","bundling"];
    const cut=v.search(/\n(?:RED|YELLOW|GREEN|FLAGS|FINANCIAL|PRE-AUTH|TOTAL RVU):/i);
    if(cut>0)sec[keys[i]]=v.slice(0,cut).trim();
  });
  return sec;
}
// MDM complexity level from E/M code
function mdmLevel(codes){
  if(!codes)return"";
  const m=codes.match(/99(2[01]\d|2[1-5]\d)/);if(!m)return"";
  const c=parseInt(m[0]);
  if([99211,99212,99202,99252].includes(c))return"STRAIGHTFORWARD COMPLEXITY";
  if([99213,99203,99253].includes(c))return"LOW COMPLEXITY";
  if([99214,99204,99254].includes(c))return"MODERATE COMPLEXITY";
  if([99215,99205,99255].includes(c))return"HIGH COMPLEXITY";
  return"";
}
function injectMDM(noteText,codes,nt){
  if(!noteText||!codes)return noteText;
  if(nt!=="clinic"&&nt!=="consult")return noteText;
  const lvl=mdmLevel(codes);if(!lvl)return noteText;
  // Insert after encounter/visit/note type headers
  let injected=false;
  const out=noteText.replace(/((?:NEW PATIENT|ESTABLISHED PATIENT|FOLLOW[- ]?UP|POST[- ]?OP(?:ERATIVE)?|CONSULTATION|CONSULT|CLINIC)\s*(?:ENCOUNTER|VISIT|NOTE)?)\s*([:\-‚Äî.]?\s*)/i,
    (m,header,sep)=>{injected=true;return header+" ‚Äî "+lvl+"\n";});
  if(injected)return out;
  // Fallback: prepend as first line
  return lvl+"\n"+noteText;
}
function coderExport(n,bRaw){const sec=parseBillFull(bRaw);const cleanNote=stripAll(stripBilling(n));let out="CASE - "+TODAY+"\n\n"+cleanNote+"\n\nCPT CODES:\n";if(sec.codes)out+=sec.codes.split("\n").filter(l=>l.trim()).map(l=>l.trim().replace(/\*\*/g,"")).join("\n");if(sec.icd)out+="\n\nICD-10:\n"+sec.icd.split("\n").filter(l=>l.trim()).map(l=>l.trim().replace(/\*\*/g,"")).join("\n");if(sec.modifiers){const m22=sec.modifiers.split("\n").filter(l=>/-22|-58|-59/.test(l));if(m22.length)out+="\n\nMODIFIERS:\n"+m22.map(l=>l.trim()).join("\n");}return out+"\n\nDecision-support only.";}
// Fix 5: Send to coder via Outlook protocol + clipboard (avoids mailto length limit)
function sendToCoder(noteT,billR){
  const body=coderExport(noteT,billR);
  navigator.clipboard.writeText(body).catch(()=>{});
  if(state.ce){
    const subj=encodeURIComponent("OpNote - "+TODAY);
    // Try Outlook desktop protocol first, then mailto fallback
    window.open("ms-outlook://compose?to="+encodeURIComponent(state.ce)+"&subject="+subj);
  }
  const b=document.getElementById("coderBtn");if(b){const o=b.innerHTML;b.innerHTML="\u2705 Copied! Paste in email body";b.style.background="#059669";setTimeout(()=>{if(b){b.innerHTML=o;b.style.background="";}},3000);}
}

// ---- RENDER NOTE ----
function hlM(t){return t.replace(/\*{3}ASSUMED\*{3}\s*/g,'<span class="ma" onclick="this.parentElement.remove()">ASSUMED</span> ').replace(/\*{3}IMPLANT\*{3}\s*/g,'<span class="mi" onclick="this.parentElement.remove()">IMPLANT</span> ').replace(/\*{3}ADDED\*{3}\s*/g,'<span class="md2">ADDED</span> ').replace(/\*\*([^*]+)\*\*/g,'<strong style="color:#f1f5f9">$1</strong>');}
function renderNote(el,text){el.innerHTML="";if(!text)return;let inT=false,tb=null,tw=null;text.split("\n").forEach(ln=>{if(/^---+$/.test(ln.trim()))return;if(/^#{1,4}\s/.test(ln.trim())){const d=document.createElement("div");d.className="slabel";d.innerHTML=hlM(esc(ln.replace(/^#{1,4}\s*/,"")));el.appendChild(d);return;}if(inT&&!ln.includes("|")){el.appendChild(tw);inT=false;tb=null;tw=null;}if(/^[A-Z][A-Z /&\-]{2,}:/.test(ln.trim())){const d=document.createElement("div");d.className="slabel";d.innerHTML=hlM(esc(ln));el.appendChild(d);return;}if(ln.includes("|")&&ln.split("|").length>2){if(/^[\s\-:|]+$/.test(ln.replace(/[|]/g,"")))return;if(!inT){tw=document.createElement("div");tw.style.cssText="overflow-x:auto;margin:8px 0;border:1px solid #1e293b;border-radius:8px";const t=document.createElement("table");const th=document.createElement("thead");const tr=document.createElement("tr");ln.split("|").map(c=>c.trim()).filter(Boolean).forEach(c=>{const h=document.createElement("th");h.innerHTML=hlM(esc(c));tr.appendChild(h);});th.appendChild(tr);t.appendChild(th);tb=document.createElement("tbody");t.appendChild(tb);tw.appendChild(t);inT=true;}else{const tr=document.createElement("tr");ln.split("|").map(c=>c.trim()).filter(Boolean).forEach(c=>{const td=document.createElement("td");td.innerHTML=hlM(esc(c));tr.appendChild(td);});tb.appendChild(tr);}return;}if(!ln.trim()){el.appendChild(Object.assign(document.createElement("div"),{style:"height:6px"}));return;}if(/^-\s/.test(ln.trim())){const d=document.createElement("div");d.style.cssText="display:flex;gap:8px;margin-bottom:3px;font-size:13px;color:#cbd5e1;line-height:1.5";d.innerHTML='<span style="color:#475569">-</span><span>'+hlM(esc(ln.trim().slice(2)))+"</span>";el.appendChild(d);return;}if(/^\d+[\.\)]\s/.test(ln.trim())){const d=document.createElement("div");d.style.cssText="display:flex;gap:8px;margin-bottom:3px;font-size:13px;color:#cbd5e1;line-height:1.5";const n=ln.trim().match(/^(\d+)[\.\)]\s*(.*)/);d.innerHTML='<span style="color:#64748b;min-width:18px">'+n[1]+'.</span><span>'+hlM(esc(n[2]))+"</span>";el.appendChild(d);return;}const d=document.createElement("div");d.style.cssText="font-size:13px;color:#cbd5e1;line-height:1.6;margin:1px 0";d.innerHTML=hlM(esc(ln));el.appendChild(d);});if(inT&&tw)el.appendChild(tw);}
// ---- WHISPER + IMAGE + API ----
let mR=null,aC=[],rST=0,rTm=null,rS="idle";
async function startRec(){try{const s=await navigator.mediaDevices.getUserMedia({audio:true});aC=[];const m=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":"";mR=m?new MediaRecorder(s,{mimeType:m}):new MediaRecorder(s);mR.ondataavailable=e=>{if(e.data.size>0)aC.push(e.data);};mR.onstop=async()=>{s.getTracks().forEach(t=>t.stop());clearInterval(rTm);if(!aC.length){rS="idle";render();return;}rS="transcribing";render();try{const b=new Blob(aC,{type:mR.mimeType||"audio/webm"});const t=await whisper(b);if(t)state.text=(state.text?state.text+"\n":"")+t;rS="idle";render();}catch(e){state.err="Transcription: "+e.message;rS="idle";render();}};mR.start(1000);rST=Date.now();rS="recording";rTm=setInterval(()=>render(),1000);render();}catch{state.err="Mic denied.";rS="idle";render();}}
function stopRec(){if(mR?.state==="recording")mR.stop();}
function toggleRec(){rS==="recording"?stopRec():rS==="idle"&&startRec();}
async function whisper(blob){const key=state.wk;if(!key)throw new Error("Add OpenAI key for dictation.");const fd=new FormData();fd.append("file",blob,"r.webm");fd.append("model","whisper-1");fd.append("language","en");fd.append("prompt","Neurosurgery: ACDF, TLIF, laminectomy, kyphoplasty, craniotomy, myelopathy, radiculopathy, SSEPs, MEPs, pedicle screws, interbody cage, allograft, autograft, arthrodesis, subdural hematoma, subarachnoid hemorrhage, EVD, ICP.");const res=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{"Authorization":"Bearer "+key},body:fd});const d=await res.json();if(d.error)throw new Error(d.error.message);return d.text||"";}
function rD(){if(rS!=="recording")return"";const s=Math.floor((Date.now()-rST)/1000);return Math.floor(s/60)+":"+(s%60<10?"0":"")+(s%60);}

// Image analysis ‚Äî supports imaging, text/reads, mixed content
const IMG_PROMPT=`You are a clinical document extractor for neurosurgery. Analyze this image and determine what it contains:

IF MEDICAL IMAGING (CT, MRI, X-ray): Extract objective findings in surgical documentation format. Include: modality, findings with measurements, midline shift, hydrocephalus status, compression, signal changes. Single paragraph, prefix with modality.

IF TEXT (typed note, radiology read, consult letter, lab results, referral): Transcribe the text content accurately. Preserve clinical formatting. Include all relevant findings, dates, and recommendations.

IF MIXED: Extract both imaging findings and text content.

Output ready to paste into a clinical note. No patient identifiers (names, DOB, MRN). If unclear, describe what you see.`;

// Resize large images to fit API limits
function resizeImage(file){return new Promise((resolve,reject)=>{
  const img=new Image();img.onload=()=>{
    const max=2048;let w=img.width,h=img.height;
    if(w>max||h>max){const r=Math.min(max/w,max/h);w=Math.round(w*r);h=Math.round(h*r);}
    const c=document.createElement("canvas");c.width=w;c.height=h;
    c.getContext("2d").drawImage(img,0,0,w,h);
    resolve(c.toDataURL("image/jpeg",0.85).split(",")[1]);
  };img.onerror=reject;img.src=URL.createObjectURL(file);
});}

async function analyzeImage(file,target){
  setState({phase:"image",err:null});
  try{
    let b64,mt=file.type||"image/jpeg";
    if(file.size>4*1024*1024){b64=await resizeImage(file);mt="image/jpeg";}
    else{b64=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(",")[1]);r.onerror=rej;r.readAsDataURL(file);});}
    const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:2048,messages:[{role:"user",content:[{type:"image",source:{type:"base64",media_type:mt,data:b64}},{type:"text",text:IMG_PROMPT}]}]})});
    if(!res.ok){const et=await res.text();throw new Error("API "+res.status+": "+(et.slice(0,200)));}
    const data=await res.json();if(data.error)throw new Error(data.error.message);
    const txt=data.content.map(c=>c.type==="text"?c.text:"").join("");
    if(txt){
      if(target==="addend")state.addend=(state.addend?state.addend+"\n\n":"")+txt;
      else state.text=(state.text?state.text+"\n\n":"")+txt;
    }
    setState({phase:state.noteText?"done":""});
  }catch(e){setState({err:"Image: "+e.message,phase:state.noteText?"done":""});}
}
function pickImage(target){
  const inp=document.createElement("input");inp.type="file";inp.accept="image/*";inp.capture="environment";
  inp.onchange=()=>{if(inp.files[0])analyzeImage(inp.files[0],target||"text");};inp.click();
}
// Paste image support
document.addEventListener("paste",function(e){
  const items=e.clipboardData?.items;if(!items)return;
  for(let i=0;i<items.length;i++){
    if(items[i].type.startsWith("image/")){
      e.preventDefault();
      const act=document.activeElement;
      const target=(act&&act.id==="addendInput")?"addend":"text";
      analyzeImage(items[i].getAsFile(),target);
      return;
    }
  }
});

// Anthropic Claude API
async function callAPI(msgs,sys){
  const body={model:"claude-sonnet-4-20250514",max_tokens:8192,messages:msgs};
  if(sys)body.system=sys;
  const res=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":API_KEY,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify(body)});
  if(!res.ok){const et=await res.text();throw new Error("API "+res.status+": "+(et.slice(0,300)));}
  const d=await res.json();if(d.error)throw new Error(d.error.message||JSON.stringify(d.error));
  return{txt:d.content.map(c=>c.type==="text"?c.text:"").filter(Boolean).join("\n"),stop:d.stop_reason};
}
// FIX #7: pass accumulated full text in continuations, not just latest chunk
async function callC(msgs,mx,sys){
  let{txt,stop}=await callAPI(msgs,sys);
  let full=txt;let m=[...msgs];
  for(let i=0;i<(mx||2);i++){
    if(stop!=="max_tokens")break;
    m=[...m,{role:"assistant",content:full},{role:"user",content:"Continue exactly where you left off."}];
    const r=await callAPI(m,sys);
    full+="\n"+r.txt;stop=r.stop;
  }
  return{txt:full,msgs:m};
}
// ---- STATE ---- FIX #3: removed imgLoading (dead prop)
let state={
  view:"input",text:"",nt:"operative",macro:null,macroVals:{},
  clinicVisit:"new",clinicPt:"new",showEMRef:false,
  noteText:"",billRaw:"",gaps:[],flags:[],financial:null,
  billCodes:"",billMod:"",billICD:"",billBundle:"",billPreauth:"",
  workup:[],wuChecked:{},questions:[],qEdits:{},convo:[],phase:"",err:null,
  cases:migrateCases(),selCase:null,addend:"",addTarget:"note",caseTab:"all",
  wk:ls("opnote-wkey",""),ce:ls("opnote-email",""),sn:ls("opnote-surgeon","Diaz"),
  showSettings:false,showQR:false,editing:false,editText:"",_gc:{},_fi:{},_qc:{},renaming:null,levelUpResult:null,
  tStart:null,tNote:null,tCopy:null,
  linkedTo:null,detailNoteIdx:0
};
function setState(p){Object.assign(state,p);render();}

// FIX #1: single setState call, update selCase in same call
function renameCase(id,n){
  const cases=state.cases.map(c=>c.id===id?{...c,proc:n}:c);
  const upd={cases};
  if(state.selCase?.id===id)upd.selCase={...state.selCase,proc:n};
  lsS(SK,cases);setState(upd);
}
function deleteCase(id){const cases=state.cases.filter(c=>c.id!==id);lsS(SK,cases);setState({cases,selCase:null,view:"cases"});}

// ---- ACTIONS ----
async function processCase(){
  let{text,nt,macro,macroVals,linkedTo}=state;
  if(macro&&MACROS[macro]){text=macroToDict(macro,macroVals);}
  if(!text.trim())return;
  if(!API_KEY){setState({err:"‚ö†Ô∏è Add your Anthropic API key in Settings (gear icon) to process notes."});return;}
  const tStart=Date.now();
  setState({err:null,noteText:"",billRaw:"",billCodes:"",billMod:"",billICD:"",billBundle:"",billPreauth:"",gaps:[],flags:[],financial:null,workup:[],wuChecked:{},questions:[],qEdits:{},addend:"",editing:false,view:"output",phase:"note",_gc:{},_fi:{},tStart,tNote:null,tCopy:null});
  try{
    // FIX #12: system prompt via system parameter, user message is just note type + dictation
    let ntLabel=TYPES[nt]?.l||nt;
    let clinicCtx="";
    if(nt==="clinic"){
      const vLabels={new:"NEW VISIT",followup:"FOLLOW-UP VISIT",postop:"POST-OPERATIVE VISIT"};
      clinicCtx="\nVISIT TYPE: "+(vLabels[state.clinicVisit]||"NEW VISIT");
      clinicCtx+="\nPATIENT STATUS: "+(state.clinicPt==="established"?"ESTABLISHED PATIENT":"NEW PATIENT");
    }
    const sysPrompt=getSYS()+"\nNOTE TYPE: "+ntLabel+clinicCtx+P1END;
    const userMsg="DICTATION:\n\n"+text.trim();
    const{txt:noteRaw,msgs}=await callC([{role:"user",content:userMsg}],3,sysPrompt);
    if(!noteRaw.trim())throw new Error("Empty response");
    const{questions,note:rN}=parseQuestions(noteRaw);
    const{note:rawNote,wu}=parseWorkup(rN);
    const note=stripBilling(rawNote);
    if(!note.trim())throw new Error("Note failed ‚Äî add more detail.");
    const tNote=Date.now();
    // Feature 5: Merge smart defaults ‚Äî add if AI didn't already ask similar
    const smartQs=(SMART_QS[nt]||[]).filter(sq=>!questions.some(q=>q.q.toLowerCase().includes(sq.q.split(" ").slice(0,3).join(" ").toLowerCase())));
    const allQs=[...questions,...smartQs.map(sq=>({q:sq.q,def:sq.def}))];
    setState({noteText:note,workup:wu,questions:allQs,convo:msgs,phase:"billing",tNote,_sysPrompt:sysPrompt});

    // FIX #13: billing in separate try/catch ‚Äî note stays usable on billing failure
    try{
      const{txt:bRaw}=await callC([...msgs,{role:"assistant",content:noteRaw},{role:"user",content:P2}],2,sysPrompt);
      const sec=parseBillFull(bRaw);
      // Inject MDM complexity into clinic/consult note header
      const updNote=injectMDM(state.noteText,sec.codes,state.nt);
      if(updNote!==state.noteText)state.noteText=updNote;
      setState({billRaw:bRaw,billCodes:sec.codes,billMod:sec.modifiers,billICD:sec.icd,billBundle:sec.bundling,billPreauth:sec.preauth,gaps:parseGaps(sec.gaps),flags:parseFlags(sec.flags),financial:parseFinancial(sec.financial),phase:"done"});
    }catch(be){
      setState({err:"Billing failed: "+be.message+". Note is still usable above.",phase:"done"});
    }

    // Save ‚Äî FIX #9: store parsed note (cleanNote) not raw with Q/DEFAULT
    const pm=note.match(/PROCEDURE[^:]*:\s*([^\n]+)/i)||note.match(/ASSESSMENT[^:]*:\s*([^\n]+)/i)||note.match(/REASON[^:]*:\s*([^\n]+)/i);
    const proc=pm?pm[1].slice(0,70).trim():"Case";
    const cpts=[...new Set([...(note+(state.billRaw||"")).matchAll(/\b(\d{5})\b/g)].map(m=>m[1]).filter(c=>{const n=+c;return(n>=10000&&n<=69999)||(n>=99200&&n<=99499);}))].slice(0,12);
    const noteEntry={type:nt,ts:new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),note:note,billRaw:state.billRaw||"",dict:text,tStart,tNote,tDone:Date.now()};

    if(linkedTo){
      // FIX #2: update selCase alongside cases so detail view shows new note
      const cases=state.cases.map(c=>{
        if(c.id!==linkedTo)return c;
        // FIX #4: use noteTypeFromCat for legacy entries without notes array
        const notes=c.notes?[...c.notes]:[{type:noteTypeFromCat(c.cat),ts:c.ts,note:c.note||"",billRaw:c.billRaw||"",dict:c.dict||""}];
        notes.push(noteEntry);return{...c,notes};
      });
      const updatedCase=cases.find(c=>c.id===linkedTo);
      const newIdx=updatedCase?.notes?updatedCase.notes.length-1:0;
      lsS(SK,cases);setState({cases,selCase:updatedCase||null,detailNoteIdx:newIdx});
    }else{
      const entry={id:Date.now().toString(36)+Math.random().toString(36).slice(2,4),ts:new Date().toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),date:new Date().toLocaleDateString("en-US",{month:"short",day:"numeric"}),proc,cpts,cat:typeCat(nt),dict:text,note:note,billRaw:state.billRaw||"",notes:[noteEntry]};
      const cases=[entry,...state.cases].slice(0,200);lsS(SK,cases);setState({cases});
    }
  }catch(e){setState({err:e.message,phase:""});}
}

// Fix 4: Common incorporate helper ‚Äî adds anti-duplication suffix and dedup
async function incorporate(userPrompt,phase){
  setState({phase:phase||"incorporate",err:null});
  try{
    const msgs=[...state.convo,{role:"assistant",content:state.noteText},{role:"user",content:userPrompt+INC_SUFFIX}];
    const{txt}=await callC(msgs,2,state._sysPrompt);
    const{note:raw}=parseWorkup(txt.replace(/^[\n]*NOTE:\s*\n?/i,"").trim());
    const note=dedupNote(stripBilling(raw));
    return{note:note||state.noteText,msgs};
  }catch(e){setState({err:e.message,phase:"done"});return null;}
}

// Questions: batch processing ‚Äî check answers then apply all at once
async function useQBatch(){
  const checked=state.questions.map((q,i)=>{
    const val=state.qEdits[i]!==undefined?state.qEdits[i]:q.def;
    const isChecked=!state._qc||Object.keys(state._qc).length===0||state._qc[i]!==false;
    return{q:q.q,val:val.trim(),idx:i,checked:isChecked};
  }).filter(x=>x.val&&x.checked);
  if(!checked.length)return;
  const answers=checked.map((c,i)=>(i+1)+". "+c.q+"\n   Answer: "+c.val).join("\n\n");
  const r=await incorporate("Incorporate ALL of the following answers. Regenerate COMPLETE note. Mark ***ADDED***.\n\n"+answers,"addend");
  if(r){const usedIdx=new Set(checked.map(c=>c.idx));setState({noteText:r.note,convo:r.msgs,questions:state.questions.filter((_,i)=>!usedIdx.has(i)),qEdits:{},_qc:{},phase:"done"});}
}

async function incGap(idx){const g=state.gaps[idx];if(!g)return;const r=await incorporate("Add to appropriate section. Regenerate COMPLETE note. Mark ***ADDED***.\n\n"+(g.language||g.issue));if(r){const nG=[...state.gaps];nG.splice(idx,1);setState({noteText:r.note,convo:r.msgs,gaps:nG,_gc:{},phase:"done"});}}

async function incGapHPI(idx){const g=state.gaps[idx];if(!g)return;const r=await incorporate("Add the following SPECIFICALLY TO THE HPI section. Regenerate COMPLETE note. Mark ***ADDED***.\n\n"+(g.language||g.issue));if(r){const nG=[...state.gaps];nG.splice(idx,1);setState({noteText:r.note,convo:r.msgs,gaps:nG,_gc:{},phase:"done"});}}

async function doAddendTarget(target){
  if(!state.addend.trim())return;
  const tLabels={hpi:"Add the following to the HPI section",ap:"Add the following to the ASSESSMENT AND PLAN section",exam:"Add the following to the EXAM section",note:"Add the following to the appropriate section"};
  const r=await incorporate((tLabels[target]||tLabels.note)+". Regenerate COMPLETE note. Mark ***ADDED***.\n\n"+state.addend.trim(),"addend");
  if(r)setState({noteText:r.note,convo:r.msgs,addend:"",phase:"done"});
}

async function incSelGaps(){const sel=state.gaps.filter((_,i)=>state._gc[i]);if(!sel.length)return;const langs=sel.map((g,i)=>(i+1)+". "+(g.language||g.issue)).join("\n\n");const r=await incorporate("Incorporate ALL. Regenerate COMPLETE note. Mark ***ADDED***.\n\n"+langs);if(r)setState({noteText:r.note,convo:r.msgs,gaps:state.gaps.filter((_,i)=>!state._gc[i]),_gc:{},phase:"done"});}

async function incFlag(idx){const f=state.flags[idx];if(!f)return;const prompt=f.input?"The following flag has been CONFIRMED. Incorporate the recommendation into the note. Regenerate COMPLETE note. Mark ***ADDED***.\n\nFLAG: "+f.text+"\nACTION: "+f.input:"The following flag has been CONFIRMED. Address it by adding the appropriate documentation to the note. Regenerate COMPLETE note. Mark ***ADDED***.\n\nFLAG: "+f.text;const r=await incorporate(prompt);if(r){const nF=[...state.flags];nF[idx]={...nF[idx],type:"GREEN",text:nF[idx].text+" ‚Äî RESOLVED",input:null};setState({noteText:r.note,convo:r.msgs,flags:nF,phase:"done"});}}
function dismissFlag(idx){const nF=[...state.flags];nF[idx]={...nF[idx],type:"GREEN",text:nF[idx].text+" ‚Äî N/A",input:null};setState({flags:nF});}

async function incWU(){const sel=state.workup.filter((_,i)=>state.wuChecked[i]);if(!sel.length)return;const r=await incorporate("Add these workup items into the ASSESSMENT AND PLAN section as ordered items. Regenerate COMPLETE note. Mark ***ADDED***.\n\n"+sel.map((w,i)=>(i+1)+". "+w).join("\n"),"workup");if(r)setState({noteText:r.note,convo:r.msgs,workup:state.workup.filter((_,i)=>!state.wuChecked[i]),wuChecked:{},phase:"done"});}

async function doAddend(){if(!state.addend.trim())return;const r=await incorporate("Add. Regenerate COMPLETE. Mark ***ADDED***.\n\n"+state.addend.trim(),"addend");if(r)setState({noteText:r.note,convo:r.msgs,addend:"",phase:"done"});}

function copyText(t,bid){const c=stripAll(t);navigator.clipboard.writeText(c).catch(()=>{const el=document.createElement("textarea");el.value=c;el.style.cssText="position:fixed;left:-9999px";document.body.appendChild(el);el.select();document.execCommand("copy");document.body.removeChild(el);});if(!state.tCopy)setState({tCopy:Date.now()});const b=document.getElementById(bid);if(b){const o=b.innerHTML;b.innerHTML="\u2705 Copied!";b.style.background="#059669";setTimeout(()=>{if(b){b.innerHTML=o;b.style.background="";}},2000);}}

// Format note for EMR ‚Äî add line spacing between sections, strip all markers
function formatEMR(t){
  const clean=stripAll(stripBilling(t));
  // Add blank line before section headers (ALL CAPS WITH COLON)
  return clean.replace(/\n(?=[A-Z][A-Z /&\-]{2,}:)/g,"\n\n").replace(/\n{3,}/g,"\n\n").trim();
}

// Copy as rich HTML ‚Äî bold headers, line spacing, clean for PowerChart
function copyHTML(t,bid){
  const txt=formatEMR(t);
  const lines=txt.split("\n");
  let html="";let plain="";
  lines.forEach(ln=>{
    const trimmed=ln.trim();
    if(/^[A-Z][A-Z /&\-]{2,}:/.test(trimmed)){
      html+="<b>"+esc(trimmed)+"</b><br>";
    }else if(!trimmed){
      html+="<br>";
    }else{
      html+=esc(trimmed)+"<br>";
    }
    plain+=trimmed+"\n";
  });
  plain=plain.trim();
  try{
    const blob=new Blob([html],{type:"text/html"});
    const blobT=new Blob([plain],{type:"text/plain"});
    navigator.clipboard.write([new ClipboardItem({"text/html":blob,"text/plain":blobT})]);
  }catch(e){navigator.clipboard.writeText(plain).catch(()=>{});}
  if(!state.tCopy)setState({tCopy:Date.now()});
  const b=document.getElementById(bid);if(b){const o=b.innerHTML;b.innerHTML="\u2705 Copied (Rich)!";b.style.background="#059669";setTimeout(()=>{if(b){b.innerHTML=o;b.style.background="";}},2000);}
}

// Copy as plain text ‚Äî no bold, no markers, just clean spaced text
function copyPlain(t,bid){
  const plain=formatEMR(t);
  navigator.clipboard.writeText(plain).catch(()=>{const el=document.createElement("textarea");el.value=plain;el.style.cssText="position:fixed;left:-9999px";document.body.appendChild(el);el.select();document.execCommand("copy");document.body.removeChild(el);});
  if(!state.tCopy)setState({tCopy:Date.now()});
  const b=document.getElementById(bid);if(b){const o=b.innerHTML;b.innerHTML="\u2705 Copied (Plain)!";b.style.background="#059669";setTimeout(()=>{if(b){b.innerHTML=o;b.style.background="";}},2000);}
}
function copyDetHTML(){const cn=getDetailNote();if(cn)copyHTML(cn.note||"","cpDetH");}
function copyDetPlain(){const cn=getDetailNote();if(cn)copyPlain(cn.note||"","cpDetP");}

// Procedure log export
function copyProcLog(){
  const cases=state.cases||[];
  let out="Date\tProcedure\tType\tRVU\n";
  cases.forEach(c=>{
    const notes=c.notes||[{billRaw:c.billRaw||""}];
    let rvu="-";notes.forEach(n=>{const rm=(n.billRaw||"").match(/TOTAL RVU:\s*([\d.]+)/i);if(rm)rvu=rm[1];});
    out+=(c.date||c.ts||"")+"\t"+(c.proc||"")+"\t"+(c.cat||"")+"\t"+rvu+"\n";
  });
  navigator.clipboard.writeText(out).catch(()=>{});
  const b=document.querySelector('[onclick*="copyProcLog"]');if(b){const o=b.innerHTML;b.innerHTML="\u2705";setTimeout(()=>{b.innerHTML=o;},2000);}
}

// Feature 5: Smart default questions per note type
const SMART_QS={
  critical:[{q:"Total time spent on this patient encounter including history, examination, review of imaging, discussion with patient/family, and coordination of care?",def:"45 minutes total encounter time"}],
  operative:[{q:"Estimated blood loss?",def:"Minimal"},{q:"Was neuromonitoring used?",def:"No neuromonitoring utilized"}],
  clinic:[{q:"Follow-up interval?",def:"Return in 6 weeks with new imaging"},{q:"Work status/activity restrictions?",def:"No restrictions"}],
  consult:[{q:"Total time spent on this consultation?",def:"35 minutes"}],
  progress:[]
};

// Feature 2: Re-analyze billing on existing note
async function reBill(){
  const cn=getDetailNote();if(!cn||!cn.note)return;
  setState({phase:"billing",err:null});
  try{
    const sysPrompt=getSYS()+"\nNOTE TYPE: "+noteTypeLabel(cn.type||"operative")+P1END;
    const msgs=[{role:"user",content:"Here is the completed clinical note:\n\n"+cn.note}];
    const{txt:bRaw}=await callC([...msgs,{role:"assistant",content:cn.note},{role:"user",content:P2}],2,sysPrompt);
    const sec=parseBillFull(bRaw);
    // Update the note entry in the case
    const idx=state.detailNoteIdx||0;
    const cases=state.cases.map(c=>{
      if(c.id!==state.selCase.id)return c;
      const notes=[...(c.notes||[])];
      if(notes[idx])notes[idx]={...notes[idx],billRaw:bRaw};
      return{...c,notes};
    });
    const updCase=cases.find(c=>c.id===state.selCase.id);
    lsS(SK,cases);
    setState({cases,selCase:updCase,billRaw:bRaw,billCodes:sec.codes,billMod:sec.modifiers,billICD:sec.icd,billBundle:sec.bundling,billPreauth:sec.preauth,gaps:parseGaps(sec.gaps),flags:parseFlags(sec.flags),financial:parseFinancial(sec.financial),phase:"done"});
  }catch(e){setState({err:"Re-bill failed: "+e.message,phase:"done"});}
}

// Level Up ‚Äî analyze current billing and show exactly what to add for higher level
const LEVELUP_PROMPT=`You are a neurosurgery billing optimization expert. Analyze this note and its billing.

Respond in EXACTLY this format:

CURRENT LEVEL:
[Current E/M code or primary CPT with RVU. For clinic: 99213/99214/99215 etc. For operative: list primary CPT. For consult: 99252-99255. For critical care: 99291]

CURRENT RVU: [number]

MAX ACHIEVABLE LEVEL:
[Highest defensible code/level with RVU if documentation is added]

MAX RVU: [number]

RVU GAIN: [difference]

WHAT TO ADD:
[Numbered list ‚Äî each item is a SPECIFIC, CONCRETE documentation element to add to the note. Be extremely specific ‚Äî not "document complexity" but "add: patient has 3+ chronic conditions requiring medication adjustment". For E/M: what MDM elements are missing. For operative: what additional billable procedures could be documented. For -22 modifier: exact complexity language needed.]

1. [specific item to document + exact language to add]
2. [specific item to document + exact language to add]
3. [etc]

ADDITIONAL CODES:
[Any additional CPT codes that could be billed if documentation supports. One per line: CODE - Description (X.X RVU) ‚Äî what to document]

DOCUMENTATION TEMPLATE:
[Ready-to-paste text block that adds all the above elements to the note. Write it as actual clinical text, not instructions.]`;

async function levelUp(noteText,billRaw){
  setState({phase:"levelup",err:null,levelUpResult:null});
  const note=noteText||state.noteText;
  const bill=billRaw||state.billRaw;
  try{
    const sys=`You are a neurosurgery billing optimization expert specializing in maximizing legitimate, defensible reimbursement through complete documentation.
Key knowledge:
E/M 2021 RULES: Level determined by MDM complexity (# problems, data reviewed, risk). 
- 99213 (Low MDM, 1.30 RVU) ‚Üí 99214 (Moderate, 1.92 RVU) ‚Üí 99215 (High, 2.80 RVU)
- Moderate MDM needs: 2+ chronic conditions OR prescription drug management OR test ordering with review
- High MDM needs: 1+ chronic illness with severe exacerbation OR drug requiring monitoring OR decision about hospitalization/surgery
CONSULT: 99252 (1.55) ‚Üí 99253 (2.11) ‚Üí 99254 (3.18) ‚Üí 99255 (3.86). Higher = more MDM + data.
CRITICAL CARE: 99291 (10.0 RVU) requires 30+ min attestation + critical illness documentation.
OPERATIVE: Look for additional billable procedures, -22 modifier opportunities, navigation codes, graft codes.
-22 MODIFIER: Requires documentation of SPECIFIC increased complexity (adhesions, anomaly, BMI>40, revision, etc). Adds 20-30% to primary code.`;
    const{txt}=await callC([{role:"user",content:"Here is the clinical note:\n\n"+note+"\n\nCurrent billing analysis:\n\n"+bill+"\n\n"+LEVELUP_PROMPT}],2,sys);
    setState({levelUpResult:txt,phase:"done"});
  }catch(e){setState({err:"Level Up failed: "+e.message,phase:"done"});}
}

function parseLevelUp(raw){
  if(!raw)return null;
  const r={currentLevel:"",currentRVU:"",maxLevel:"",maxRVU:"",rvuGain:"",items:[],addCodes:[],template:""};
  const cl=raw.match(/CURRENT LEVEL:\s*\n?(.*?)(?:\n|$)/i);if(cl)r.currentLevel=cl[1].trim();
  const cr=raw.match(/CURRENT RVU:\s*([\d.]+)/i);if(cr)r.currentRVU=cr[1];
  const ml=raw.match(/MAX ACHIEVABLE LEVEL:\s*\n?(.*?)(?:\n|$)/i);if(ml)r.maxLevel=ml[1].trim();
  const mr=raw.match(/MAX RVU:\s*([\d.]+)/i);if(mr)r.maxRVU=mr[1];
  const rg=raw.match(/RVU GAIN:\s*([\d.]+)/i);if(rg)r.rvuGain=rg[1];
  const wm=raw.match(/WHAT TO ADD:\s*\n([\s\S]*?)(?=\nADDITIONAL CODES:|\nDOCUMENTATION TEMPLATE:|$)/i);
  if(wm)r.items=wm[1].split("\n").filter(l=>/^\d+[\.\)]/.test(l.trim())).map(l=>l.replace(/^\d+[\.\)]\s*/,"").trim());
  const ac=raw.match(/ADDITIONAL CODES:\s*\n([\s\S]*?)(?=\nDOCUMENTATION TEMPLATE:|$)/i);
  if(ac)r.addCodes=ac[1].split("\n").filter(l=>l.trim()).map(l=>l.trim());
  const tm=raw.match(/DOCUMENTATION TEMPLATE:\s*\n([\s\S]*?)$/i);
  if(tm)r.template=tm[1].trim();
  return r;
}
function fmtTime(ms){if(!ms)return"";const s=Math.round(ms/1000);return s<60?s+"s":Math.floor(s/60)+"m "+s%60+"s";}

// FIX #10: always read from state.selCase + current noteIdx for detail helpers
function getDetailNote(){
  if(!state.selCase)return null;
  const notes=state.selCase.notes||[{type:noteTypeFromCat(state.selCase.cat),note:state.selCase.note||"",billRaw:state.selCase.billRaw||"",dict:state.selCase.dict||""}];
  return notes[Math.min(state.detailNoteIdx||0,notes.length-1)]||null;
}
function copyDetNote(){const cn=getDetailNote();if(cn)copyText(cn.note||"","cpDet");}
function coderDetExport(){const cn=getDetailNote();if(!cn)return"";return coderExport(cn.note||"",cn.billRaw||"");}
// ---- RENDER ----
function render(){
  const s=state;const app=document.getElementById("app");
  const hasWK=!!s.wk;const isL=s.phase&&s.phase!=="done"&&s.phase!=="";
  const ph={note:"Generating note...",billing:"Analyzing billing...",incorporate:"Incorporating...",addend:"Updating...",workup:"Adding workup...",image:"Analyzing image...",levelup:"Analyzing billing levels..."};
  let h="";

  // Header
  h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div><div style="font-size:20px;font-weight:800;color:#fff">OpNote Intelligence</div><div style="font-size:11px;color:#475569;margin-top:2px">v9.2 \u00b7 ${TODAY}${syncStatus==="ready"?' \u00b7 <span style="color:#86efac">Synced</span>':""}</div></div><div style="display:flex;gap:6px">`;
  h+=`<button class="btn" style="background:#334155" onclick="setState({showSettings:!state.showSettings})">\u2699\uFE0F</button>`;
  if(s.view!=="input")h+=`<button class="btn" style="background:#1e3a5f" onclick="setState({view:'input',noteText:'',billRaw:'',gaps:[],flags:[],financial:null,workup:[],questions:[],err:null,phase:'',editing:false,addend:'',addTarget:'note',text:'',_gc:{},_fi:{},_qc:{},macro:null,macroVals:{},tStart:null,tNote:null,tCopy:null,linkedTo:null,_sysPrompt:null,clinicVisit:'new',clinicPt:'new',showEMRef:false})">+ New</button>`;
  h+=`</div></div>`;

  // Settings
  if(s.showSettings){
    h+=`<div style="background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;margin-bottom:12px">`;
    h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin-bottom:10px">SETTINGS</div>`;
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">Anthropic API Key <span style="color:#f87171">(required)</span></div>`;
    h+=`<input type="password" class="inp" value="${esc(API_KEY)}" placeholder="sk-ant-..." onchange="API_KEY=this.value;localStorage.setItem('opnote-api-key',this.value);render()" style="margin-bottom:4px">`;
    h+=API_KEY?`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:11px;color:#86efac">\u2713 Active</span><button class="btn" style="background:#1e3a5f;padding:4px 10px;font-size:10px;min-height:24px" onclick="shareKeyToPhone()">üì± Share to Phone</button></div>`:`<div style="font-size:11px;color:#f87171;margin-bottom:8px">Required to process notes</div>`;
    // QR modal
    if(s.showQR){
      h+=`<div style="background:#020617;border:1px solid #2563eb;border-radius:10px;padding:14px;margin-bottom:8px;text-align:center">`;
      h+=`<div style="font-size:12px;color:#e2e8f0;margin-bottom:8px;font-weight:700">üì± Scan with your phone camera</div>`;
      h+=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.origin+window.location.pathname+'#key='+API_KEY)}" style="border-radius:8px;background:#fff;padding:8px;max-width:200px">`;
      h+=`<div style="font-size:10px;color:#64748b;margin-top:8px">Or copy this link and open on your phone:</div>`;
      h+=`<input class="inp" readonly value="${window.location.origin+window.location.pathname}#key=${API_KEY}" onclick="this.select();document.execCommand('copy');alert('Link copied!')" style="font-size:10px;margin-top:4px;cursor:pointer">`;
      h+=`<div style="font-size:9px;color:#475569;margin-top:6px">\u{1F512} Key stays in the URL hash ‚Äî never sent to any server</div>`;
      h+=`<button class="btn" style="background:#334155;padding:6px 14px;font-size:11px;margin-top:8px" onclick="setState({showQR:false})">Close</button>`;
      h+=`</div>`;
    }
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">Surgeon Name</div>`;
    h+=`<input class="inp" value="${esc(s.sn)}" placeholder="Last name" onchange="state.sn=this.value;lsS('opnote-surgeon',this.value);render()" style="margin-bottom:8px">`;
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">OpenAI Key <span style="color:#475569">(Whisper)</span></div>`;
    h+=`<input type="password" class="inp" value="${esc(s.wk)}" placeholder="sk-..." onchange="state.wk=this.value;lsS('opnote-wkey',this.value);render()" style="margin-bottom:4px">`;
    h+=hasWK?`<div style="font-size:11px;color:#86efac;margin-bottom:8px">\u2713 Active</div>`:`<div style="font-size:11px;color:#94a3b8;margin-bottom:8px">Optional</div>`;
    h+=`<div style="font-size:12px;color:#64748b;margin-bottom:4px">Coder Email</div>`;
    h+=`<input class="inp" value="${esc(s.ce)}" placeholder="coder@practice.com" onchange="state.ce=this.value;lsS('opnote-email',this.value);render()" style="margin-bottom:8px">`;
    h+=`<div style="display:flex;gap:8px"><button class="btn" style="background:#334155;flex:1" onclick="exportCases()">\u{1F4E5} Export ${s.cases.length}</button><button class="btn" style="background:#334155;flex:1" onclick="pickImport()">\u{1F4E4} Import</button></div>`;
    // Cloud sync ‚Äî universal
    h+=`<div style="margin-top:8px;padding:10px;background:#020617;border:1px solid #1e293b;border-radius:8px">`;
    h+=`<div style="font-size:12px;font-weight:700;color:#64748b;margin-bottom:8px">\u{2601}\uFE0F OneDrive</div>`;
    if(OD_CLIENT_ID){
      const connected=!!odAccount;
      h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:11px;color:#94a3b8">Status</span><span style="font-size:11px;color:${connected?"#86efac":"#fbbf24"}">${connected?"\u{2705} "+odAccount.username:"\u{1F511} Not signed in"}</span></div>`;
      if(!connected)h+=`<button class="btn" style="background:#1d4ed8;width:100%;padding:10px;font-size:12px" onclick="odLogin().then(()=>render())">Sign in to OneDrive</button>`;
      else h+=`<button class="btn" style="background:#334155;width:100%;padding:10px;font-size:12px" onclick="msalApp.logout();odAccount=null;render()">Sign out</button>`;
      h+=`<button class="btn" style="background:#7f1d1d;width:100%;margin-top:4px;padding:6px;font-size:10px" onclick="localStorage.removeItem('opnote-od-clientid');location.reload()">Reset Client ID</button>`;
    }else{
      h+=`<button class="btn" style="background:#1d4ed8;width:100%;padding:10px;font-size:12px" onclick="openOD()">Setup OneDrive Connection</button>`;
      h+=`<div style="font-size:10px;color:#475569;margin-top:6px">Browse OneDrive folders directly from the app</div>`;
    }
    h+=`</div>`;
    h+=`</div>`;
  }

  // Tabs
  h+=`<div class="tabs"><button class="tab ${s.view==="input"||s.view==="output"?"on":""}" onclick="setState({view:state.noteText?'output':'input'})">${s.noteText?"\u{1F4CB} Current":"\u{1F3A4} New"}</button>`;
  h+=`<button class="tab ${s.view==="cases"||s.view==="detail"?"on":""}" onclick="setState({view:'cases'})">\u{1F4C2} Cases${s.cases.length?" ("+s.cases.length+")":""}</button>`;
  h+=`<button class="tab ${s.view==="stats"?"on":""}" onclick="setState({view:'stats'})">\u{1F4CA} Stats</button></div>`;

  // ==== INPUT ====
  if(s.view==="input"){
    // FIRST-RUN SETUP WIZARD
    const skipSetup=localStorage.getItem('opnote-skip-setup')==='1';
    if(!API_KEY&&!skipSetup){
      h+=`<div style="background:linear-gradient(135deg,#0c1220,#172554);border:2px solid #2563eb;border-radius:16px;padding:20px;margin-bottom:16px">`;
      h+=`<div style="font-size:18px;font-weight:800;color:#e2e8f0;margin-bottom:4px">\u{1F680} OpNote Intelligence Setup</div>`;
      h+=`<div style="font-size:12px;color:#64748b;margin-bottom:16px">Just one step to get started</div>`;
      
      // API Key input
      h+=`<div style="background:#020617;border:1px solid #1e293b;border-radius:12px;padding:14px;margin-bottom:10px">`;
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">`;
      h+=`<span style="font-size:20px">\u{1F511}</span>`;
      h+=`<span style="font-size:14px;font-weight:700;color:#e2e8f0">Anthropic API Key</span></div>`;
      h+=`<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;line-height:1.5">Get yours at <b style="color:#60a5fa">console.anthropic.com</b> ‚Üí API Keys ‚Üí Create Key</div>`;
      h+=`<input id="setupApiKey" type="password" class="inp" placeholder="sk-ant-..." style="margin-bottom:6px;font-size:14px">`;
      h+=`<button class="btn" style="background:#2563eb;width:100%;padding:12px;font-size:13px" onclick="const v=document.getElementById('setupApiKey').value.trim();if(v){API_KEY=v;localStorage.setItem('opnote-api-key',v);render();}else{alert('Paste your API key first');}">Save API Key</button>`;
      h+=`</div>`;
      
      // Skip option
      h+=`<div style="text-align:center;margin-top:8px"><button style="background:none;border:none;color:#475569;font-size:11px;text-decoration:underline" onclick="localStorage.setItem('opnote-skip-setup','1');render()">Skip for now</button></div>`;
      h+=`</div>`;
    }
    
    // OneDrive sign-in prompt (separate, always shows if not signed in and has key)
    if(API_KEY&&OD_CLIENT_ID&&!odAccount&&!skipSetup){
      h+=`<div style="background:#020617;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between">`;
      h+=`<span style="font-size:12px;color:#94a3b8">\u{2601}\uFE0F Connect OneDrive to sync cases</span>`;
      h+=`<button class="btn" style="background:#1d4ed8;padding:8px 14px;font-size:11px;min-height:32px" onclick="odLogin().then(()=>render())">Sign in</button>`;
      h+=`</div>`;
    }
    h+=`<div style="display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap">`;
    Object.entries(TYPES).forEach(([id,t])=>{h+=`<button class="btn" style="background:${s.nt===id?"#2563eb":"#1e293b"};padding:10px 12px;font-size:12px;flex:1;min-width:0;white-space:nowrap" onclick="setState({nt:'${id}',macro:null,macroVals:{}})">${t.e} ${t.l.replace("Inpatient ","")}</button>`;});
    h+=`</div>`;

    // Clinic sub-selectors: visit type + new/established + E/M ref
    if(s.nt==="clinic"){
      h+=`<div style="display:flex;gap:6px;margin-bottom:8px">`;
      ["new","followup","postop"].forEach(v=>{const labels={new:"New Visit",followup:"Follow-up",postop:"Post-Op"};h+=`<button class="btn" style="background:${s.clinicVisit===v?"#2563eb":"#334155"};flex:1;padding:8px;font-size:12px" onclick="setState({clinicVisit:'${v}'})">${labels[v]}</button>`;});
      h+=`</div>`;
      h+=`<div style="display:flex;gap:6px;margin-bottom:8px">`;
      h+=`<button class="btn" style="background:${s.clinicPt==="new"?"#7c3aed":"#334155"};flex:1;padding:8px;font-size:12px" onclick="setState({clinicPt:'new'})">\u{1F195} New Patient</button>`;
      h+=`<button class="btn" style="background:${s.clinicPt==="established"?"#7c3aed":"#334155"};flex:1;padding:8px;font-size:12px" onclick="setState({clinicPt:'established'})">\u{1F504} Established</button>`;
      h+=`</div>`;
      h+=`<button style="font-size:11px;color:#8b5cf6;background:none;border:none;margin-bottom:8px;text-decoration:underline" onclick="setState({showEMRef:!state.showEMRef})">${s.showEMRef?"\u25B2 Hide":"\u25BC Show"} E/M Complexity Reference</button>`;
      if(s.showEMRef){
        h+=`<div style="background:#0f172a;border:1px solid #1e293b;border-radius:8px;padding:10px;margin-bottom:10px;font-size:11px;line-height:1.6">`;
        h+=`<div style="font-weight:700;color:#c4b5fd;margin-bottom:6px">${s.clinicPt==="new"?"NEW PATIENT (99202-99205)":"ESTABLISHED (99212-99215)"}</div>`;
        h+=`<div style="display:grid;gap:6px">`;
        h+=`<div style="padding:6px 8px;background:#020617;border-radius:6px;border-left:3px solid #475569"><span style="color:#94a3b8;font-weight:700">STRAIGHTFORWARD</span><br><span style="color:#64748b">1 self-limited problem \u00b7 Minimal data review \u00b7 Minimal risk</span></div>`;
        h+=`<div style="padding:6px 8px;background:#020617;border-radius:6px;border-left:3px solid #60a5fa"><span style="color:#60a5fa;font-weight:700">LOW</span><br><span style="color:#64748b">2+ self-limited OR 1 stable chronic \u00b7 Limited data (order/review tests) \u00b7 Low risk (OTC meds, PT)</span></div>`;
        h+=`<div style="padding:6px 8px;background:#020617;border-radius:6px;border-left:3px solid #fbbf24"><span style="color:#fbbf24;font-weight:700">MODERATE</span><br><span style="color:#64748b">1 chronic exacerbation OR 2 stable chronic OR new problem w/ workup \u00b7 Moderate data (order + review, external records) \u00b7 Moderate risk (Rx management, minor surgery decision)</span></div>`;
        h+=`<div style="padding:6px 8px;background:#020617;border-radius:6px;border-left:3px solid #f87171"><span style="color:#f87171;font-weight:700">HIGH</span><br><span style="color:#64748b">1 chronic severe exacerbation OR acute life-threatening \u00b7 Extensive data (independent interpretation of tests) \u00b7 High risk (hospitalize, emergency surgery, drug monitoring)</span></div>`;
        h+=`</div></div>`;
      }
    }
    if(s.nt==="operative"){
      h+=`<div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">`;
      h+=`<button class="btn" style="background:${!s.macro?"#2563eb":"#334155"};font-size:12px;padding:8px 14px" onclick="setState({macro:null,macroVals:{}})">\u{1F4DD} Free Dictation</button>`;
      Object.entries(MACROS).forEach(([id,m])=>{h+=`<button class="btn" style="background:${s.macro===id?"#2563eb":"#334155"};font-size:12px;padding:8px 14px" onclick="setState({macro:'${id}',macroVals:{}})">${m.name}</button>`;});
      h+=`</div>`;
    }

    // Macro form OR free dictation
    if(s.macro&&MACROS[s.macro]){
      const m=MACROS[s.macro];
      h+=`<div class="mf"><div style="font-size:14px;font-weight:700;color:#f1f5f9;margin-bottom:12px">${m.name} Quick Entry</div>`;
      m.fields.forEach(f=>{
        h+=`<div class="mf-row"><div class="mf-label">${esc(f.label)}</div>`;
        if(f.type==="pills"){
          const cur=s.macroVals[f.id]||(f.multi?[]:"");
          h+=`<div class="mf-pills">`;
          f.opts.forEach(o=>{
            const on=f.multi?(cur||[]).includes(o):cur===o;
            h+=`<button class="mf-pill${on?" on":""}" onclick="(function(){const v=state.macroVals;${f.multi?`const a=v['${f.id}']||[];const i=a.indexOf('${o}');if(i>=0)a.splice(i,1);else a.push('${o}');v['${f.id}']=[...a];`:`v['${f.id}']='${o}';`}state.macroVals={...v};render();})()">${esc(o)}</button>`;
          });
          h+=`</div>`;
        }else{
          // FIX #11: use data-field id to restore focus after render
          h+=`<input class="mf-inp" data-mf="${f.id}" value="${esc(s.macroVals[f.id]||"")}" placeholder="${esc(f.ph||"")}" oninput="state.macroVals['${f.id}']=this.value">`;
        }
        h+=`</div>`;
      });
      h+=`</div>`;
      h+=`<button class="big" style="background:linear-gradient(135deg,#1d4ed8,#2563eb);margin-top:6px" onclick="processCase()" ${isL?"disabled":""}>\u26A1 Process ${m.name}</button>`;
    }else{
      const dur=rD();
      if(rS==="idle")h+=`<button class="rec-btn idle" onclick="toggleRec()"${!hasWK?' disabled style="opacity:0.3"':''}>\u{1F3A4} ${hasWK?"TAP TO DICTATE":"Add OpenAI key for voice"}</button>`;
      else if(rS==="recording")h+=`<button class="rec-btn recording" onclick="toggleRec()">\u23F9 RECORDING <span class="timer">${dur}</span></button>`;
      else h+=`<button class="rec-btn transcribing" disabled>\u23F3 Transcribing...</button>`;

      h+=`<button class="img-btn" onclick="pickImage()" ${s.phase==="image"?"disabled":""}>\u{1F4F7} ${s.phase==="image"?"Analyzing image...":"Add Image (CT/MRI/X-ray)"}</button>`;
      h+=`<button class="img-btn" onclick="openOD()" style="background:linear-gradient(135deg,#1e3a5f,#1d4ed8);border-color:#3b82f6">\u{1F4C2} Load Op Note from OneDrive</button>`;
      h+=`<button class="img-btn" onclick="pickOpNote()" style="background:#0f172a;border-color:#1e293b;font-size:11px;color:#64748b;padding:8px 16px;min-height:32px">\u{1F4CE} Load from local file</button>`;
      h+=`<textarea class="ta" id="mainInput" rows="8" placeholder="Dictate, type, paste, or load from ${IS_IOS?"Files/OneDrive":"OneDrive"}..." oninput="state.text=this.value;const pb=document.getElementById('pBtn');if(pb){const h=!!this.value.trim();pb.disabled=!h;pb.style.opacity=h?1:0.4;pb.style.background=h?'linear-gradient(135deg,#1d4ed8,#2563eb)':'#1e293b';}">${esc(s.text)}</textarea>`;
      if(s.text.trim()){const wc=s.text.trim().split(/\s+/).length;
        h+=`<div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:11px;color:#475569">${wc}w</span><button style="font-size:11px;color:#475569;background:none;border:none" onclick="state.text='';render()">Clear</button></div>`;}
      if(s.linkedTo){const lc=s.cases.find(c=>c.id===s.linkedTo);if(lc)h+=`<div style="background:#1e3a5f30;border:1px solid #1e3a5f;border-radius:8px;padding:8px 12px;margin-top:8px;font-size:12px;color:#60a5fa">\u{1F517} Linked to: ${esc(lc.proc)} <button style="font-size:11px;color:#475569;background:none;border:none;float:right" onclick="setState({linkedTo:null})">\u2715 Unlink</button></div>`;}
      h+=`<button id="pBtn" class="big" style="background:${!s.text.trim()?"#1e293b":"linear-gradient(135deg,#1d4ed8,#2563eb)"};margin-top:10px;opacity:${!s.text.trim()?0.4:1}" onclick="processCase()" ${!s.text.trim()||isL?"disabled":""}>\u26A1 Process Case</button>`;
    }
    if(s.err)h+=`<div class="err"><div>${esc(s.err)}</div></div>`;
  }

  // ==== OUTPUT ====
  if(s.view==="output"){
    if(isL)h+=`<div class="ld">${ph[s.phase]||"Processing..."}</div>`;
    if(s.tStart){
      h+=`<div class="tt">`;
      if(s.tNote)h+=`Note: <span>${fmtTime(s.tNote-s.tStart)}</span>`;
      if(s.tCopy)h+=` \u00b7 Copy: <span>${fmtTime(s.tCopy-s.tStart)}</span>`;
      else if(s.tNote)h+=` \u00b7 Waiting for copy...`;
      h+=`</div>`;
    }
    if(s.questions.length){
      h+=`<div class="card" style="border-left:4px solid #8b5cf6"><div class="card-h"><span class="title">\u2753 Questions (${s.questions.length})</span></div><div class="card-b">`;
      s.questions.forEach((q,i)=>{const val=s.qEdits[i]!==undefined?s.qEdits[i]:q.def;const ck=s._qc[i]!==false;h+=`<div class="qc" id="qc${i}" style="border-left:3px solid ${ck?"#8b5cf6":"#334155"};opacity:${ck?1:0.5}"><div style="display:flex;align-items:start;gap:8px;margin-bottom:6px"><button style="width:28px;height:28px;border-radius:6px;border:2px solid ${ck?"#8b5cf6":"#475569"};background:${ck?"#7c3aed":"#0f172a"};color:#fff;font-size:14px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center" onclick="var on=state._qc[${i}]===false;state._qc[${i}]=on?undefined:false;var el=document.getElementById('qc${i}');el.style.borderLeftColor=on?'#8b5cf6':'#334155';el.style.opacity=on?1:0.5;this.style.background=on?'#7c3aed':'#0f172a';this.style.borderColor=on?'#8b5cf6':'#475569';this.textContent=on?'\u2713':'';var n=0;state.questions.forEach(function(_,j){if(state._qc[j]!==false)n++});var ab=document.getElementById('qApplyBtn');if(ab)ab.textContent='\u2705 Apply '+n+' Answer'+(n!==1?'s':'')">${ck?"\u2713":""}</button><div class="qt" style="margin:0">${esc(q.q)}</div></div><input class="qi" value="${esc(val)}" oninput="state.qEdits[${i}]=this.value"></div>`;});
      const qN=s.questions.filter((_,i)=>s._qc[i]!==false).length;
      h+=`<button id="qApplyBtn" class="big" style="background:#7c3aed;padding:10px;font-size:13px;margin-top:4px" onclick="useQBatch()" ${isL||!qN?"disabled":""}>\u2705 Apply ${qN} Answer${qN!==1?"s":""}</button>`;
      h+=`</div></div>`;
    }
    if(s.noteText){
      // MDM Complexity banner for clinic/consult notes
      const nt=s.selCase?.cat||noteTypeFromCat(s.nt);
      if(s.billCodes&&(s.nt==="clinic"||s.nt==="consult"||nt==="Clinic")){
        const emMatch=(s.billCodes||"").match(/99(2[01]\d|2[1-5]\d)/);
        if(emMatch){
          const code=parseInt(emMatch[0]);
          let lvl="",lc="",bg="";
          if([99211,99212,99202].includes(code)){lvl="STRAIGHTFORWARD";lc="#64748b";bg="#0f172a";}
          else if([99213,99203].includes(code)){lvl="LOW COMPLEXITY";lc="#60a5fa";bg="#0c1836";}
          else if([99214,99204,99254].includes(code)){lvl="MODERATE COMPLEXITY";lc="#fbbf24";bg="#1a1405";}
          else if([99215,99205,99255].includes(code)){lvl="HIGH COMPLEXITY";lc="#86efac";bg="#051a0e";}
          else if([99252].includes(code)){lvl="STRAIGHTFORWARD";lc="#64748b";bg="#0f172a";}
          else if([99253].includes(code)){lvl="LOW COMPLEXITY";lc="#60a5fa";bg="#0c1836";}
          if(lvl){
            const ptType=s.clinicPt==="established"?"Established":"New";
            const visitType=s.clinicVisit==="postop"?"Post-Op":s.clinicVisit==="followup"?"Follow-Up":"New Visit";
            h+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;margin-bottom:10px;border-radius:10px;background:${bg};border:1px solid ${lc}30">`;
            h+=`<div><div style="font-size:10px;font-weight:700;color:#64748b">MDM LEVEL</div><div style="font-size:16px;font-weight:800;color:${lc}">${lvl}</div></div>`;
            h+=`<div style="text-align:right"><div style="font-size:12px;color:#94a3b8">${ptType} \u00b7 ${visitType}</div><div style="font-size:14px;font-weight:800;color:${lc}">${emMatch[0]}</div></div>`;
            h+=`</div>`;
          }
        }
      }
      h+=`<div style="display:flex;gap:8px;margin-bottom:10px"><button id="copyEmrH" class="big" style="background:linear-gradient(135deg,#1d4ed8,#2563eb);flex:2" onclick="copyHTML(state.editing?state.editText:state.noteText,'copyEmrH')">\u{1F4CB} Copy \u2192 EMR</button><button id="copyEmrP" class="btn" style="background:#334155;padding:14px 12px;border-radius:12px;font-size:12px" onclick="copyPlain(state.editing?state.editText:state.noteText,'copyEmrP')">Plain</button></div>`;
      h+=`<div class="card" style="border-left:4px solid #3b82f6"><div class="card-h"><span class="title">\u{1F4CB} Note</span><div style="display:flex;gap:6px">`;
      if(!s.editing)h+=`<button class="btn" style="background:#334155" onclick="state.editText=state.noteText;state.editing=true;render()">\u270F\uFE0F</button>`;
      else h+=`<button class="btn" style="background:#059669" onclick="state.noteText=state.editText;state.editing=false;render()">\u{1F4BE}</button><button class="btn" style="background:#7f1d1d" onclick="state.editing=false;render()">\u2715</button>`;
      h+=`</div></div>`;
      h+=s.editing?`<div class="card-b"><textarea class="edit-ta" oninput="state.editText=this.value">${esc(s.editText||s.noteText)}</textarea></div></div>`:`<div class="card-b" id="noteBox"></div></div>`;

      if(s.workup.length){h+=`<div class="card" style="border-left:4px solid #06b6d4"><div class="card-h"><span class="title">\u{1F52C} Workup</span></div><div class="card-b">`;s.workup.forEach((w,i)=>{h+=`<div class="wu-row"><input type="checkbox" ${s.wuChecked[i]?"checked":""} onchange="state.wuChecked[${i}]=this.checked;render()"><span>${esc(w)}</span></div>`;});const wuN=Object.values(s.wuChecked).filter(Boolean).length;if(wuN)h+=`<button class="big" style="background:#0891b2;padding:10px;font-size:13px;margin-top:10px" onclick="incWU()" ${isL?"disabled":""}>\u2705 Add ${wuN} to A/P</button>`;h+=`</div></div>`;}

      h+=`<div class="card" style="border-left:4px solid #6366f1"><div class="card-h"><span class="title" style="font-size:13px;color:#c7d2fe">\u270F\uFE0F Add Details</span><button class="btn" style="background:#334155" onclick="pickImage('addend')">\u{1F4F7}</button></div><div class="card-b">`;
      h+=`<textarea class="ta" id="addendInput" rows="2" placeholder="Type details, paste image, or use \u{1F4F7}..." oninput="state.addend=this.value;document.querySelectorAll('.ad-btn').forEach(b=>{const h=!!this.value.trim();b.disabled=!h;b.style.opacity=h?1:0.4;})">${esc(s.addend)}</textarea>`;
      const adDis=!s.addend.trim()||isL;
      h+=`<div style="display:flex;gap:6px;margin-top:8px">`;
      h+=`<button class="btn ad-btn" style="background:${adDis?"#1e293b":"#6366f1"};flex:2;padding:10px;font-size:12px;font-weight:800;opacity:${adDis?0.4:1}" onclick="doAddendTarget('note')" ${adDis?"disabled":""}>\u2705 Add to Note</button>`;
      h+=`</div><div style="display:flex;gap:6px;margin-top:4px">`;
      h+=`<button class="btn ad-btn" style="background:${adDis?"#1e293b":"#7c3aed"};flex:1;padding:8px;font-size:11px;opacity:${adDis?0.4:1}" onclick="doAddendTarget('hpi')" ${adDis?"disabled":""}>\u{1F4DD} HPI</button>`;
      h+=`<button class="btn ad-btn" style="background:${adDis?"#1e293b":"#2563eb"};flex:1;padding:8px;font-size:11px;opacity:${adDis?0.4:1}" onclick="doAddendTarget('ap')" ${adDis?"disabled":""}>\u{1F4CB} A/P</button>`;
      h+=`<button class="btn ad-btn" style="background:${adDis?"#1e293b":"#059669"};flex:1;padding:8px;font-size:11px;opacity:${adDis?0.4:1}" onclick="doAddendTarget('exam')" ${adDis?"disabled":""}>\u{1FA7A} Exam</button>`;
      h+=`</div></div></div>`;
    }

    if(s.billCodes){
      // Extract clean CPT codes only ‚Äî deduplicated
      const cptOnly=[...new Set((s.billCodes||"").split("\n").map(l=>{const m=l.match(/\b(\d{5})\b/);return m?m[1]:null;}).filter(Boolean))];
      const cptStr=cptOnly.join("\n");
      h+=`<div class="card" style="border-left:4px solid #60a5fa"><div class="card-h"><span class="title">\u{1F4CB} CPT Codes</span><button class="btn" style="background:#334155" onclick="navigator.clipboard.writeText('${cptOnly.join("\\n")}');this.innerHTML='\\u2705';setTimeout(()=>this.innerHTML='\\u{1F4CB}',2000)">\u{1F4CB}</button></div><div class="card-b" style="font-family:monospace;font-size:14px;line-height:2;color:#60a5fa;font-weight:800">`;
      cptOnly.forEach(c=>{h+=`<div>${c}</div>`;});
      h+=`</div></div>`;
      h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">\u{1F4B0} Code Detail</span><button class="btn" style="background:#334155" onclick="copyText(state.billCodes,'cpB')">\u{1F4CB}</button></div><div class="card-b" id="codesBox"></div></div>`;
    }
    if(s.billMod){h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">\u{1F4CE} Modifiers</span></div><div class="card-b" id="modBox"></div></div>`;}
    if(s.billICD){h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">\u{1F3E5} ICD-10</span></div><div class="card-b" id="icdBox"></div></div>`;}
    if(s.billBundle){h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">\u{1F4E6} Bundling</span></div><div class="card-b" id="bundleBox"></div></div>`;}
    if(s.billPreauth){h+=`<div class="card" style="border-left:4px solid #a78bfa"><div class="card-h"><span class="title">\u{1F4CB} Pre-Authorization</span></div><div class="card-b" id="preauthBox"></div></div>`;}

    if(s.gaps.length){
      h+=`<div class="card" style="border-left:4px solid #eab308"><div class="card-h"><span class="title">\u26A0\uFE0F Gaps</span><span style="font-size:11px;color:#eab308;font-weight:700">${s.gaps.length}</span></div><div class="card-b" style="padding:8px">`;
      s.gaps.forEach((g,i)=>{const ic=g.impact==="HIGH"?"high":g.impact==="LOW"?"low":"med";const gc=g.impact==="HIGH"?"g-high":g.impact==="LOW"?"g-low":"g-med";const chk=s._gc[i];h+=`<div class="gc ${gc}${chk?" ck":""}"><div class="gh" onclick="state._gc[${i}]=!state._gc[${i}];render()"><input type="checkbox" ${chk?"checked":""} onclick="event.stopPropagation();state._gc[${i}]=!state._gc[${i}];render()"><span class="gi ${ic}">${g.impact}</span><span class="gt">${esc(g.issue).split("\\n")[0]}</span></div><div class="gb">${g.language?`<div class="gl">${esc(g.language)}</div>`:""}<div style="display:flex;gap:6px;margin-top:8px"><button class="gib" onclick="event.stopPropagation();incGap(${i})" ${isL?"disabled":""}>\u26A1 Add to Note</button><button class="gib" style="background:linear-gradient(135deg,#5b21b6,#7c3aed)" onclick="event.stopPropagation();incGapHPI(${i})" ${isL?"disabled":""}>\u{1F4DD} Add to HPI</button></div></div></div>`;});
      const gcN=Object.values(s._gc).filter(Boolean).length;
      if(gcN>1)h+=`<button class="big" style="background:linear-gradient(135deg,#a16207,#ca8a04);padding:12px;font-size:13px;margin-top:8px" onclick="incSelGaps()" ${isL?"disabled":""}>\u2705 Incorporate ${gcN}</button>`;
      h+=`</div></div>`;
    }

    if(s.flags.length){h+=`<div class="card" style="border-left:4px solid #ef4444"><div class="card-h"><span class="title">\u{1F6A9} Flags</span></div><div class="card-b">`;s.flags.forEach((f,i)=>{const cls=f.type==="RED"?"red":f.type==="YELLOW"?"yellow":"green";h+=`<div class="fc ${cls}"><span class="fl">${f.type}</span><span>${esc(f.text)}</span>`;if(f.type!=="GREEN"){if(f.input){h+=`<div style="font-size:11px;color:#94a3b8;margin-top:6px;padding:6px 8px;background:#02061780;border-radius:6px">${esc(f.input)}</div>`;}h+=`<div style="display:flex;gap:6px;margin-top:8px"><button class="btn" style="background:${f.type==="RED"?"#dc2626":"#ca8a04"};flex:1;padding:8px;font-size:12px" onclick="incFlag(${i})" ${isL?"disabled":""}>\u2705 Yes \u2014 Add to Note</button><button class="btn" style="background:#334155;flex:1;padding:8px;font-size:12px" onclick="dismissFlag(${i})">\u274C N/A</button></div>`;}h+=`</div>`;});h+=`</div></div>`;}

    if(s.financial){const f=s.financial;const hasI=s.gaps.length||s.flags.some(x=>x.type!=="GREEN");h+=`<div class="fin"><div style="font-size:13px;font-weight:700;color:#f1f5f9;margin-bottom:8px">\u{1F4B5} Financial</div>`;if(f.rvu)h+=`<div class="fr"><span class="fl2">Total RVU</span><span class="fv">${esc(f.rvu)}</span></div>`;if(f.current)h+=`<div class="fr"><span class="fl2">Current</span><span class="fv">$${esc(f.current)}</span></div>`;if(f.potential)h+=`<div class="fr"><span class="fl2">With Gaps</span><span class="fv g">$${esc(f.potential)}</span></div>`;if(f.capture)h+=`<div class="fr"><span class="fl2">Capture</span><span class="fv ${hasI?"y":"g"}">${hasI&&f.capture==="100%"?"~85-90%":esc(f.capture)}</span></div>`;h+=`</div>`;}

    // Level Up button
    if(s.noteText&&s.billRaw){
      h+=`<button class="big" style="background:linear-gradient(135deg,#059669,#10b981);margin-top:8px" onclick="levelUp()" ${isL?"disabled":""}>‚¨Ü\uFE0F Level Up \u2014 Maximize Billing</button>`;
    }

    // Level Up results
    if(s.levelUpResult){
      const lu=parseLevelUp(s.levelUpResult);
      if(lu){
        h+=`<div class="card" style="border-left:4px solid #10b981;margin-top:8px"><div class="card-h"><span class="title">\u{2B06}\uFE0F Level Up Analysis</span><button class="btn" style="background:#334155" onclick="setState({levelUpResult:null})">\u2715</button></div><div class="card-b">`;
        // Current ‚Üí Max display
        h+=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;padding:12px;background:#020617;border-radius:10px">`;
        h+=`<div style="text-align:center;flex:1"><div style="font-size:10px;font-weight:700;color:#64748b;margin-bottom:4px">CURRENT</div><div style="font-size:14px;font-weight:800;color:#f87171">${esc(lu.currentLevel)}</div><div style="font-size:18px;font-weight:800;color:#f87171">${lu.currentRVU} RVU</div></div>`;
        h+=`<div style="font-size:24px;color:#10b981">\u2192</div>`;
        h+=`<div style="text-align:center;flex:1"><div style="font-size:10px;font-weight:700;color:#64748b;margin-bottom:4px">MAX ACHIEVABLE</div><div style="font-size:14px;font-weight:800;color:#86efac">${esc(lu.maxLevel)}</div><div style="font-size:18px;font-weight:800;color:#86efac">${lu.maxRVU} RVU</div></div>`;
        if(lu.rvuGain&&parseFloat(lu.rvuGain)>0){h+=`<div style="text-align:center;padding:8px 12px;background:#052e16;border-radius:8px"><div style="font-size:10px;font-weight:700;color:#64748b">GAIN</div><div style="font-size:20px;font-weight:800;color:#4ade80">+${lu.rvuGain}</div><div style="font-size:10px;color:#64748b">RVU</div></div>`;}
        h+=`</div>`;
        // Items to add
        if(lu.items.length){
          h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin:8px 0 6px">WHAT TO DOCUMENT</div>`;
          lu.items.forEach((item,i)=>{
            h+=`<div style="display:flex;gap:8px;padding:8px;margin-bottom:4px;background:#0f172a;border-radius:8px;border-left:3px solid #10b981;font-size:12px;color:#cbd5e1"><span style="font-weight:800;color:#10b981;flex-shrink:0">${i+1}.</span><span>${esc(item)}</span></div>`;
          });
        }
        // Additional codes
        if(lu.addCodes.length){
          h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin:12px 0 6px">ADDITIONAL BILLABLE CODES</div>`;
          lu.addCodes.forEach(c=>{h+=`<div style="font-size:12px;color:#60a5fa;padding:4px 0">${esc(c)}</div>`;});
        }
        // Documentation template
        if(lu.template){
          h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin:12px 0 6px">READY-TO-ADD TEXT <span style="color:#475569;font-weight:400">(editable)</span></div>`;
          h+=`<textarea id="luTemplate" style="width:100%;background:#020617;border:1px solid #1e293b;border-radius:8px;padding:10px;font-size:12px;color:#e2e8f0;line-height:1.6;min-height:120px;max-height:300px;resize:vertical;font-family:inherit" oninput="state._luEdit=this.value">${esc(lu.template)}</textarea>`;
          h+=`<div style="display:flex;gap:6px;margin-top:6px">`;
          h+=`<button class="btn" style="background:#059669;flex:1;padding:8px;font-size:12px" onclick="state.addend=document.getElementById('luTemplate').value;setState({addTarget:'note'})">Load into Add Details</button>`;
          h+=`<button class="btn" style="background:#334155;flex:1;padding:8px;font-size:12px" onclick="navigator.clipboard.writeText(document.getElementById('luTemplate').value);this.innerHTML='\\u2705 Copied!';setTimeout(()=>this.innerHTML='\\u{1F4CB} Copy Text',2000)">\u{1F4CB} Copy Text</button>`;
          h+=`</div>`;
        }
        h+=`</div></div>`;
      }
    }
    if(s.noteText&&s.billRaw)h+=`<button id="coderBtn" class="big" style="background:#334155;margin-top:12px" onclick="sendToCoder(state.noteText,state.billRaw)">${s.ce?"\u{1F4E7} Send to Coder":"\u{1F4E7} Copy \u2192 Coder"}</button>`;
    if(s.err)h+=`<div class="err"><div>${esc(s.err)}</div></div>`;
  }
  // ==== CASES ====
  if(s.view==="cases"){
    h+=`<div class="tabs" style="padding:3px">`;
    ["all","Operative","Clinic","Inpatient"].forEach(t=>{const n=t==="all"?s.cases.length:s.cases.filter(c=>c.cat===t).length;h+=`<button class="tab ${s.caseTab===t?"on":""}" style="font-size:11px;padding:6px 0" onclick="setState({caseTab:'${t}'})">${t==="all"?"All":t} (${n})</button>`;});
    h+=`</div>`;
    // Sync bar
    if(odAccount){
      const sc=odSyncStatus==="synced"?"\u{2705} Synced to OneDrive":odSyncStatus==="syncing"?"\u{1F504} Syncing...":odSyncStatus==="error"?"\u{274C} Sync Error":"\u{2601}\uFE0F";
      const scC=odSyncStatus==="synced"?"#86efac":odSyncStatus==="syncing"?"#60a5fa":odSyncStatus==="error"?"#f87171":"#94a3b8";
      h+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#020617;border:1px solid #1e293b;border-radius:8px;margin-bottom:10px">`;
      h+=`<span style="font-size:11px;color:${scC}">${sc}</span>`;
      h+=`<button class="btn" style="background:#334155;padding:4px 10px;font-size:10px;min-height:28px" onclick="odLoadData()">Refresh</button>`;
      h+=`</div>`;
    }
    if(s.cases.length){
      h+=`<div style="display:flex;gap:8px;margin-bottom:12px">`;
      h+=`<button class="btn" style="background:linear-gradient(135deg,#1e3a5f,#1d4ed8);flex:1;padding:10px;font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px" onclick="exportCases()">\u{1F4E5} Export JSON</button>`;
      h+=`<button class="btn" style="background:#334155;flex:1;padding:10px;font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px" onclick="pickImport()">\u{1F4C2} Import JSON</button>`;
      h+=`</div>`;
    }
    const grp={};s.cases.forEach(c=>{const d=c.date||"?";if(!grp[d])grp[d]=[];grp[d].push(c);});
    let any=false;
    Object.entries(grp).forEach(([date,cs])=>{
      const fc=s.caseTab==="all"?cs:cs.filter(c=>c.cat===s.caseTab);if(!fc.length)return;any=true;
      h+=`<div style="margin-bottom:14px"><div style="font-size:12px;font-weight:700;color:#475569;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1e293b">${esc(date)} \u00b7 ${fc.length} case${fc.length>1?"s":""}</div>`;
      fc.forEach(c=>{
        const nNotes=c.notes?c.notes.length:1;
        h+=`<div class="case-btn" style="position:relative"><div style="display:flex;justify-content:space-between;align-items:start">`;
        h+=`<div style="flex:1;cursor:pointer" onclick='setState({selCase:state.cases.find(x=>x.id==="${c.id}"),view:"detail",detailNoteIdx:0})'>`;
        h+=`<div style="font-size:13px;font-weight:600;color:#e2e8f0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px">${esc(c.proc||"Case")}</div>`;
        h+=`<div style="display:flex;gap:4px;margin-top:6px;flex-wrap:wrap"><span class="tag" style="background:#1e293b;color:#94a3b8">${c.cat}</span>${nNotes>1?`<span class="tag" style="background:#1e3a5f;color:#60a5fa">${nNotes} notes</span>`:""}${(c.cpts||[]).slice(0,3).map(x=>`<span class="tag" style="background:#172554;color:#60a5fa">${x}</span>`).join("")}</div></div>`;
        h+=`<div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px"><span style="font-size:11px;color:#475569">${esc(c.ts)}</span>`;
        h+=`<div style="display:flex;gap:4px"><button class="btn" style="background:#1e293b;font-size:10px;padding:3px 8px" onclick="event.stopPropagation();setState({renaming:'${c.id}'})">\u270F\uFE0F</button><button class="btn" style="background:#450a0a;font-size:10px;padding:3px 8px" onclick="event.stopPropagation();if(confirm('Delete?'))deleteCase('${c.id}')">\u{1F5D1}\uFE0F</button></div></div></div>`;
        if(s.renaming===c.id){h+=`<div style="margin-top:8px;display:flex;gap:6px"><input class="rename-inp" id="rn_${c.id}" value="${esc(c.proc)}"><button class="btn" style="background:#059669" onclick="renameCase('${c.id}',document.getElementById('rn_${c.id}').value);setState({renaming:null})">\u2713</button><button class="btn" style="background:#334155" onclick="setState({renaming:null})">\u2715</button></div>`;}
        h+=`</div>`;
      });
      h+=`</div>`;
    });
    if(!any){
      h+=`<div style="text-align:center;padding:40px 0"><div style="color:#475569;font-size:13px;margin-bottom:12px">No cases yet.</div>`;
      if(OD_CLIENT_ID&&!odAccount)h+=`<button class="btn" style="background:#1d4ed8;padding:10px 20px;font-size:12px;margin-bottom:8px" onclick="odLogin().then(()=>render())">\u{2601}\uFE0F Sign in to OneDrive to sync</button><br>`;
      h+=`<button class="btn" style="background:#334155;padding:10px 20px;font-size:12px" onclick="pickImport()">\u{1F4C2} Import from JSON</button></div>`;
    }
  }

  // ==== DETAIL ====
  if(s.view==="detail"&&s.selCase){
    const c=s.selCase;
    // FIX #4: use noteTypeFromCat for legacy cases without notes array
    const notes=c.notes||[{type:noteTypeFromCat(c.cat),ts:c.ts,note:c.note||"",billRaw:c.billRaw||"",dict:c.dict||""}];
    const ni=Math.min(s.detailNoteIdx||0,notes.length-1);const cn=notes[ni];
    h+=`<button style="font-size:12px;color:#60a5fa;background:none;border:none;margin-bottom:10px" onclick="setState({selCase:null,view:'cases'})">\u2190 Back</button>`;
    h+=`<div style="background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:12px;margin-bottom:10px">`;
    if(s.renaming===c.id){h+=`<div style="display:flex;gap:6px;margin-bottom:8px"><input class="rename-inp" id="rn_det" value="${esc(c.proc)}"><button class="btn" style="background:#059669" onclick="renameCase('${c.id}',document.getElementById('rn_det').value);setState({renaming:null})">\u2713</button><button class="btn" style="background:#334155" onclick="setState({renaming:null})">\u2715</button></div>`;}
    else{h+=`<div style="display:flex;justify-content:space-between;align-items:start"><div style="font-size:15px;font-weight:700;color:#e2e8f0">${esc(c.proc)}</div><button class="btn" style="background:#1e293b;font-size:10px" onclick="setState({renaming:'${c.id}'})">\u270F\uFE0F</button></div>`;}
    h+=`<div style="font-size:11px;color:#475569;margin-top:4px">${esc(c.ts)} \u00b7 ${c.cat}</div></div>`;

    // FIX #5: removed ||true ‚Äî show tabs always (for + Add Note) but cleanly
    h+=`<div class="ln-tabs">`;
    notes.forEach((n,i)=>{
      const label=TYPES[n.type]?(TYPES[n.type].e+" "+(n.type==="operative"?"Op Note":TYPES[n.type].l)):"\u{1F4CB} Note";
      h+=`<button class="ln-tab${ni===i?" on":""}" onclick="setState({detailNoteIdx:${i}})">${label}${i>0?" #"+(i+1):""}</button>`;
    });
    h+=`<button class="ln-tab" style="background:#1e3a5f;color:#60a5fa;border-color:#2563eb" onclick="setState({view:'input',nt:'progress',text:'Linked to: ${escJs(c.proc)}\\nPOD: \\nOvernight events: \\nDrain output: ',macro:null,macroVals:{},linkedTo:'${c.id}'})">+ Add Note</button>`;
    h+=`</div>`;

    if(cn){
      h+=`<div style="display:flex;gap:8px;margin-bottom:10px"><button id="cpDetH" class="big" style="background:linear-gradient(135deg,#1d4ed8,#2563eb);flex:2" onclick="copyDetHTML()">\u{1F4CB} Copy Note</button><button id="cpDetP" class="btn" style="background:#334155;padding:14px 12px;border-radius:12px;font-size:12px" onclick="copyDetPlain()">Plain</button></div>`;
      if(cn.dict)h+=`<details style="margin-bottom:8px"><summary style="font-size:11px;color:#64748b;cursor:pointer">Dictation</summary><div style="font-size:11px;color:#64748b;background:#020617;padding:8px;border-radius:6px;margin-top:4px;white-space:pre-wrap;max-height:100px;overflow-y:auto">${esc(cn.dict)}</div></details>`;
      if(cn.note)h+=`<div class="card" style="border-left:4px solid #3b82f6"><div class="card-h"><span class="title">\u{1F4CB} Note</span></div><div class="card-b" id="dNote"></div></div>`;
      const dSec=cn.billRaw?parseBillFull(cn.billRaw):{};
      if(dSec.codes){
        const cptD=[...new Set(dSec.codes.split("\n").map(l=>{const m=l.match(/\b(\d{5})\b/);return m?m[1]:null;}).filter(Boolean))];
        h+=`<div class="card" style="border-left:4px solid #60a5fa"><div class="card-h"><span class="title">\u{1F4CB} CPT Codes</span><button class="btn" style="background:#334155" onclick="navigator.clipboard.writeText('${cptD.join("\\n")}');this.innerHTML='\\u2705';setTimeout(()=>this.innerHTML='\\u{1F4CB}',2000)">\u{1F4CB}</button></div><div class="card-b" style="font-family:monospace;font-size:14px;line-height:2;color:#60a5fa;font-weight:800">`;
        cptD.forEach(c=>{h+=`<div>${c}</div>`;});
        h+=`</div></div>`;
        h+=`<div class="card" style="border-left:4px solid #10b981"><div class="card-h"><span class="title">\u{1F4B0} Code Detail</span></div><div class="card-b" id="dCodes"></div></div>`;
      }
      if(dSec.flags){const dF=parseFlags(dSec.flags);if(dF.length){h+=`<div class="card" style="border-left:4px solid #ef4444"><div class="card-h"><span class="title">\u{1F6A9} Flags</span></div><div class="card-b">`;dF.forEach(f=>{const cls=f.type==="RED"?"red":f.type==="YELLOW"?"yellow":"green";h+=`<div class="fc ${cls}"><span class="fl">${f.type}</span>${esc(f.text)}</div>`;});h+=`</div></div>`;}}
      if(dSec.preauth)h+=`<div class="card" style="border-left:4px solid #a78bfa"><div class="card-h"><span class="title">\u{1F4CB} Pre-Auth</span></div><div class="card-b" id="dPreauth"></div></div>`;
      const dFin=cn.billRaw?parseFinancial(parseBillFull(cn.billRaw).financial):null;
      if(dFin){h+=`<div class="fin"><div style="font-size:13px;font-weight:700;color:#f1f5f9;margin-bottom:8px">\u{1F4B5} Financial</div>`;if(dFin.rvu)h+=`<div class="fr"><span class="fl2">RVU</span><span class="fv">${esc(dFin.rvu)}</span></div>`;if(dFin.current)h+=`<div class="fr"><span class="fl2">Estimate</span><span class="fv">$${esc(dFin.current)}</span></div>`;if(dFin.potential)h+=`<div class="fr"><span class="fl2">With Gaps</span><span class="fv g">$${esc(dFin.potential)}</span></div>`;h+=`</div>`;}
      if(cn.tStart&&cn.tNote)h+=`<div class="tt" style="margin-top:8px">Generated in <span>${fmtTime(cn.tNote-cn.tStart)}</span>${cn.tDone?" \u00b7 Total <span>"+fmtTime(cn.tDone-cn.tStart)+"</span>":""}</div>`;
    }
    h+=`<button id="cpCod2" class="big" style="background:#334155;margin-top:12px" onclick="sendToCoder(getDetailNote().note||'',getDetailNote().billRaw||'')">${s.ce?"\u{1F4E7} Send to Coder":"\u{1F4E7} Copy \u2192 Coder"}</button>`;
    h+=`<button class="big" style="background:#1e3a5f;margin-top:8px" onclick="reBill()">\u{1F504} Re-Analyze Billing</button>`;
    h+=`<button class="big" style="background:linear-gradient(135deg,#059669,#10b981);margin-top:6px" onclick="levelUp(getDetailNote()?.note,getDetailNote()?.billRaw)">\u2B06\uFE0F Level Up \u2014 Maximize Billing</button>`;
    // Level Up results in detail view
    if(s.levelUpResult){
      const lu=parseLevelUp(s.levelUpResult);
      if(lu){
        h+=`<div class="card" style="border-left:4px solid #10b981;margin-top:8px"><div class="card-h"><span class="title">\u{2B06}\uFE0F Level Up Analysis</span><button class="btn" style="background:#334155" onclick="setState({levelUpResult:null})">\u2715</button></div><div class="card-b">`;
        h+=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;padding:12px;background:#020617;border-radius:10px">`;
        h+=`<div style="text-align:center;flex:1"><div style="font-size:10px;font-weight:700;color:#64748b;margin-bottom:4px">CURRENT</div><div style="font-size:14px;font-weight:800;color:#f87171">${esc(lu.currentLevel)}</div><div style="font-size:18px;font-weight:800;color:#f87171">${lu.currentRVU} RVU</div></div>`;
        h+=`<div style="font-size:24px;color:#10b981">\u2192</div>`;
        h+=`<div style="text-align:center;flex:1"><div style="font-size:10px;font-weight:700;color:#64748b;margin-bottom:4px">MAX ACHIEVABLE</div><div style="font-size:14px;font-weight:800;color:#86efac">${esc(lu.maxLevel)}</div><div style="font-size:18px;font-weight:800;color:#86efac">${lu.maxRVU} RVU</div></div>`;
        if(lu.rvuGain&&parseFloat(lu.rvuGain)>0){h+=`<div style="text-align:center;padding:8px 12px;background:#052e16;border-radius:8px"><div style="font-size:10px;font-weight:700;color:#64748b">GAIN</div><div style="font-size:20px;font-weight:800;color:#4ade80">+${lu.rvuGain}</div><div style="font-size:10px;color:#64748b">RVU</div></div>`;}
        h+=`</div>`;
        if(lu.items.length){h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin:8px 0 6px">WHAT TO DOCUMENT</div>`;lu.items.forEach((item,i)=>{h+=`<div style="display:flex;gap:8px;padding:8px;margin-bottom:4px;background:#0f172a;border-radius:8px;border-left:3px solid #10b981;font-size:12px;color:#cbd5e1"><span style="font-weight:800;color:#10b981;flex-shrink:0">${i+1}.</span><span>${esc(item)}</span></div>`;});}
        if(lu.addCodes.length){h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin:12px 0 6px">ADDITIONAL BILLABLE CODES</div>`;lu.addCodes.forEach(c=>{h+=`<div style="font-size:12px;color:#60a5fa;padding:4px 0">${esc(c)}</div>`;});}
        if(lu.template){h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin:12px 0 6px">READY-TO-ADD TEXT <span style="color:#475569;font-weight:400">(editable)</span></div><textarea id="luTemplateDet" style="width:100%;background:#020617;border:1px solid #1e293b;border-radius:8px;padding:10px;font-size:12px;color:#e2e8f0;line-height:1.6;min-height:120px;max-height:300px;resize:vertical;font-family:inherit" oninput="state._luEdit=this.value">${esc(lu.template)}</textarea><button class="btn" style="background:#334155;width:100%;padding:8px;font-size:12px;margin-top:6px" onclick="navigator.clipboard.writeText(document.getElementById('luTemplateDet').value);this.innerHTML='\\u2705 Copied!';setTimeout(()=>this.innerHTML='\\u{1F4CB} Copy Text',2000)">\u{1F4CB} Copy Text</button>`;}
        h+=`</div></div>`;
      }
    }
    h+=`<button style="width:100%;margin-top:10px;padding:10px;font-size:12px;color:#ef4444;background:none;border:none" onclick="if(confirm('Delete case?'))deleteCase('${c.id}')">Delete Case</button>`;
  }

  // ==== STATS ====
  if(s.view==="stats"){
    const cases=s.cases||[];
    // Group by month
    const months={};let totalRVU=0;let totalCases=cases.length;
    const catCounts={};
    cases.forEach(c=>{
      const d=c.date||c.ts||"";
      const mKey=d.replace(/\s+\d{1,2}(,.*)?$/,"").trim()||"Unknown";
      if(!months[mKey])months[mKey]={count:0,rvu:0,cats:{}};
      months[mKey].count++;
      const cat=c.cat||"Other";
      months[mKey].cats[cat]=(months[mKey].cats[cat]||0)+1;
      catCounts[cat]=(catCounts[cat]||0)+1;
      // Extract RVU from billRaw
      const notes=c.notes||[{billRaw:c.billRaw||""}];
      notes.forEach(n=>{
        const rm=(n.billRaw||"").match(/TOTAL RVU:\s*([\d.]+)/i);
        if(rm){const r=parseFloat(rm[1]);months[mKey].rvu+=r;totalRVU+=r;}
      });
    });
    h+=`<div class="card"><div class="card-h"><span class="title">\u{1F4CA} Summary</span></div><div class="card-b">`;
    h+=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">`;
    h+=`<div style="text-align:center;padding:10px;background:#020617;border-radius:8px"><div style="font-size:22px;font-weight:800;color:#fff">${totalCases}</div><div style="font-size:11px;color:#64748b">Total Cases</div></div>`;
    h+=`<div style="text-align:center;padding:10px;background:#020617;border-radius:8px"><div style="font-size:22px;font-weight:800;color:#86efac">${totalRVU.toFixed(1)}</div><div style="font-size:11px;color:#64748b">Total RVU</div></div>`;
    h+=`<div style="text-align:center;padding:10px;background:#020617;border-radius:8px"><div style="font-size:22px;font-weight:800;color:#60a5fa">${totalCases?((totalRVU/totalCases).toFixed(1)):"0"}</div><div style="font-size:11px;color:#64748b">Avg RVU</div></div>`;
    h+=`</div>`;
    // By category
    h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin:10px 0 6px">BY TYPE</div>`;
    Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).forEach(([cat,n])=>{
      const pct=totalCases?Math.round(n/totalCases*100):0;
      h+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1e293b20"><span style="font-size:13px;color:#cbd5e1">${cat}</span><span style="font-size:13px;font-weight:700;color:#f1f5f9">${n} <span style="color:#475569;font-weight:400">(${pct}%)</span></span></div>`;
    });
    // By month
    h+=`<div style="font-size:12px;font-weight:700;color:#94a3b8;margin:14px 0 6px">BY MONTH</div>`;
    Object.entries(months).forEach(([m,d])=>{
      h+=`<div style="padding:8px;background:#020617;border-radius:8px;margin-bottom:6px">`;
      h+=`<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:13px;font-weight:700;color:#f1f5f9">${m}</span><span style="font-size:12px;color:#86efac;font-weight:700">${d.rvu.toFixed(1)} RVU</span></div>`;
      h+=`<div style="font-size:11px;color:#64748b">${d.count} cases ‚Äî ${Object.entries(d.cats).map(([k,v])=>v+" "+k).join(", ")}</div>`;
      h+=`</div>`;
    });
    h+=`</div></div>`;
    // Procedure log
    h+=`<div class="card"><div class="card-h"><span class="title">\u{1F4D1} Procedure Log</span><button class="btn" style="background:#334155" onclick="copyProcLog()">Copy</button></div><div class="card-b"><div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>Procedure</th><th>Type</th><th>RVU</th></tr></thead><tbody>`;
    cases.slice(0,100).forEach(c=>{
      const notes=c.notes||[{billRaw:c.billRaw||""}];
      let rvu="-";notes.forEach(n=>{const rm=(n.billRaw||"").match(/TOTAL RVU:\s*([\d.]+)/i);if(rm)rvu=rm[1];});
      h+=`<tr><td>${esc(c.date||c.ts||"")}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.proc||"")}</td><td>${esc(c.cat||"")}</td><td style="font-weight:700;color:#86efac">${rvu}</td></tr>`;
    });
    h+=`</tbody></table></div></div></div>`;
  }

  h+=`<div style="margin-top:24px;text-align:center;font-size:11px;color:#1e293b">v9.0 \u00b7 De-identified only</div>`;
  app.innerHTML=h;

  // POST RENDER
  if(s.view==="output"){[["noteBox",s.editing?null:s.noteText],["codesBox",s.billCodes],["modBox",s.billMod],["icdBox",s.billICD],["bundleBox",s.billBundle],["preauthBox",s.billPreauth]].forEach(([id,txt])=>{if(txt){const el=document.getElementById(id);if(el)renderNote(el,txt);}});}
  if(s.view==="detail"&&s.selCase){
    const cn=getDetailNote();
    if(cn){
      if(cn.note){const el=document.getElementById("dNote");if(el)renderNote(el,cn.note);}
      const dS=cn.billRaw?parseBillFull(cn.billRaw):{};
      if(dS.codes){const el=document.getElementById("dCodes");if(el)renderNote(el,dS.codes);}
      if(dS.preauth){const el=document.getElementById("dPreauth");if(el)renderNote(el,dS.preauth);}
    }
  }
  if(s.view==="input"&&!s.macro){const ta=document.getElementById("mainInput");if(ta&&ta.value!==s.text)ta.value=s.text;}
}
initMSAL();
// Auto-load cloud data if already signed into OneDrive
if(odAccount)odLoadData();
render();
// iOS "Add to Home Screen" prompt (show once, dismiss forever)
if(IS_IOS&&!window.navigator.standalone&&!localStorage.getItem("opnote-pwa-dismiss")){
  setTimeout(()=>{
    const b=document.createElement("div");
    b.id="pwa-banner";
    b.style.cssText="position:fixed;bottom:0;left:0;right:0;background:#1e293b;border-top:1px solid #334155;padding:14px 16px;display:flex;align-items:center;gap:12px;z-index:9999;font-family:-apple-system,sans-serif";
    b.innerHTML=`<div style="font-size:24px">üì±</div><div style="flex:1"><div style="font-size:13px;font-weight:700;color:#e2e8f0">Add to Home Screen</div><div style="font-size:11px;color:#94a3b8;margin-top:2px">Tap <span style="font-size:14px">‚éô</span> Share ‚Üí Add to Home Screen for app experience</div></div><button onclick="localStorage.setItem('opnote-pwa-dismiss','1');this.parentElement.remove()" style="background:none;border:none;color:#475569;font-size:18px;padding:8px">‚úï</button>`;
    document.body.appendChild(b);
  },2000);
}
</script>
</body>
</html>
